{% extends "base.html" %}

{% block title %}Dashboard - HuduGlue{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2><i class="fas fa-tachometer-alt"></i> Dashboard{% if current_organization %}: {{ current_organization.name }}{% endif %}</h2>
</div>

<!-- 2FA Warning -->
{% if not has_2fa %}
<div class="alert alert-warning alert-dismissible fade show mb-3" role="alert">
    <i class="fas fa-shield-alt"></i> <strong>Security Warning:</strong> Two-factor authentication (2FA) is not enabled on your account.
    For enhanced security, please <a href="{% url 'two_factor:setup' %}" class="alert-link">enable 2FA now</a>.
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endif %}

<!-- Stats Cards -->
<div class="row g-2 mb-3">
    <div class="col-md-3">
        <a href="{% url 'vault:password_list' %}" class="text-decoration-none" data-bs-toggle="tooltip" data-bs-placement="top" title="View all passwords in the vault">
            <div class="card bg-primary text-white h-100" style="cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                <div class="card-body py-2 px-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-0">{{ stats.passwords }}</h4>
                            <small>Passwords</small>
                        </div>
                        <i class="fas fa-key fa-lg opacity-50"></i>
                    </div>
                </div>
            </div>
        </a>
    </div>
    <div class="col-md-3">
        <a href="{% url 'assets:asset_list' %}" class="text-decoration-none" data-bs-toggle="tooltip" data-bs-placement="top" title="View and manage all assets">
            <div class="card bg-success text-white h-100" style="cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                <div class="card-body py-2 px-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-0">{{ stats.assets }}</h4>
                            <small>Assets</small>
                        </div>
                        <i class="fas fa-box fa-lg opacity-50"></i>
                    </div>
                </div>
            </div>
        </a>
    </div>
    <div class="col-md-3">
        <a href="{% url 'docs:document_list' %}" class="text-decoration-none" data-bs-toggle="tooltip" data-bs-placement="top" title="View documentation and knowledge base">
            <div class="card bg-info text-white h-100" style="cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                <div class="card-body py-2 px-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-0">{{ stats.documents }}</h4>
                            <small>Documents</small>
                        </div>
                        <i class="fas fa-file-alt fa-lg opacity-50"></i>
                    </div>
                </div>
            </div>
        </a>
    </div>
    <div class="col-md-3">
        <a href="{% url 'monitoring:website_monitor_list' %}" class="text-decoration-none" data-bs-toggle="tooltip" data-bs-placement="top" title="View website and service monitors">
            <div class="card bg-warning text-dark h-100" style="cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                <div class="card-body py-2 px-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-0">{{ stats.monitors }}</h4>
                            <small>Monitors</small>
                        </div>
                        <i class="fas fa-globe fa-lg opacity-50"></i>
                    </div>
                </div>
            </div>
        </a>
    </div>
</div>

<!-- Location Map -->
<div class="card mb-3">
    <div class="card-header py-1 d-flex justify-content-between align-items-center">
        <h6 class="mb-0 small"><i class="fas fa-map-marked-alt"></i> Location Map</h6>
        <div>
            <button id="toggle-devices" class="btn btn-sm btn-outline-primary me-2" data-bs-toggle="tooltip" data-bs-placement="top" title="Show or hide RMM devices with location data on the map">
                <i class="fas fa-laptop"></i> <span id="device-toggle-text">Show Devices</span>
            </button>
            <a href="{% url 'locations:location_list' %}" class="btn btn-sm btn-link py-0" data-bs-toggle="tooltip" data-bs-placement="top" title="View and manage all physical locations">View All</a>
        </div>
    </div>
    <div class="card-body p-0" style="position: relative;">
        <div id="location-map" style="height: 350px; width: 100%;"></div>
        <div id="map-message" class="text-center py-5 text-muted" style="display: none;">
            <i class="fas fa-map-marker-alt fa-2x mb-2"></i><br>
            <span id="map-message-text">Loading map...</span>
        </div>
        <!-- Map Controls -->
        <div id="map-controls" style="position: absolute; top: 10px; right: 10px; z-index: 9999; display: none; pointer-events: auto;">
            <button class="btn btn-sm btn-light shadow-sm" id="map-settings-btn" title="Map Settings" style="pointer-events: auto; cursor: pointer;">
                <i class="fas fa-cog"></i>
            </button>
            <div id="map-settings-panel" class="card shadow-sm" style="display: none; position: absolute; top: 35px; right: 0; min-width: 250px; z-index: 10000; pointer-events: auto;">
                <div class="card-body p-3">
                    <h6 class="mb-3"><i class="fas fa-map"></i> Map Settings</h6>
                    <div class="mb-3">
                        <label for="map-zoom-slider" class="form-label small mb-1">Zoom Level: <span id="zoom-level-display">{{ map_default_zoom }}</span></label>
                        <input type="range" class="form-range" id="map-zoom-slider" min="1" max="18" value="{{ map_default_zoom }}">
                        <small class="text-muted">1=World, 18=Street</small>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="map-dragging-toggle" {% if map_dragging_enabled %}checked{% endif %}>
                        <label class="form-check-label small" for="map-dragging-toggle">
                            Enable Dragging
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-2">
    <!-- Recent Items -->
    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-header py-1 d-flex justify-content-between align-items-center">
                <h6 class="mb-0 small"><i class="fas fa-history"></i> My Recent</h6>
                <a href="{% url 'audit:audit_log_list' %}" class="btn btn-sm btn-link py-0">View All</a>
            </div>
            <div class="list-group list-group-flush" style="max-height: 280px; overflow-y: auto;">
                {% for log in recent_logs %}
                {% with object_url=log.get_object_url %}
                {% if object_url %}
                <a href="{{ object_url }}" class="list-group-item list-group-item-action py-2">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-fill">
                            <small><strong>{{ log.object_repr|truncatewords:5 }}</strong></small><br>
                            <small class="text-muted">{{ log.object_type|title }} • {{ log.timestamp|timesince }} ago</small>
                        </div>
                        <i class="fas fa-arrow-right text-muted"></i>
                    </div>
                </a>
                {% else %}
                <div class="list-group-item py-2">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-fill">
                            <small><strong>{{ log.object_repr|truncatewords:5 }}</strong></small><br>
                            <small class="text-muted">{{ log.object_type|title }} • {{ log.timestamp|timesince }} ago</small>
                        </div>
                        <i class="fas fa-eye text-muted"></i>
                    </div>
                </div>
                {% endif %}
                {% endwith %}
                {% empty %}
                <div class="list-group-item text-center py-3 text-muted">
                    <i class="fas fa-inbox"></i> No recent activity
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Expiring Soon -->
    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-header py-1">
                <h6 class="mb-0 small"><i class="fas fa-clock"></i> Expiring Soon (30 days)</h6>
            </div>
            <div class="list-group list-group-flush" style="max-height: 280px; overflow-y: auto;">
                {% for pw in expiring_passwords %}
                <div class="list-group-item py-2">
                    <div class="d-flex justify-content-between">
                        <div>
                            <i class="fas fa-key text-primary"></i>
                            <a href="{% url 'vault:password_detail' pw.pk %}">{{ pw.title|truncatewords:4 }}</a>
                        </div>
                        <small class="text-danger">{{ pw.days_until_expiration }}d</small>
                    </div>
                </div>
                {% endfor %}

                {% for item in expiring_items %}
                <div class="list-group-item py-2">
                    <div class="d-flex justify-content-between">
                        <div>
                            <i class="fas fa-calendar-times text-warning"></i>
                            {{ item.name|truncatewords:4 }}
                        </div>
                        <small class="text-danger">{{ item.expires_at|date:"M d" }}</small>
                    </div>
                </div>
                {% endfor %}

                {% for ssl in expiring_ssl %}
                <div class="list-group-item py-2">
                    <div class="d-flex justify-content-between">
                        <div>
                            <i class="fas fa-lock text-success"></i>
                            <a href="{% url 'monitoring:website_monitor_detail' ssl.pk %}">{{ ssl.name|truncatewords:3 }} SSL</a>
                        </div>
                        <small class="text-danger">{{ ssl.ssl_expires_at|date:"M d" }}</small>
                    </div>
                </div>
                {% endfor %}

                {% if not expiring_passwords and not expiring_items and not expiring_ssl %}
                <div class="list-group-item text-center py-3 text-muted">
                    <i class="fas fa-check-circle"></i> Nothing expiring soon
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Activity Feed & Monitors -->
    <div class="col-md-4">
        <!-- Monitor Status -->
        <div class="card mb-2">
            <div class="card-header py-1">
                <h6 class="mb-0 small"><i class="fas fa-globe"></i> Monitors</h6>
            </div>
            <div class="card-body py-2 px-3">
                <div class="d-flex justify-content-between mb-2">
                    <span><i class="fas fa-check-circle text-success"></i> Active</span>
                    <strong>{{ monitors_active }}</strong>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span><i class="fas fa-exclamation-triangle text-warning"></i> Warning</span>
                    <strong>{{ monitors_warning }}</strong>
                </div>
                <div class="d-flex justify-content-between">
                    <span><i class="fas fa-times-circle text-danger"></i> Down</span>
                    <strong>{{ monitors_down }}</strong>
                </div>
                {% if monitors_down > 0 %}
                <a href="{% url 'monitoring:website_monitor_list' %}?status=down" class="btn btn-sm btn-danger w-100 mt-2">
                    View Down Monitors
                </a>
                {% endif %}
            </div>
        </div>

        <!-- Activity Feed -->
        <div class="card">
            <div class="card-header py-1">
                <h6 class="mb-0 small"><i class="fas fa-stream"></i> Recent Activity</h6>
            </div>
            <div class="list-group list-group-flush" style="max-height: 180px; overflow-y: auto;">
                {% for log in activity_feed %}
                <div class="list-group-item py-2">
                    <small>
                        <strong>{{ log.username }}</strong> {{ log.action }}
                        {% if log.object_repr %}<span class="text-primary">{{ log.object_repr|truncatewords:3 }}</span>{% endif %}
                    </small><br>
                    <small class="text-muted">{{ log.timestamp|timesince }} ago</small>
                </div>
                {% empty %}
                <div class="list-group-item text-center py-3 text-muted">
                    <i class="fas fa-inbox"></i> No activity
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="card mt-4">
    <div class="card-header py-2">
        <h6 class="mb-0"><i class="fas fa-bolt"></i> Quick Actions</h6>
    </div>
    <div class="card-body">
        <div class="row g-2">
            <div class="col-md-2">
                <a href="{% url 'vault:password_create' %}" class="btn btn-outline-primary w-100 btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" title="Create a new encrypted password">
                    <i class="fas fa-key"></i> New Password
                </a>
            </div>
            <div class="col-md-2">
                <a href="{% url 'assets:asset_create' %}" class="btn btn-outline-success w-100 btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" title="Add a new asset to inventory">
                    <i class="fas fa-box"></i> New Asset
                </a>
            </div>
            <div class="col-md-2">
                <a href="{% url 'docs:document_create' %}" class="btn btn-outline-info w-100 btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" title="Create a new documentation article">
                    <i class="fas fa-file-alt"></i> New Document
                </a>
            </div>
            <div class="col-md-2">
                <a href="{% url 'core:secure_note_create' %}" class="btn btn-outline-warning w-100 btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" title="Send an encrypted ephemeral message">
                    <i class="fas fa-lock"></i> Send Secure Note
                </a>
            </div>
            <div class="col-md-2">
                <a href="{% url 'assets:contact_create' %}" class="btn btn-outline-secondary w-100 btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" title="Add a new contact person">
                    <i class="fas fa-user"></i> New Contact
                </a>
            </div>
            <div class="col-md-2">
                <a href="{% url 'core:search' %}" class="btn btn-outline-dark w-100 btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" title="Search all data">
                    <i class="fas fa-search"></i> Search
                </a>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
// Initialize location map with device layer support
document.addEventListener('DOMContentLoaded', function() {
    const mapDiv = document.getElementById('location-map');
    const messageDiv = document.getElementById('map-message');
    const messageText = document.getElementById('map-message-text');
    const toggleButton = document.getElementById('toggle-devices');
    const toggleText = document.getElementById('device-toggle-text');

    let map = null;
    let deviceLayer = null;
    let showDevices = false;
    const locationMarkers = [];
    const deviceMarkers = [];

    // Define marker colors based on status
    function getLocationMarkerColor(status, is_primary) {
        if (is_primary) return '#ffc107'; // Yellow/gold for HQ
        switch(status) {
            case 'active': return '#28a745'; // Green
            case 'inactive': return '#6c757d'; // Gray
            case 'planned': return '#17a2b8'; // Blue
            case 'closed': return '#dc3545'; // Red
            default: return '#007bff'; // Default blue
        }
    }

    // Create custom marker icon for locations
    function createLocationIcon(color) {
        return L.divIcon({
            className: 'custom-map-marker',
            html: `<div style="background-color: ${color}; width: 25px; height: 25px; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"><div style="transform: rotate(45deg); margin-top: 4px; margin-left: 7px;"><i class="fas fa-building" style="font-size: 10px; color: #fff;"></i></div></div>`,
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34]
        });
    }

    // Create custom marker icon for devices
    function createDeviceIcon(isOnline) {
        const color = isOnline ? '#28a745' : '#dc3545'; // Green for online, red for offline
        return L.divIcon({
            className: 'custom-map-marker-device',
            html: `<div style="background-color: ${color}; width: 20px; height: 20px; border-radius: 50%; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center;"><i class="fas fa-laptop" style="font-size: 8px; color: #fff;"></i></div>`,
            iconSize: [20, 20],
            iconAnchor: [10, 10],
            popupAnchor: [0, -10]
        });
    }

    // Load and display device layer
    function loadDeviceLayer() {
        if (deviceLayer) {
            // Remove existing device layer
            deviceMarkers.forEach(marker => map.removeLayer(marker));
            deviceMarkers.length = 0;
            deviceLayer = null;
        }

        if (!showDevices) return;

        // Fetch device data
        fetch('{% url "integrations:rmm_device_map_data" %}')
            .then(response => response.json())
            .then(data => {
                if (data.features && data.features.length > 0) {
                    data.features.forEach(feature => {
                        const coord = feature.geometry.coordinates;
                        const props = feature.properties;

                        const marker = L.marker([coord[1], coord[0]], {
                            icon: createDeviceIcon(props.is_online)
                        }).addTo(map);

                        // Create popup content for device
                        const statusBadge = props.is_online ?
                            '<span class="badge bg-success">Online</span>' :
                            '<span class="badge bg-danger">Offline</span>';

                        const lastSeen = props.last_seen ?
                            new Date(props.last_seen).toLocaleString() :
                            'Never';

                        const popupContent = `
                            <div style="min-width: 200px;">
                                <h6 class="mb-1">
                                    <i class="fas fa-laptop text-primary"></i>
                                    <strong>${props.name}</strong>
                                </h6>
                                <p class="mb-1 small">
                                    <strong>Type:</strong> ${props.type}<br>
                                    ${props.manufacturer ? `<strong>Manufacturer:</strong> ${props.manufacturer}<br>` : ''}
                                    ${props.model ? `<strong>Model:</strong> ${props.model}<br>` : ''}
                                    <strong>Status:</strong> ${statusBadge}<br>
                                    <strong>Last Seen:</strong> ${lastSeen}
                                </p>
                                <a href="${props.url}" class="btn btn-sm btn-primary"><i class="fas fa-eye"></i> View Device</a>
                            </div>
                        `;
                        marker.bindPopup(popupContent);
                        deviceMarkers.push(marker);
                    });

                    console.log(`Loaded ${deviceMarkers.length} devices on map`);
                }
            })
            .catch(error => {
                console.error('Error loading device data:', error);
            });
    }

    // Toggle device layer
    if (toggleButton) {
        toggleButton.addEventListener('click', function() {
            showDevices = !showDevices;
            if (showDevices) {
                toggleButton.classList.remove('btn-outline-primary');
                toggleButton.classList.add('btn-primary');
                toggleText.textContent = 'Hide Devices';
                loadDeviceLayer();
            } else {
                toggleButton.classList.remove('btn-primary');
                toggleButton.classList.add('btn-outline-primary');
                toggleText.textContent = 'Show Devices';
                // Remove device markers
                deviceMarkers.forEach(marker => map.removeLayer(marker));
                deviceMarkers.length = 0;
            }
        });
    }

    // Fetch location data and initialize map
    fetch('{% url "locations:location_map_data" %}')
        .then(response => response.json())
        .then(data => {
            if (data.features && data.features.length > 0) {
                // Hide message, show map
                messageDiv.style.display = 'none';
                mapDiv.style.display = 'block';

                // Initialize map (remove existing instance if present)
                if (map) {
                    map.remove();
                    map = null;
                }

                // Additional check: Leaflet marks initialized containers with _leaflet_id
                // Remove any Leaflet-specific properties from the container
                if (mapDiv._leaflet_id) {
                    delete mapDiv._leaflet_id;
                }

                // Create map with configured settings
                map = L.map('location-map', {
                    dragging: {{ map_dragging_enabled|lower }},
                    scrollWheelZoom: true,
                    touchZoom: true,
                    doubleClickZoom: true,
                    boxZoom: true
                }).setView([39.8283, -98.5795], {{ map_default_zoom }}); // Center of USA

                // Add OpenStreetMap tiles
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                    maxZoom: 19
                }).addTo(map);

                // Add markers for each location
                data.features.forEach(feature => {
                    const coord = feature.geometry.coordinates;
                    const props = feature.properties;
                    const color = getLocationMarkerColor(props.status, props.is_primary);

                    const marker = L.marker([coord[1], coord[0]], {
                        icon: createLocationIcon(color)
                    }).addTo(map);

                    // Create popup content
                    const popupContent = `
                        <div style="min-width: 200px;">
                            <h6 class="mb-1">
                                ${props.is_primary ? '<i class="fas fa-star text-warning"></i> ' : ''}
                                <strong>${props.name}</strong>
                            </h6>
                            <p class="mb-1 small">${props.address}</p>
                            <p class="mb-1"><span class="badge bg-secondary">${props.location_type}</span> <span class="badge bg-${props.status === 'active' ? 'success' : 'secondary'}">${props.status}</span></p>
                            <a href="${props.url}" class="btn btn-sm btn-primary"><i class="fas fa-eye"></i> View Details</a>
                        </div>
                    `;
                    marker.bindPopup(popupContent);
                    locationMarkers.push(marker);
                });

                // Fit bounds to show all location markers
                if (locationMarkers.length > 0) {
                    const group = L.featureGroup(locationMarkers);
                    map.fitBounds(group.getBounds().pad(0.1));
                }

                // Show map controls
                const mapControlsDiv = document.getElementById('map-controls');
                mapControlsDiv.style.display = 'block';

                // Prevent Leaflet from handling ANY events on controls
                L.DomEvent.disableClickPropagation(mapControlsDiv);
                L.DomEvent.disableScrollPropagation(mapControlsDiv);

                // Map settings controls
                const settingsBtn = document.getElementById('map-settings-btn');
                const settingsPanel = document.getElementById('map-settings-panel');
                const zoomSlider = document.getElementById('map-zoom-slider');
                const zoomDisplay = document.getElementById('zoom-level-display');
                const draggingToggle = document.getElementById('map-dragging-toggle');

                console.log('Map controls initialized:', {
                    settingsBtn: settingsBtn,
                    settingsPanel: settingsPanel,
                    visible: mapControlsDiv.style.display,
                    zIndex: window.getComputedStyle(mapControlsDiv).zIndex
                });

                // Load saved preferences from localStorage, or use server defaults
                const savedZoom = localStorage.getItem('mapDefaultZoom');
                const savedDragging = localStorage.getItem('mapDraggingEnabled');

                // Initialize zoom (use saved or current map zoom)
                const initialZoom = savedZoom ? parseInt(savedZoom) : map.getZoom();
                zoomSlider.value = initialZoom;
                zoomDisplay.textContent = initialZoom;
                if (savedZoom) {
                    map.setZoom(initialZoom);
                }

                // Initialize dragging (use saved or server default)
                if (savedDragging !== null) {
                    const draggingEnabled = savedDragging === 'true';
                    draggingToggle.checked = draggingEnabled;
                    if (draggingEnabled) {
                        map.dragging.enable();
                    } else {
                        map.dragging.disable();
                    }
                } else {
                    // No saved preference, use current state from server config
                    draggingToggle.checked = {{ map_dragging_enabled|lower }};
                }

                // Toggle settings panel
                settingsBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Settings button clicked!');
                    const isVisible = settingsPanel.style.display === 'block';
                    settingsPanel.style.display = isVisible ? 'none' : 'block';
                    console.log('Panel visibility toggled to:', settingsPanel.style.display);
                });

                // Close panel when clicking outside
                document.addEventListener('click', function(e) {
                    if (!settingsPanel.contains(e.target) && !settingsBtn.contains(e.target)) {
                        settingsPanel.style.display = 'none';
                    }
                });

                // Zoom slider
                zoomSlider.addEventListener('input', function() {
                    const zoom = parseInt(this.value);
                    zoomDisplay.textContent = zoom;
                    map.setZoom(zoom);
                    localStorage.setItem('mapDefaultZoom', zoom);
                });

                // Dragging toggle
                draggingToggle.addEventListener('change', function() {
                    if (this.checked) {
                        map.dragging.enable();
                        localStorage.setItem('mapDraggingEnabled', 'true');
                    } else {
                        map.dragging.disable();
                        localStorage.setItem('mapDraggingEnabled', 'false');
                    }
                });

            } else {
                // No locations with coordinates
                messageText.textContent = 'No locations with coordinates. Add locations with addresses to see them on the map.';
                messageDiv.style.display = 'block';
                mapDiv.style.display = 'none';
                // Hide device toggle if no map
                if (toggleButton) toggleButton.style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Error loading map data:', error);
            // Check if it's a 400 error (no organization context)
            if (error.message && error.message.includes('400')) {
                messageText.textContent = 'Select an organization to view location map.';
            } else {
                messageText.textContent = 'Unable to load map. Ensure you have locations with addresses and coordinates.';
            }
            messageDiv.style.display = 'block';
            mapDiv.style.display = 'none';
            // Hide device toggle if error
            if (toggleButton) toggleButton.style.display = 'none';
        });
});
</script>
{% endblock %}
{% endblock %}

{% extends "base.html" %}

{% block title %}Global Dashboard - HuduGlue{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2><i class="fas fa-globe"></i> Global Dashboard</h2>
    <span class="badge bg-danger">Superuser Only</span>
</div>

<!-- System-wide Stats Cards -->
<div class="row g-2 mb-3">
    <div class="col-md-3 col-sm-6">
        <a href="{% url 'accounts:organization_list' %}" class="text-decoration-none">
            <div class="card bg-primary text-white h-100" style="cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                <div class="card-body py-2 px-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-0">{{ stats.organizations }}</h4>
                            <small>Organizations</small>
                        </div>
                        <i class="fas fa-building fa-lg opacity-50"></i>
                    </div>
                </div>
            </div>
        </a>
    </div>
    <div class="col-md-3 col-sm-6">
        <a href="{% url 'accounts:user_list' %}" class="text-decoration-none">
            <div class="card bg-success text-white h-100" style="cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                <div class="card-body py-2 px-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-0">{{ stats.users }}</h4>
                            <small>Users</small>
                        </div>
                        <i class="fas fa-users fa-lg opacity-50"></i>
                    </div>
                </div>
            </div>
        </a>
    </div>
    <div class="col-md-3 col-sm-6">
        <a href="{% url 'assets:asset_list' %}" class="text-decoration-none">
            <div class="card bg-info text-white h-100" style="cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                <div class="card-body py-2 px-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-0">{{ stats.total_assets }}</h4>
                            <small>Total Assets</small>
                        </div>
                        <i class="fas fa-box fa-lg opacity-50"></i>
                    </div>
                </div>
            </div>
        </a>
    </div>
    <div class="col-md-3 col-sm-6">
        <a href="{% url 'docs:document_list' %}" class="text-decoration-none">
            <div class="card bg-warning text-dark h-100" style="cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                <div class="card-body py-2 px-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-0">{{ stats.total_documents }}</h4>
                            <small>Total Documents</small>
                        </div>
                        <i class="fas fa-file-alt fa-lg opacity-50"></i>
                    </div>
                </div>
            </div>
        </a>
    </div>
</div>

<div class="row g-2 mb-3">
    <div class="col-md-3 col-sm-6">
        <a href="{% url 'vault:password_list' %}" class="text-decoration-none">
            <div class="card bg-danger text-white h-100" style="cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                <div class="card-body py-2 px-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-0">{{ stats.total_passwords }}</h4>
                            <small>Total Passwords</small>
                        </div>
                        <i class="fas fa-key fa-lg opacity-50"></i>
                    </div>
                </div>
            </div>
        </a>
    </div>
    <div class="col-md-3 col-sm-6">
        <a href="{% url 'processes:global_process_list' %}" class="text-decoration-none">
            <div class="card bg-secondary text-white h-100" style="cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                <div class="card-body py-2 px-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-0">{{ stats.total_processes }}</h4>
                            <small>Total Processes</small>
                        </div>
                        <i class="fas fa-tasks fa-lg opacity-50"></i>
                    </div>
                </div>
            </div>
        </a>
    </div>
    <div class="col-md-3 col-sm-6">
        <a href="{% url 'monitoring:website_monitor_list' %}" class="text-decoration-none">
            <div class="card bg-dark text-white h-100" style="cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                <div class="card-body py-2 px-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-0">{{ stats.total_monitors }}</h4>
                            <small>Total Monitors</small>
                        </div>
                        <i class="fas fa-chart-line fa-lg opacity-50"></i>
                    </div>
                </div>
            </div>
        </a>
    </div>
    <div class="col-md-3 col-sm-6">
        <div class="card border-primary">
            <div class="card-body py-2 px-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="mb-0">{{ total_attachments }}</h4>
                        <small>Total Files</small>
                    </div>
                    <i class="fas fa-paperclip fa-lg text-primary opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- System Health -->
<div class="row mb-3">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header py-2">
                <h5 class="mb-0"><i class="fas fa-heartbeat"></i> System Health (Last 30 Days)</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 text-center">
                        <h3 class="text-success">{{ health_stats.active_users_30d }}</h3>
                        <p class="text-muted mb-0">Active Users</p>
                    </div>
                    <div class="col-md-3 text-center">
                        <h3 class="text-primary">{{ health_stats.new_orgs_30d }}</h3>
                        <p class="text-muted mb-0">New Organizations</p>
                    </div>
                    <div class="col-md-3 text-center">
                        <h3 class="text-info">{{ health_stats.active_processes }}</h3>
                        <p class="text-muted mb-0">Active Process Executions</p>
                    </div>
                    <div class="col-md-3 text-center">
                        <h3 class="{% if health_stats.monitors_down > 0 %}text-danger{% else %}text-success{% endif %}">
                            {{ health_stats.monitors_down }}
                        </h3>
                        <p class="text-muted mb-0">Monitors Down</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Global Location Map -->
<div class="row mb-3">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header py-2 d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-map-marked-alt"></i> Global Location Map</h5>
                <div>
                    <button id="global-toggle-dragging" class="btn btn-sm btn-outline-secondary me-2" style="display: none;">
                        <i class="fas fa-lock"></i> <span id="global-dragging-toggle-text">Dragging Disabled</span>
                    </button>
                    <button id="global-toggle-satellite" class="btn btn-sm btn-outline-info me-2" style="display: none;">
                        <i class="fas fa-satellite"></i> <span id="global-satellite-toggle-text">Satellite View</span>
                    </button>
                    <span class="text-muted small">All Organizations</span>
                </div>
            </div>
            <div class="card-body p-0">
                <div id="global-location-map" style="height: 500px; width: 100%; position: relative; z-index: 1; cursor: grab;"></div>
                <div id="global-map-message" class="text-center py-5 text-muted" style="display: none;">
                    <i class="fas fa-map-marker-alt fa-3x mb-3"></i><br>
                    <span id="global-map-message-text">Loading map...</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Process Stats -->
<div class="row mb-3">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header py-2">
                <h5 class="mb-0"><i class="fas fa-tasks"></i> Process Statistics</h5>
            </div>
            <div class="card-body">
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Total Processes
                        <span class="badge bg-primary rounded-pill">{{ process_stats.total }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Global Processes
                        <span class="badge bg-success rounded-pill">{{ process_stats.global }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Organization-Specific
                        <span class="badge bg-info rounded-pill">{{ process_stats.org_specific }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Active Executions
                        <span class="badge bg-warning rounded-pill">{{ process_stats.active_executions }}</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Top Organizations -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header py-2">
                <h5 class="mb-0"><i class="fas fa-building"></i> Top Organizations</h5>
            </div>
            <div class="card-body">
                {% if top_orgs %}
                <div class="list-group list-group-flush">
                    {% for org in top_orgs %}
                    <a href="{% url 'accounts:organization_detail' org.id %}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <strong>{{ org.name }}</strong>
                            <br>
                            <small class="text-muted">
                                {{ org.member_count }} members |
                                {{ org.asset_count }} assets |
                                {{ org.document_count }} docs
                            </small>
                        </div>
                        <i class="fas fa-chevron-right"></i>
                    </a>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted mb-0">No organizations found.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Global Activity Feed -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header py-2">
                <h5 class="mb-0"><i class="fas fa-stream"></i> Recent Global Activity</h5>
            </div>
            <div class="card-body">
                {% if global_activity %}
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>User</th>
                                <th>Organization</th>
                                <th>Action</th>
                                <th>Object</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for log in global_activity %}
                            <tr>
                                <td><small>{{ log.timestamp|timesince }} ago</small></td>
                                <td>{{ log.user.username }}</td>
                                <td>
                                    {% if log.organization %}
                                    <span class="badge bg-secondary">{{ log.organization.name }}</span>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge
                                        {% if log.action == 'create' %}bg-success
                                        {% elif log.action == 'update' %}bg-info
                                        {% elif log.action == 'delete' %}bg-danger
                                        {% else %}bg-secondary
                                        {% endif %}">
                                        {{ log.get_action_display }}
                                    </span>
                                </td>
                                <td>
                                    <small>
                                        {% if log.object_repr %}
                                        {{ log.object_type }}: {{ log.object_repr|truncatechars:40 }}
                                        {% else %}
                                        {{ log.description|truncatechars:50 }}
                                        {% endif %}
                                    </small>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted mb-0">No recent activity.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
// Initialize global location map
document.addEventListener('DOMContentLoaded', function() {
    const mapDiv = document.getElementById('global-location-map');
    const messageDiv = document.getElementById('global-map-message');
    const messageText = document.getElementById('global-map-message-text');
    let map = null;

    // Fetch global location data
    fetch('{% url "locations:global_location_map_data" %}')
        .then(response => response.json())
        .then(data => {
            if (data.features && data.features.length > 0) {
                // Hide message, show map
                messageDiv.style.display = 'none';
                mapDiv.style.display = 'block';

                // Initialize map (remove existing instance if present)
                if (map) {
                    map.remove();
                    map = null;
                }

                // Additional check: Leaflet marks initialized containers with _leaflet_id
                // Remove any Leaflet-specific properties from the container
                if (mapDiv._leaflet_id) {
                    delete mapDiv._leaflet_id;
                }

                // Create map with configured settings
                map = L.map('global-location-map', {
                    dragging: {{ map_dragging_enabled|lower }},
                    scrollWheelZoom: true,
                    touchZoom: true,
                    doubleClickZoom: true,
                    boxZoom: true,
                    zoomControl: true  // Show built-in +/- zoom buttons
                }).setView([39.8283, -98.5795], {{ map_default_zoom }}); // Center of USA

                // Define tile layers
                const streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                    maxZoom: 19
                });

                const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: '&copy; <a href="https://www.esri.com/">Esri</a>',
                    maxZoom: 19
                });

                // Add default layer (street view)
                streetLayer.addTo(map);

                let isSatelliteView = false;

                // Create organization color map
                const orgColors = {};
                const colorPalette = ['#007bff', '#28a745', '#ffc107', '#dc3545', '#17a2b8', '#6c757d', '#e83e8c', '#fd7e14', '#20c997', '#6f42c1'];
                let colorIndex = 0;

                // Assign colors to organizations
                data.features.forEach(feature => {
                    const orgId = feature.properties.organization_id;
                    if (!orgColors[orgId]) {
                        orgColors[orgId] = colorPalette[colorIndex % colorPalette.length];
                        colorIndex++;
                    }
                });

                // Define marker colors based on organization
                function getMarkerColor(orgId, status, is_primary) {
                    if (is_primary) return '#ffc107'; // Yellow/gold for HQ
                    if (status === 'inactive' || status === 'closed') return '#6c757d'; // Gray for inactive
                    return orgColors[orgId] || '#007bff';
                }

                // Create custom marker icons
                function createCustomIcon(color) {
                    return L.divIcon({
                        className: 'custom-map-marker',
                        html: `<div style="background-color: ${color}; width: 28px; height: 28px; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); border: 3px solid #fff; box-shadow: 0 3px 6px rgba(0,0,0,0.4);"><div style="transform: rotate(45deg); margin-top: 4px; margin-left: 7px;"><i class="fas fa-building" style="font-size: 11px; color: #fff;"></i></div></div>`,
                        iconSize: [28, 42],
                        iconAnchor: [14, 42],
                        popupAnchor: [1, -34]
                    });
                }

                // Add markers for each location
                const markers = [];
                data.features.forEach(feature => {
                    const coord = feature.geometry.coordinates;
                    const props = feature.properties;
                    const color = getMarkerColor(props.organization_id, props.status, props.is_primary);

                    const marker = L.marker([coord[1], coord[0]], {
                        icon: createCustomIcon(color)
                    }).addTo(map);

                    // Create popup content
                    const popupContent = `
                        <div style="min-width: 250px;">
                            <div class="mb-2">
                                <span class="badge" style="background-color: ${orgColors[props.organization_id] || '#007bff'};">${props.organization_name}</span>
                            </div>
                            <h6 class="mb-1">
                                ${props.is_primary ? '<i class="fas fa-star text-warning"></i> ' : ''}
                                <strong>${props.name}</strong>
                            </h6>
                            <p class="mb-1 small">${props.address}</p>
                            <p class="mb-2">
                                <span class="badge bg-secondary">${props.location_type}</span>
                                <span class="badge bg-${props.status === 'active' ? 'success' : 'secondary'}">${props.status}</span>
                            </p>
                            <a href="${props.url}" class="btn btn-sm btn-primary"><i class="fas fa-eye"></i> View Details</a>
                        </div>
                    `;
                    marker.bindPopup(popupContent);
                    markers.push(marker);
                });

                // Fit bounds to show all markers
                if (markers.length > 0) {
                    const group = L.featureGroup(markers);
                    map.fitBounds(group.getBounds().pad(0.1));
                }

                // Setup dragging toggle button
                const draggingToggleBtn = document.getElementById('global-toggle-dragging');
                if (draggingToggleBtn) {
                    // Show the dragging toggle button
                    draggingToggleBtn.style.display = 'inline-block';

                    // Check if dragging is currently enabled from map state
                    let draggingEnabled = map.dragging.enabled();
                    console.log('Initial dragging state:', draggingEnabled);

                    // Update button state
                    function updateDraggingButton() {
                        const iconHtml = draggingEnabled ? '<i class="fas fa-unlock"></i>' : '<i class="fas fa-lock"></i>';
                        const textHtml = draggingEnabled ? 'Dragging Enabled' : 'Dragging Disabled';

                        draggingToggleBtn.className = draggingEnabled ?
                            'btn btn-sm btn-success me-2' :
                            'btn btn-sm btn-outline-secondary me-2';

                        draggingToggleBtn.innerHTML = iconHtml + ' <span id="global-dragging-toggle-text">' + textHtml + '</span>';
                        console.log('Button updated - dragging is now:', draggingEnabled);
                    }

                    updateDraggingButton();

                    // Toggle dragging when button clicked
                    draggingToggleBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('Dragging toggle clicked, current state:', draggingEnabled);
                        draggingEnabled = !draggingEnabled;
                        if (draggingEnabled) {
                            map.dragging.enable();
                            console.log('Map dragging enabled');
                            console.log('Drag handler enabled:', map.dragging.enabled());
                            console.log('Drag handler exists:', !!map.dragging._draggable);
                            // Change cursor to indicate dragging is possible
                            document.getElementById('global-location-map').style.cursor = 'grab';
                        } else {
                            map.dragging.disable();
                            console.log('Map dragging disabled');
                            console.log('Drag handler enabled:', map.dragging.enabled());
                            // Change cursor to indicate dragging is locked
                            document.getElementById('global-location-map').style.cursor = 'default';
                        }
                        updateDraggingButton();
                    });

                    // Test: Add a mousedown listener to see if events are reaching the map
                    document.getElementById('global-location-map').addEventListener('mousedown', function(e) {
                        console.log('Mousedown on map container detected!');
                        console.log('Is dragging currently enabled?', map.dragging.enabled());
                    });

                    // Add drag event listeners to Leaflet's drag handler
                    map.on('dragstart', function(e) {
                        console.log('✅ DRAG START EVENT FIRED!');
                    });

                    map.on('drag', function(e) {
                        console.log('✅ DRAGGING...');
                    });

                    map.on('dragend', function(e) {
                        console.log('✅ DRAG END EVENT FIRED!');
                    });

                    // Check if touchZoom is interfering
                    console.log('Touch zoom enabled:', map.touchZoom.enabled());
                    console.log('Scroll wheel zoom enabled:', map.scrollWheelZoom.enabled());
                    console.log('Box zoom enabled:', map.boxZoom.enabled());
                    console.log('Keyboard enabled:', map.keyboard.enabled());

                    console.log('Dragging toggle button initialized');
                    console.log('Map object:', map);
                    console.log('Map dragging handler:', map.dragging);
                }

                // Setup satellite view toggle button
                const satelliteToggleBtn = document.getElementById('global-toggle-satellite');
                if (satelliteToggleBtn) {
                    // Show the satellite toggle button
                    satelliteToggleBtn.style.display = 'inline-block';

                    // Toggle satellite view when button clicked
                    satelliteToggleBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        isSatelliteView = !isSatelliteView;

                        if (isSatelliteView) {
                            map.removeLayer(streetLayer);
                            map.addLayer(satelliteLayer);
                            satelliteToggleBtn.className = 'btn btn-sm btn-info me-2';
                            satelliteToggleBtn.innerHTML = '<i class="fas fa-map"></i> <span id="global-satellite-toggle-text">Street View</span>';
                        } else {
                            map.removeLayer(satelliteLayer);
                            map.addLayer(streetLayer);
                            satelliteToggleBtn.className = 'btn btn-sm btn-outline-info me-2';
                            satelliteToggleBtn.innerHTML = '<i class="fas fa-satellite"></i> <span id="global-satellite-toggle-text">Satellite View</span>';
                        }
                    });
                }

                // Create legend for organizations
                const legend = L.control({position: 'bottomright'});
                legend.onAdd = function(map) {
                    const div = L.DomUtil.create('div', 'map-legend');
                    // Use theme-aware colors for better dark mode support
                    const isDarkMode = document.documentElement.getAttribute('data-bs-theme') === 'dark';
                    div.style.backgroundColor = isDarkMode ? '#2b3035' : 'white';
                    div.style.color = isDarkMode ? '#dee2e6' : '#212529';
                    div.style.padding = '10px';
                    div.style.border = isDarkMode ? '2px solid rgba(255,255,255,0.2)' : '2px solid rgba(0,0,0,0.2)';
                    div.style.borderRadius = '5px';
                    div.style.maxHeight = '200px';
                    div.style.overflowY = 'auto';
                    div.innerHTML = '<strong>Organizations</strong><br>';

                    // Get unique organizations
                    const orgs = {};
                    data.features.forEach(feature => {
                        const orgId = feature.properties.organization_id;
                        const orgName = feature.properties.organization_name;
                        if (!orgs[orgId]) {
                            orgs[orgId] = orgName;
                        }
                    });

                    // Add legend items
                    Object.keys(orgs).forEach(orgId => {
                        div.innerHTML += `<div><span style="display: inline-block; width: 12px; height: 12px; background-color: ${orgColors[orgId]}; border: 1px solid #fff; margin-right: 5px;"></span>${orgs[orgId]}</div>`;
                    });

                    return div;
                };
                legend.addTo(map);

            } else {
                // No locations with coordinates
                messageText.textContent = 'No locations with coordinates found across all organizations.';
                messageDiv.style.display = 'block';
                mapDiv.style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Error loading global map data:', error);
            messageText.textContent = 'Unable to load map. Please try again later.';
            messageDiv.style.display = 'block';
            mapDiv.style.display = 'none';
        });
});
</script>
{% endblock %}
{% endblock %}

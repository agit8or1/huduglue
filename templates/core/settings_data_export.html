{% extends "base.html" %}

{% block title %}Data Export - HuduGlue{% endblock %}

{% block content %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'core:dashboard' %}">Dashboard</a></li>
        <li class="breadcrumb-item active">Data Export</li>
    </ol>
</nav>

<div class="row">
    <div class="col-md-3">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-cog"></i> Settings</h5>
            </div>
            <div class="list-group list-group-flush">
                <a href="{% url 'core:settings_general' %}" class="list-group-item list-group-item-action">
                    <i class="fas fa-sliders-h"></i> General
                </a>
                <a href="{% url 'core:settings_security' %}" class="list-group-item list-group-item-action">
                    <i class="fas fa-shield-alt"></i> Security
                </a>
                <a href="{% url 'core:settings_smtp' %}" class="list-group-item list-group-item-action">
                    <i class="fas fa-envelope"></i> SMTP/Email
                </a>
                <a href="{% url 'core:settings_scheduler' %}" class="list-group-item list-group-item-action">
                    <i class="fas fa-clock"></i> Task Scheduler
                </a>
                <a href="{% url 'core:settings_directory' %}" class="list-group-item list-group-item-action">
                    <i class="fas fa-users-cog"></i> Directory Services
                </a>
                <a href="{% url 'core:settings_ai' %}" class="list-group-item list-group-item-action">
                    <i class="fas fa-robot"></i> AI & LLM
                </a>
                <a href="{% url 'core:settings_snyk' %}" class="list-group-item list-group-item-action">
                    <i class="fas fa-bug"></i> Snyk Security
                </a>
                <a href="{% url 'core:settings_kb_import' %}" class="list-group-item list-group-item-action">
                    <i class="fas fa-book-medical"></i> KB Article Import
                </a>
                <a href="{% url 'core:settings_data_export' %}" class="list-group-item list-group-item-action active">
                    <i class="fas fa-file-export"></i> Data Export
                </a>
                <a href="{% url 'core:system_status' %}" class="list-group-item list-group-item-action">
                    <i class="fas fa-heartbeat"></i> System Status
                </a>
                <a href="{% url 'core:system_updates' %}" class="list-group-item list-group-item-action">
                    <i class="fas fa-sync-alt"></i> System Updates
                </a>
                <a href="{% url 'core:maintenance' %}" class="list-group-item list-group-item-action">
                    <i class="fas fa-tools"></i> Maintenance
                </a>
            </div>
        </div>
    </div>

    <div class="col-md-9">
        <!-- Current Statistics -->
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Data Statistics</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <h3 class="text-primary mb-0">{{ stats.assets }}</h3>
                        <p class="text-muted mb-0">Assets</p>
                    </div>
                    <div class="col-md-3">
                        <h3 class="text-info mb-0">{{ stats.contacts }}</h3>
                        <p class="text-muted mb-0">Contacts</p>
                    </div>
                    <div class="col-md-3">
                        <h3 class="text-warning mb-0">{{ stats.documents }}</h3>
                        <p class="text-muted mb-0">Documents</p>
                    </div>
                    <div class="col-md-3">
                        <h3 class="text-danger mb-0">{{ stats.passwords }}</h3>
                        <p class="text-muted mb-0">Passwords</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Export Options -->
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-file-export"></i> Export Data</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>About Data Export:</strong>
                    <ul class="mb-0 mt-2">
                        <li>Export your HuduGlue data to JSON format or compatible formats for Hudu and IT Glue</li>
                        <li><strong>Security Note:</strong> Passwords are exported in encrypted form only</li>
                        <li>Select the data type and export format below</li>
                        <li>Exports are generated as downloadable JSON files</li>
                    </ul>
                </div>

                <form id="exportForm">
                    {% csrf_token %}

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label"><strong>What to Export</strong></label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="exportType" id="typeAll" value="all" checked>
                                <label class="form-check-label" for="typeAll">
                                    <strong>All Data</strong> - Complete export
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="exportType" id="typeAssets" value="assets">
                                <label class="form-check-label" for="typeAssets">
                                    Assets Only ({{ stats.assets }} items)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="exportType" id="typeContacts" value="contacts">
                                <label class="form-check-label" for="typeContacts">
                                    Contacts Only ({{ stats.contacts }} items)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="exportType" id="typeDocs" value="documents">
                                <label class="form-check-label" for="typeDocs">
                                    Documents Only ({{ stats.documents }} items)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="exportType" id="typePasswords" value="passwords">
                                <label class="form-check-label" for="typePasswords">
                                    Passwords Only ({{ stats.passwords }} items) - <small class="text-danger">Encrypted</small>
                                </label>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label"><strong>Export Format</strong></label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="exportFormat" id="formatJson" value="json" checked>
                                <label class="form-check-label" for="formatJson">
                                    <strong>JSON</strong> - Standard format
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="exportFormat" id="formatHudu" value="hudu">
                                <label class="form-check-label" for="formatHudu">
                                    <strong>Hudu Format</strong> - Compatible with Hudu API
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="exportFormat" id="formatItglue" value="itglue">
                                <label class="form-check-label" for="formatItglue">
                                    <strong>IT Glue Format</strong> - Compatible with IT Glue API
                                </label>
                            </div>

                            <div class="alert alert-warning mt-3">
                                <small>
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <strong>Note:</strong> Hudu and IT Glue formats are structured for API compatibility but may require additional processing for direct import.
                                </small>
                            </div>
                        </div>
                    </div>

                    <hr>

                    <button type="button" class="btn btn-primary btn-lg" onclick="startExport()">
                        <i class="fas fa-download"></i> Generate Export
                    </button>
                </form>
            </div>
        </div>

        <!-- Information Card -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-info-circle"></i> Export Format Information</h5>
            </div>
            <div class="card-body">
                <h6><strong>JSON Format</strong></h6>
                <p>Standard JSON export with all fields preserved. Use this for backup or custom import scripts.</p>

                <h6><strong>Hudu Format</strong></h6>
                <p>Structured for compatibility with <a href="https://www.usehudu.com/" target="_blank">Hudu</a> documentation platform API. Maps HuduGlue data to Hudu's asset, company, and KB article structure.</p>

                <h6><strong>IT Glue Format</strong></h6>
                <p>Structured for compatibility with <a href="https://www.itglue.com/" target="_blank">IT Glue</a> documentation platform API. Maps HuduGlue data to IT Glue's configurations, organizations, and contacts structure.</p>

                <hr>

                <h6><strong>Password Security</strong></h6>
                <p class="mb-0">
                    <i class="fas fa-lock text-danger"></i> Passwords are <strong>NEVER</strong> exported in plaintext. Only the encrypted password field is included in exports for security reasons. To migrate passwords, you'll need to export them separately using the password management interface.
                </p>
            </div>
        </div>
    </div>
</div>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function startExport() {
    const exportType = document.querySelector('input[name="exportType"]:checked').value;
    const exportFormat = document.querySelector('input[name="exportFormat"]:checked').value;

    // Create form
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{% url "core:export_data" %}';

    // Add CSRF token
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = getCookie('csrftoken');
    form.appendChild(csrfInput);

    // Add export type
    const typeInput = document.createElement('input');
    typeInput.type = 'hidden';
    typeInput.name = 'type';
    typeInput.value = exportType;
    form.appendChild(typeInput);

    // Add export format
    const formatInput = document.createElement('input');
    formatInput.type = 'hidden';
    formatInput.name = 'format';
    formatInput.value = exportFormat;
    form.appendChild(formatInput);

    // Submit form
    document.body.appendChild(form);
    form.submit();
    document.body.removeChild(form);
}
</script>
{% endblock %}

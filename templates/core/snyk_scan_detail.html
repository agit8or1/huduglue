{% extends "base.html" %}

{% block title %}Scan {{ scan.scan_id }} - Snyk - HuduGlue{% endblock %}

{% block content %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'core:dashboard' %}">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="{% url 'core:settings_snyk' %}">Snyk Security</a></li>
        <li class="breadcrumb-item"><a href="{% url 'core:snyk_scans' %}">Scan History</a></li>
        <li class="breadcrumb-item active">{{ scan.scan_id }}</li>
    </ol>
</nav>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-shield-alt"></i> Scan Details: {{ scan.scan_id }}
                </h5>
                <a href="{% url 'core:snyk_scans' %}" class="btn btn-sm btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to History
                </a>
            </div>
            <div class="card-body">
                <!-- Scan Summary -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h3 class="mb-0">{{ scan.total_vulnerabilities }}</h3>
                                <small class="text-muted">Total Vulnerabilities</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-danger text-white">
                            <div class="card-body text-center">
                                <h3 class="mb-0">{{ scan.critical_count }}</h3>
                                <small>Critical</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning">
                            <div class="card-body text-center">
                                <h3 class="mb-0">{{ scan.high_count }}</h3>
                                <small>High</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-info text-white">
                            <div class="card-body text-center">
                                <h3 class="mb-0">{{ scan.medium_count }}</h3>
                                <small>Medium</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Scan Metadata -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-info-circle"></i> Scan Information</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Scan ID:</strong> <code>{{ scan.scan_id }}</code></p>
                                <p><strong>Status:</strong> <span class="badge {{ scan.get_status_badge_class }}">{{ scan.get_status_display }}</span></p>
                                <p><strong>Started:</strong> {{ scan.started_at|date:"Y-m-d H:i:s" }} UTC</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Completed:</strong> {{ scan.completed_at|date:"Y-m-d H:i:s" }} UTC</p>
                                <p><strong>Duration:</strong> {{ scan.duration_seconds }} seconds</p>
                                <p><strong>Triggered By:</strong> {% if scan.triggered_by %}{{ scan.triggered_by.username }}{% else %}System{% endif %}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Vulnerabilities List -->
                {% if vulnerabilities %}
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-bug"></i> Vulnerability Details</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped" id="vulnerabilitiesTable">
                                <thead>
                                    <tr>
                                        <th>Severity</th>
                                        <th>Title</th>
                                        <th>Package</th>
                                        <th>Current Version</th>
                                        <th>Fix Available</th>
                                        <th>CVE</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for vuln in vulnerabilities %}
                                    <tr>
                                        <td>
                                            <span class="badge bg-{% if vuln.severity == 'critical' %}danger{% elif vuln.severity == 'high' %}warning{% elif vuln.severity == 'medium' %}info{% else %}secondary{% endif %}">
                                                {{ vuln.severity|upper }}
                                            </span>
                                        </td>
                                        <td>{{ vuln.title|default:"N/A" }}</td>
                                        <td><code>{{ vuln.moduleName|default:vuln.packageName|default:"N/A" }}</code></td>
                                        <td><code>{{ vuln.version|default:"N/A" }}</code></td>
                                        <td>
                                            {% if vuln.fixedIn %}
                                                <span class="badge bg-success">
                                                    <i class="fas fa-arrow-up"></i> {{ vuln.fixedIn.0 }}
                                                </span>
                                            {% elif vuln.upgradePath %}
                                                <span class="badge bg-success">
                                                    <i class="fas fa-arrow-up"></i> Upgrade Available
                                                </span>
                                            {% else %}
                                                <span class="badge bg-secondary">
                                                    No Fix Yet
                                                </span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if vuln.identifiers.CVE %}
                                                {% for cve in vuln.identifiers.CVE %}
                                                <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name={{ cve }}" target="_blank" rel="noopener">
                                                    {{ cve }}
                                                </a>
                                                {% endfor %}
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm" role="group">
                                                {% if vuln.url %}
                                                <a href="{{ vuln.url }}" target="_blank" rel="noopener" class="btn btn-outline-primary">
                                                    <i class="fas fa-external-link-alt"></i> Details
                                                </a>
                                                {% endif %}
                                                {% if vuln.fixedIn %}
                                                <button type="button" class="btn btn-outline-success remediate-btn"
                                                        data-vuln-id="{{ vuln.id }}"
                                                        data-package="{{ vuln.moduleName|default:vuln.packageName }}"
                                                        data-current-version="{{ vuln.version }}"
                                                        data-fix-version="{{ vuln.fixedIn.0 }}"
                                                        data-title="{{ vuln.title }}"
                                                        data-severity="{{ vuln.severity }}"
                                                        data-cve="{% if vuln.identifiers.CVE %}{{ vuln.identifiers.CVE|join:', ' }}{% endif %}"
                                                        data-url="{{ vuln.url }}">
                                                    <i class="fas fa-wrench"></i> Remediate
                                                </button>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i> <strong>Good news!</strong> No vulnerabilities found in this scan.
                </div>
                {% endif %}

                <!-- Raw Output (Collapsible) -->
                {% if scan.scan_output %}
                <div class="card mt-4">
                    <div class="card-header">
                        <a class="text-decoration-none" data-bs-toggle="collapse" href="#rawOutput">
                            <i class="fas fa-code"></i> Raw Scan Output (Click to expand)
                        </a>
                    </div>
                    <div id="rawOutput" class="collapse">
                        <div class="card-body">
                            <pre class="bg-dark text-light p-3" style="max-height: 400px; overflow-y: auto;"><code>{{ scan.scan_output }}</code></pre>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Remediation Modal -->
<div class="modal fade" id="remediateModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-wrench"></i> Remediate Vulnerability
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Vulnerability Info -->
                <div class="alert alert-warning" id="vulnInfo">
                    <h6 class="alert-heading"><i class="fas fa-bug"></i> <span id="vulnTitle"></span></h6>
                    <p class="mb-2">
                        <strong>Package:</strong> <code id="vulnPackage"></code><br>
                        <strong>Current Version:</strong> <code id="vulnCurrentVersion"></code><br>
                        <strong>Severity:</strong> <span id="vulnSeverity" class="badge"></span>
                    </p>
                    <p class="mb-0" id="vulnCVEContainer" style="display: none;">
                        <strong>CVE:</strong> <span id="vulnCVE"></span>
                    </p>
                </div>

                <!-- Fix Information -->
                <div class="card mb-3">
                    <div class="card-header bg-success text-white">
                        <i class="fas fa-check-circle"></i> Recommended Fix
                    </div>
                    <div class="card-body">
                        <p><strong>Upgrade to Version:</strong> <code id="vulnFixVersion" class="fs-5"></code></p>
                        <p class="text-muted mb-0">
                            This version contains the security patch that addresses the vulnerability.
                        </p>
                    </div>
                </div>

                <!-- Command Preview -->
                <div class="card mb-3">
                    <div class="card-header">
                        <i class="fas fa-terminal"></i> Remediation Command
                    </div>
                    <div class="card-body">
                        <pre class="bg-dark text-light p-3 mb-0"><code id="remediateCommand"></code></pre>
                        <small class="text-muted">This command will be executed in the virtual environment</small>
                    </div>
                </div>

                <!-- Warning -->
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> <strong>Before Applying:</strong>
                    <ul class="mb-0 mt-2">
                        <li>Review the <a href="#" id="vulnDetailsLink" target="_blank">full vulnerability details</a></li>
                        <li>Check for breaking changes in the new version</li>
                        <li>Consider testing in a development environment first</li>
                        <li>Application restart may be required after upgrade</li>
                    </ul>
                </div>

                <!-- Results -->
                <div id="remediateResults" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="applyRemediateBtn">
                    <i class="fas fa-check"></i> Apply Fix
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    $('#vulnerabilitiesTable').DataTable({
        order: [[0, 'asc']],  // Sort by severity
        pageLength: 25,
    });

    // Handle Remediate button click
    $('.remediate-btn').on('click', function() {
        const btn = $(this);
        const package = btn.data('package');
        const currentVersion = btn.data('current-version');
        const fixVersion = btn.data('fix-version');
        const title = btn.data('title');
        const severity = btn.data('severity');
        const cve = btn.data('cve');
        const url = btn.data('url');

        // Populate modal
        $('#vulnTitle').text(title);
        $('#vulnPackage').text(package);
        $('#vulnCurrentVersion').text(currentVersion);
        $('#vulnFixVersion').text(fixVersion);

        // Set severity badge
        const severityBadge = $('#vulnSeverity');
        severityBadge.removeClass('bg-danger bg-warning bg-info bg-secondary');
        if (severity === 'critical') {
            severityBadge.addClass('bg-danger');
        } else if (severity === 'high') {
            severityBadge.addClass('bg-warning');
        } else if (severity === 'medium') {
            severityBadge.addClass('bg-info');
        } else {
            severityBadge.addClass('bg-secondary');
        }
        severityBadge.text(severity.toUpperCase());

        // Show/hide CVE
        if (cve) {
            $('#vulnCVE').text(cve);
            $('#vulnCVEContainer').show();
        } else {
            $('#vulnCVEContainer').hide();
        }

        // Set details link
        if (url) {
            $('#vulnDetailsLink').attr('href', url);
        }

        // Set command
        const command = `pip install "${package}==${fixVersion}"`;
        $('#remediateCommand').text(command);

        // Store data for remediation
        $('#applyRemediateBtn').data('package', package);
        $('#applyRemediateBtn').data('version', fixVersion);

        // Reset results
        $('#remediateResults').hide().html('');

        // Show modal
        $('#remediateModal').modal('show');
    });

    // Handle Apply Fix button
    $('#applyRemediateBtn').on('click', function() {
        const btn = $(this);
        const package = btn.data('package');
        const version = btn.data('version');
        const originalHtml = btn.html();

        // Disable button
        btn.prop('disabled', true);
        btn.html('<i class="fas fa-spinner fa-spin"></i> Applying Fix...');

        // Hide previous results
        $('#remediateResults').hide();

        // Send AJAX request
        $.ajax({
            url: '{% url "core:apply_snyk_remediation" %}',
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            data: {
                package: package,
                version: version
            },
            success: function(response) {
                const resultsDiv = $('#remediateResults');
                if (response.success) {
                    resultsDiv.html(`
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i> <strong>Success!</strong>
                            <p class="mb-2">${response.message}</p>
                            <details>
                                <summary>View Output</summary>
                                <pre class="bg-dark text-light p-2 mt-2" style="max-height: 200px; overflow-y: auto;"><code>${response.output}</code></pre>
                            </details>
                            <hr>
                            <p class="mb-2">
                                <i class="fas fa-info-circle"></i> <strong>Next Steps:</strong>
                            </p>
                            <div class="d-flex gap-2 mb-2">
                                <button type="button" class="btn btn-warning btn-sm" id="restartAppBtn">
                                    <i class="fas fa-sync-alt"></i> Restart Application
                                </button>
                                <a href="{% url 'core:settings_snyk' %}" class="btn btn-primary btn-sm">
                                    <i class="fas fa-redo"></i> Run New Scan
                                </a>
                            </div>
                            <small class="text-muted">
                                Restart the application to load the updated package, then run a new scan to verify the fix.
                            </small>
                        </div>
                    `);
                } else {
                    resultsDiv.html(`
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle"></i> <strong>Error:</strong> ${response.message}
                            ${response.output ? `<details class="mt-2"><summary>View Output</summary><pre class="bg-dark text-light p-2 mt-2"><code>${response.output}</code></pre></details>` : ''}
                        </div>
                    `);
                }
                resultsDiv.show();

                // Change button to close modal
                btn.prop('disabled', false);
                btn.html('<i class="fas fa-times"></i> Close');
                btn.removeClass('btn-success').addClass('btn-secondary');
                btn.off('click'); // Remove previous handler
                btn.on('click', function() {
                    $('#remediateModal').modal('hide');
                });
            },
            error: function(xhr, status, error) {
                $('#remediateResults').html(`
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i> <strong>Error:</strong> ${error}
                    </div>
                `).show();

                // Re-enable button
                btn.prop('disabled', false);
                btn.html(originalHtml);
            }
        });
    });

    // Handle Restart Application button (delegated event since it's dynamically created)
    $(document).on('click', '#restartAppBtn', function() {
        const btn = $(this);
        const originalHtml = btn.html();

        if (!confirm('Are you sure you want to restart the application? This will briefly disconnect all users.')) {
            return;
        }

        // Disable button
        btn.prop('disabled', true);
        btn.html('<i class="fas fa-spinner fa-spin"></i> Restarting...');

        // Send restart request
        $.ajax({
            url: '{% url "core:restart_application" %}',
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.success) {
                    btn.removeClass('btn-warning').addClass('btn-success');
                    btn.html('<i class="fas fa-check"></i> Restarted!');

                    // Show alert
                    alert('Application is restarting. The page will refresh in 5 seconds...');

                    // Reload page after 5 seconds
                    setTimeout(function() {
                        window.location.reload();
                    }, 5000);
                } else {
                    btn.prop('disabled', false);
                    btn.html(originalHtml);
                    alert('Failed to restart: ' + response.message);
                }
            },
            error: function(xhr, status, error) {
                btn.prop('disabled', false);
                btn.html(originalHtml);
                alert('Error restarting application: ' + error);
            }
        });
    });
});
</script>
{% endblock %}

{% extends 'base.html' %}
{% load static %}

{% block title %}System Updates - Admin Settings{% endblock %}

{% block extra_css %}
<style>
    .update-card {
        border-left: 4px solid #28a745;
    }
    .update-card.warning {
        border-left-color: #ffc107;
    }
    .update-card.danger {
        border-left-color: #dc3545;
    }
    .version-badge {
        font-size: 1.2em;
        padding: 0.5em 1em;
    }
    .git-status {
        font-family: 'Courier New', monospace;
        font-size: 0.9em;
    }
    .release-notes {
        background-color: #f8f9fa;
        border-radius: 0.25rem;
        padding: 1rem;
        margin-top: 1rem;
        max-height: 400px;
        overflow-y: auto;
    }
    .release-notes pre {
        white-space: pre-wrap;
        word-wrap: break-word;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-3">
        <div class="col">
            <h2><i class="fas fa-sync-alt"></i> System Updates</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'core:dashboard' %}">Dashboard</a></li>
                    <li class="breadcrumb-item active">System Updates</li>
                </ol>
            </nav>
        </div>
    </div>

    <!-- Current Version -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card update-card">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-info-circle"></i> Current Version</h5>
                    <h2 class="mb-0">
                        <span class="badge bg-primary version-badge">v{{ version }}</span>
                    </h2>
                    <p class="text-muted mt-2 mb-0">
                        Branch: <span class="git-status">{{ git_status.branch }}</span> |
                        Commit: <span class="git-status">{{ git_status.commit }}</span>
                        {% if git_status.clean %}
                        <span class="badge bg-success ms-2"><i class="fas fa-check"></i> Clean</span>
                        {% else %}
                        <span class="badge bg-warning ms-2"><i class="fas fa-exclamation-triangle"></i> Modified</span>
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card {% if update_info.update_available %}update-card warning{% else %}update-card{% endif %}">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-cloud-download-alt"></i> Latest Available Version</h5>
                    {% if update_info.error %}
                    <div class="alert alert-danger mb-0">
                        <i class="fas fa-exclamation-circle"></i> {{ update_info.error }}
                    </div>
                    {% elif update_info.update_available %}
                    <h2 class="mb-0">
                        <span class="badge bg-warning version-badge">v{{ update_info.latest_version }}</span>
                        <span class="badge bg-success ms-2">Update Available</span>
                    </h2>
                    <p class="text-muted mt-2 mb-0">
                        <small>Last checked: {{ update_info.checked_at|default:"Never" }}</small>
                    </p>
                    {% else %}
                    <h2 class="mb-0">
                        <span class="badge bg-success version-badge"><i class="fas fa-check"></i> Up to Date</span>
                    </h2>
                    <p class="text-muted mt-2 mb-0">
                        <small>Last checked: {{ update_info.checked_at|default:"Never" }}</small>
                    </p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Update Actions -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-cog"></i> Update Actions</h5>

                    <form method="POST" action="{% url 'core:check_updates_now' %}" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-sync"></i> Check for Updates Now
                        </button>
                    </form>

                    {% if update_info.update_available %}
                    <button type="button" class="btn btn-success ms-2" onclick="showUpdateModal()">
                        <i class="fas fa-download"></i> Apply Update
                    </button>
                    {% endif %}

                    <div class="alert alert-info mt-3 mb-0">
                        <i class="fas fa-info-circle"></i>
                        <strong>Note:</strong> Updates are automatically checked every hour.
                        The system will notify you when a new version is available.
                        {% if not git_status.clean %}
                        <br><br>
                        <i class="fas fa-exclamation-triangle text-warning"></i>
                        <strong>Warning:</strong> Your working directory has uncommitted changes.
                        These changes may be lost when applying updates.
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Manual CLI Update Instructions -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-info">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-terminal"></i> Manual Update from CLI
                    </h5>
                    <p class="mb-3">
                        For advanced users who prefer manual updates via command line. Run these commands in order:
                    </p>
                    <div class="bg-dark text-light p-3 rounded" style="font-family: 'Courier New', monospace; font-size: 0.9em;">
                        <div class="mb-2"><span class="text-success">#</span> Navigate to application directory (where manage.py is located)</div>
                        <div class="mb-2">cd /home/administrator</div>
                        <div class="mb-3"></div>
                        <div class="mb-2"><span class="text-success">#</span> Verify you're in the correct directory</div>
                        <div class="mb-2">ls manage.py venv/</div>
                        <div class="mb-2"><span class="text-muted" style="font-size: 0.85em;">(Should show: manage.py and venv/ directory)</span></div>
                        <div class="mb-3"></div>
                        <div class="mb-2"><span class="text-success">#</span> Pull latest updates from GitHub</div>
                        <div class="mb-2">git pull origin main</div>
                        <div class="mb-3"></div>
                        <div class="mb-2"><span class="text-success">#</span> Activate virtual environment</div>
                        <div class="mb-2">source venv/bin/activate</div>
                        <div class="mb-3"></div>
                        <div class="mb-2"><span class="text-success">#</span> Install updated dependencies</div>
                        <div class="mb-2">pip install -r requirements.txt</div>
                        <div class="mb-3"></div>
                        <div class="mb-2"><span class="text-success">#</span> Run database migrations</div>
                        <div class="mb-2">python manage.py migrate</div>
                        <div class="mb-3"></div>
                        <div class="mb-2"><span class="text-success">#</span> Collect static files</div>
                        <div class="mb-2">python manage.py collectstatic --noinput</div>
                        <div class="mb-3"></div>
                        <div class="mb-2"><span class="text-success">#</span> Restart Gunicorn service</div>
                        <div class="mb-0">sudo systemctl restart huduglue-gunicorn.service</div>
                    </div>
                    <div class="alert alert-info mt-3 mb-0">
                        <i class="fas fa-info-circle"></i>
                        <strong>Important Notes:</strong>
                        <ul class="mb-0 mt-2">
                            <li>The application directory is <code>/home/administrator</code> (NOT /home/administrator/huduglue)</li>
                            <li>You must run the <code>ls manage.py venv/</code> command to verify you're in the correct directory before proceeding</li>
                            <li>Make sure you have committed any local changes before pulling updates to avoid conflicts</li>
                            <li>Use <code>git status</code> to check for uncommitted changes</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Current Version Changelog -->
    {% if current_changelog %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-list-ul"></i> What's in v{{ version }}
                    </h5>
                    <div class="release-notes">
                        <pre>{{ current_changelog }}</pre>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Newer Versions Available -->
    {% if newer_changelogs %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-warning">
                <div class="card-body">
                    <h5 class="card-title text-warning">
                        <i class="fas fa-arrow-up"></i> What's New in Available Updates
                    </h5>
                    {% for ver, changelog in newer_changelogs.items %}
                    <div class="mb-4">
                        <h6 class="text-primary">
                            <i class="fas fa-tag"></i> Version {{ ver }}
                            {% if update_info.release_url %}
                            <a href="{{ update_info.release_url }}" target="_blank" class="btn btn-sm btn-outline-primary ms-2">
                                <i class="fas fa-external-link-alt"></i> View on GitHub
                            </a>
                            {% endif %}
                        </h6>
                        <div class="release-notes">
                            <pre>{{ changelog }}</pre>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Recent Update History -->
    {% if recent_updates %}
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-history"></i> Recent Update History</h5>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Date/Time</th>
                                    <th>Event</th>
                                    <th>Description</th>
                                    <th>User</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for update in recent_updates %}
                                <tr>
                                    <td>{{ update.timestamp|date:"Y-m-d H:i" }}</td>
                                    <td>
                                        {% if update.action == 'system_update' %}
                                        <span class="badge bg-success">Update Success</span>
                                        {% elif update.action == 'system_update_failed' %}
                                        <span class="badge bg-danger">Update Failed</span>
                                        {% elif update.action == 'update_check' %}
                                        <span class="badge bg-info">Update Check</span>
                                        {% else %}
                                        <span class="badge bg-secondary">{{ update.action }}</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ update.description }}</td>
                                    <td>{{ update.username|default:"System" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Update Confirmation Modal -->
<div class="modal fade" id="updateConfirmModal" tabindex="-1" aria-labelledby="updateConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="updateConfirmModalLabel">
                    <i class="fas fa-exclamation-triangle text-warning"></i> Confirm System Update
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>
                    <strong>You are about to update HuduGlue from v{{ version }} to v{{ update_info.latest_version }}</strong>
                </p>
                <p>The update process will:</p>
                <ul>
                    <li>Pull the latest code from GitHub</li>
                    <li>Install updated Python dependencies</li>
                    <li>Run database migrations</li>
                    <li>Collect static files</li>
                    <li>Restart the application</li>
                </ul>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Warning:</strong> The application will be briefly unavailable during the update process (1-2 minutes).
                    {% if not git_status.clean %}
                    <br><br>
                    <strong>Your working directory has uncommitted changes that may be overwritten!</strong>
                    {% endif %}
                </div>
                <p class="mb-0"><strong>Are you sure you want to proceed?</strong></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="startUpdate()">
                    <i class="fas fa-download"></i> Yes, Apply Update
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Update Progress Modal -->
<div class="modal fade" id="updateProgressModal" tabindex="-1" aria-labelledby="updateProgressModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="updateProgressModalLabel">
                    <i class="fas fa-sync fa-spin"></i> Updating System
                </h5>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <div class="progress" style="height: 30px;">
                        <div id="updateProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;">
                            <span id="updateProgressText">Starting update...</span>
                        </div>
                    </div>
                </div>
                <div id="updateSteps">
                    <div class="step-item" data-step="git_pull">
                        <i class="fas fa-circle text-muted"></i> <span>Git Pull</span>
                    </div>
                    <div class="step-item" data-step="install">
                        <i class="fas fa-circle text-muted"></i> <span>Install Dependencies</span>
                    </div>
                    <div class="step-item" data-step="migrate">
                        <i class="fas fa-circle text-muted"></i> <span>Run Migrations</span>
                    </div>
                    <div class="step-item" data-step="static">
                        <i class="fas fa-circle text-muted"></i> <span>Collect Static Files</span>
                    </div>
                    <div class="step-item" data-step="restart">
                        <i class="fas fa-circle text-muted"></i> <span>Restart Service</span>
                    </div>
                </div>
                <div id="updateComplete" style="display: none;" class="alert alert-success mt-3">
                    <i class="fas fa-check-circle"></i> <strong>Update completed successfully!</strong><br>
                    <small>The service is restarting. This page will reload automatically in a few seconds. It may take up to a minute for the new version to display.</small>
                </div>
                <div id="updateError" style="display: none;" class="alert alert-danger mt-3">
                    <i class="fas fa-exclamation-circle"></i> <strong>Update failed:</strong> <span id="updateErrorMessage"></span>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.step-item {
    padding: 8px 0;
    font-size: 14px;
}
.step-item i.fa-circle {
    font-size: 10px;
    margin-right: 8px;
}
.step-item i.fa-spinner {
    color: #0d6efd;
}
.step-item i.fa-check-circle {
    color: #198754;
}
.step-item i.fa-exclamation-circle {
    color: #dc3545;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
function showUpdateModal() {
    var modal = new bootstrap.Modal(document.getElementById('updateConfirmModal'));
    modal.show();
}

function startUpdate() {
    // Hide confirmation modal
    var confirmModal = bootstrap.Modal.getInstance(document.getElementById('updateConfirmModal'));
    confirmModal.hide();

    // Show progress modal
    var progressModal = new bootstrap.Modal(document.getElementById('updateProgressModal'));
    progressModal.show();

    // Get CSRF token
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // Start the update
    fetch('{% url "core:apply_update" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'started') {
            // Start polling for progress
            pollProgress();
        } else {
            showError('Failed to start update');
        }
    })
    .catch(error => {
        console.error('Error starting update:', error);
        showError('Failed to start update: ' + error.message);
    });
}

function pollProgress() {
    const pollInterval = setInterval(function() {
        fetch('{% url "core:update_progress_api" %}')
            .then(response => response.json())
            .then(data => {
                console.log('Progress:', data);
                updateProgressUI(data);

                if (data.status === 'completed') {
                    clearInterval(pollInterval);
                    showComplete();
                    // Reload page after 10 seconds to give service time to restart
                    setTimeout(function() {
                        location.reload();
                    }, 10000);
                } else if (data.status === 'failed') {
                    clearInterval(pollInterval);
                    showError(data.error || 'Unknown error');
                }
            })
            .catch(error => {
                console.error('Error polling progress:', error);
            });
    }, 1000); // Poll every second
}

function updateProgressUI(data) {
    const completed = data.steps_completed || [];
    const totalSteps = data.total_steps || 5;
    const currentStep = data.current_step || '';

    // Update progress bar
    const percent = (completed.length / totalSteps) * 100;
    document.getElementById('updateProgressBar').style.width = percent + '%';
    document.getElementById('updateProgressText').textContent =
        currentStep || `${completed.length} of ${totalSteps} steps complete`;

    // Update step icons
    const stepMap = {
        'Git Pull': 'git_pull',
        'Install Dependencies': 'install',
        'Run Migrations': 'migrate',
        'Collect Static Files': 'static',
        'Restart Service': 'restart'
    };

    // Mark completed steps
    completed.forEach(function(stepName) {
        const stepEl = document.querySelector('.step-item[data-step="' + stepMap[stepName] + '"]');
        if (stepEl) {
            const icon = stepEl.querySelector('i');
            icon.className = 'fas fa-check-circle';
        }
    });

    // Mark current step
    if (currentStep && stepMap[currentStep]) {
        const stepEl = document.querySelector('.step-item[data-step="' + stepMap[currentStep] + '"]');
        if (stepEl) {
            const icon = stepEl.querySelector('i');
            icon.className = 'fas fa-spinner fa-spin';
        }
    }
}

function showComplete() {
    document.getElementById('updateComplete').style.display = 'block';
    document.querySelector('#updateProgressModalLabel i').className = 'fas fa-check-circle text-success';
    document.getElementById('updateProgressBar').classList.remove('progress-bar-animated');
    document.getElementById('updateProgressBar').classList.add('bg-success');
    document.getElementById('updateProgressBar').style.width = '100%';
    document.getElementById('updateProgressText').textContent = 'Update complete!';
}

function showError(message) {
    document.getElementById('updateError').style.display = 'block';
    document.getElementById('updateErrorMessage').textContent = message;
    document.querySelector('#updateProgressModalLabel i').className = 'fas fa-exclamation-circle text-danger';
    document.getElementById('updateProgressBar').classList.remove('progress-bar-animated');
    document.getElementById('updateProgressBar').classList.add('bg-danger');
}

// Auto-refresh update status every 5 minutes
setInterval(function() {
    fetch('{% url "core:update_status_api" %}')
        .then(response => response.json())
        .then(data => {
            if (data.update_available && !{{ update_info.update_available|yesno:"true,false" }}) {
                // New update detected, reload page
                location.reload();
            }
        })
        .catch(error => console.error('Error checking update status:', error));
}, 300000); // 5 minutes
</script>
{% endblock %}

{% load static %}
<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{% csrf_token %}">
    <title>Edit Diagram - {{ diagram.title }}</title>

    <!-- Force browser to reload JavaScript by disabling cache -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <!-- Minimal CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" />

    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        #fullscreen-toolbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
        }

        #fullscreen-toolbar .title {
            color: white;
            font-size: 16px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #fullscreen-toolbar .title small {
            opacity: 0.8;
            font-size: 11px;
            font-weight: 400;
        }

        #fullscreen-toolbar .actions {
            display: flex;
            gap: 10px;
        }

        #fullscreen-toolbar button,
        #fullscreen-toolbar a {
            padding: 6px 16px;
            border-radius: 6px;
            border: none;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        #saveBtn {
            background: #10b981;
            color: white;
        }

        #saveBtn:hover:not(:disabled) {
            background: #059669;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        #saveBtn:disabled {
            background: #6b7280;
            cursor: not-allowed;
            opacity: 0.6;
        }

        #closeBtn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        #closeBtn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        #status {
            color: rgba(255, 255, 255, 0.9);
            font-size: 12px;
            margin-left: 20px;
        }

        #iframe-container {
            position: fixed;
            top: 50px;
            left: 0;
            right: 0;
            bottom: 0;
            background: #f5f5f5;
        }

        #drawio-iframe {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
        }
    </style>
</head>
<body>

<!-- Full-screen floating toolbar -->
<div id="fullscreen-toolbar">
    <div class="title">
        <i class="fas fa-edit"></i>
        <span>{{ diagram.title }}</span>
        <small>[Editor v3.0 Full-Screen]</small>
        <span id="status">Loading editor...</span>
    </div>
    <div class="actions">
        <button id="saveBtn" disabled>
            <i class="fas fa-save"></i> Save
        </button>
        <a href="{% url 'docs:diagram_detail' diagram.slug %}" id="closeBtn">
            <i class="fas fa-times"></i> Close
        </a>
    </div>
</div>

<!-- Full-screen iframe container -->
<div id="iframe-container">
    <iframe
        id="drawio-iframe"
        src="https://embed.diagrams.net/?embed=1&proto=json&spin=1&saveAndExit=0&noSaveBtn=1&ui=kennedy&libraries=1&noExitBtn=1&autosave=1&xml=1&format=xml"
        allow="camera; microphone; clipboard-read; clipboard-write"
        sandbox="allow-same-origin allow-scripts allow-forms allow-modals allow-popups"
        allowfullscreen>
    </iframe>
</div>

<!-- Store diagram XML in a script tag to avoid escaping issues -->
<script id="diagram-data" type="application/json">
{{ diagram.diagram_xml|default:""|safe }}
</script>

<script>
// Diagram Editor v3.0 - 2026-01-11 - Full-screen editor with floating toolbar
console.log('üîÑ Diagram Editor v3.0 loaded - Full-screen mode with floating toolbar');
(function() {
    const iframe = document.getElementById('drawio-iframe');
    const saveBtn = document.getElementById('saveBtn');
    const closeBtn = document.getElementById('closeBtn');
    const statusDiv = document.getElementById('status');
    const origin = 'https://embed.diagrams.net';

    // Get diagram XML from the script tag
    const diagramDataEl = document.getElementById('diagram-data');
    let currentDiagramXml = diagramDataEl ? diagramDataEl.textContent.trim() : '';
    let hasUnsavedChanges = false;
    let editorReady = false;
    let autoSaveInterval = null;
    let justSaved = false; // Track if we just saved to ignore immediate autosave events

    // Update status message
    function updateStatus(message, isError = false) {
        statusDiv.textContent = message;
        statusDiv.className = `text-center small mt-2 ${isError ? 'text-danger' : 'text-muted'}`;
    }

    // Send message to draw.io iframe
    function sendToDrawio(action, data = {}) {
        const message = JSON.stringify({action, ...data});
        console.log('Sending to draw.io:', action, data);
        iframe.contentWindow.postMessage(message, origin);
    }

    // Save diagram via AJAX
    function saveDiagram(forceSave = false, pngData = null) {
        console.log('saveDiagram() called, forceSave:', forceSave, 'hasUnsavedChanges:', hasUnsavedChanges, 'xml length:', currentDiagramXml.length, 'has PNG:', !!pngData);

        if (!forceSave && !hasUnsavedChanges) {
            console.log('No changes to save, aborting');
            updateStatus('No changes to save');
            return;
        }

        if (!currentDiagramXml || currentDiagramXml.length === 0) {
            console.error('No diagram XML to save');
            updateStatus('Error: No diagram data', true);
            return;
        }

        // CRITICAL FIX: Set justSaved flag IMMEDIATELY, before fetch starts
        // This prevents autosave events during the save process from setting hasUnsavedChanges
        justSaved = true;
        console.log('üîí justSaved flag set to true at START of save (prevents race condition)');

        // Store the XML length at time of save for comparison
        const savedXmlLength = currentDiagramXml.length;

        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        updateStatus('Saving...');
        console.log('Sending AJAX request to save diagram...');

        const payload = {
            diagram_xml: currentDiagramXml
        };

        // Include PNG export if available
        if (pngData) {
            payload.png_export = pngData;
            console.log('Including PNG export in save payload');
        }

        fetch('{% url "docs:diagram_save" diagram.pk %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(payload)
        })
        .then(response => {
            console.log('Save response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Save response data:', data);
            if (data.success) {
                hasUnsavedChanges = false;
                // justSaved already set at start of function
                updateStatus(`Saved successfully (v${data.version})`);
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<i class="fas fa-check"></i> Saved';
                console.log('‚úÖ Diagram saved successfully, version:', data.version);
                console.log('hasUnsavedChanges set to false, justSaved is true, save button disabled');

                // Important: Keep currentDiagramXml so next autosave won't trigger unsaved state
                // The currentDiagramXml already has the saved XML from the last autosave event
                console.log('Current XML preserved (length:', savedXmlLength, '), next autosave with minor changes will be ignored');

                // Re-enable button but show "Saved" for a moment
                setTimeout(() => {
                    saveBtn.innerHTML = '<i class="fas fa-save"></i> Save';
                    // Keep button disabled until actual changes are made
                    console.log('Button text reset to Save');
                }, 2000);

                // Auto-reset justSaved flag after 15 seconds (increased from 10)
                // This prevents autosave events from re-marking as unsaved right after save
                setTimeout(() => {
                    if (justSaved) {
                        justSaved = false;
                        console.log('üîì justSaved flag auto-reset after 15 seconds');
                    }
                }, 15000);
            } else {
                // Save failed - reset justSaved flag
                justSaved = false;
                console.log('Save failed, justSaved flag reset');
                throw new Error(data.error || 'Save failed');
            }
        })
        .catch(error => {
            console.error('Save error:', error);
            justSaved = false; // Reset flag on error
            updateStatus('Error: ' + error.message, true);
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="fas fa-save"></i> Save';
        });
    }

    // Check if iframe loaded
    iframe.addEventListener('load', function() {
        console.log('Draw.io iframe loaded successfully');
        updateStatus('Editor loading...');
    });

    iframe.addEventListener('error', function() {
        console.error('Draw.io iframe failed to load');
        updateStatus('Failed to load editor iframe', true);
    });

    // Timeout to detect if editor never loads
    const loadTimeout = setTimeout(() => {
        if (!editorReady) {
            updateStatus('Editor failed to load. Please refresh the page or check console for errors.', true);
            console.error('Draw.io editor timeout - no init message received after 15 seconds');
            console.log('Check browser console for CORS or CSP errors');
        }
    }, 15000); // 15 second timeout

    // Handle messages from draw.io
    window.addEventListener('message', function(evt) {
        if (evt.origin !== origin) return;

        let msg;
        try {
            msg = JSON.parse(evt.data);
        } catch (e) {
            return;
        }

        console.log('Draw.io message:', msg.event);

        switch (msg.event) {
            case 'init':
                clearTimeout(loadTimeout);
                editorReady = true;
                console.log('Editor ready, diagram XML length:', currentDiagramXml.length);
                updateStatus('Editor ready');

                // Configure draw.io to enable autosave events
                console.log('Configuring draw.io with autosave enabled...');
                sendToDrawio('configure', {
                    autosave: 1,
                    enableCustomLibraries: true
                });

                // Enable save button now that editor is ready
                saveBtn.disabled = false;
                console.log('Save button enabled (editor ready)');

                // Load existing diagram if available, otherwise load blank diagram
                if (currentDiagramXml && currentDiagramXml.length > 0) {
                    console.log('Loading existing diagram...');
                    sendToDrawio('load', {xml: currentDiagramXml, autosave: 1});
                    updateStatus('Loading diagram...');
                } else {
                    console.log('No existing diagram, loading blank canvas...');
                    // Load a blank diagram to start the editor
                    const blankDiagram = '<mxGraphModel><root><mxCell id="0"/><mxCell id="1" parent="0"/></root></mxGraphModel>';
                    sendToDrawio('load', {xml: blankDiagram, autosave: 1});
                    updateStatus('Ready to draw');
                }

                // Start auto-save polling (as fallback if events don't work)
                autoSaveInterval = setInterval(() => {
                    if (hasUnsavedChanges) {
                        console.log('Auto-save interval triggered');
                        sendToDrawio('export', {format: 'xmlpng'});
                    }
                }, 60000); // Auto-save every 60 seconds
                break;

            case 'configure':
                console.log('Configure event received - autosave should now be enabled');
                break;

            case 'load':
                console.log('Diagram loaded event received');
                updateStatus('Diagram loaded');
                break;

            case 'merge':
                // Merge event may contain XML
                console.log('Merge event received');
                if (msg.xml) {
                    console.log('Merge event has XML, length:', msg.xml.length);
                    if (msg.xml !== currentDiagramXml) {
                        currentDiagramXml = msg.xml;
                        hasUnsavedChanges = true;
                        saveBtn.disabled = false;
                        updateStatus('Unsaved changes (from merge)');
                    }
                }
                break;

            case 'autosave':
                // Diagram changed - this fires whenever user makes a change
                console.log('Autosave event received, xml length:', msg.xml ? msg.xml.length : 0, 'justSaved:', justSaved, 'hasUnsavedChanges:', hasUnsavedChanges);
                if (msg.xml) {
                    // If we just saved, ignore autosave events with minor changes
                    // (draw.io sends autosave events after PNG export with metadata changes)
                    if (justSaved) {
                        const lengthDiff = Math.abs(msg.xml.length - currentDiagramXml.length);
                        console.log('üîí Just saved - checking autosave: length diff =', lengthDiff, 'bytes');

                        // INCREASED THRESHOLD: Ignore changes up to 200 bytes (was 100)
                        // PNG export often adds metadata that changes XML by 50-150 bytes
                        if (lengthDiff < 200) {
                            // Very minor change - probably just metadata from export
                            console.log('‚úì Ignoring minor autosave after save (diff:', lengthDiff, 'bytes < 200 threshold)');
                            currentDiagramXml = msg.xml; // Update XML but don't mark as unsaved
                            // Don't reset justSaved flag - let timer handle it
                            return;
                        } else {
                            // Significant change - user continued editing
                            console.log('‚úó Significant change detected (diff:', lengthDiff, 'bytes >= 200 threshold) - user made new edits');
                            justSaved = false; // Reset flag and continue to mark as changed
                        }
                    }

                    // Only mark as changed if XML actually changed (not just initial load)
                    if (msg.xml !== currentDiagramXml) {
                        console.log('XML changed, marking as unsaved (prev:', currentDiagramXml.length, 'new:', msg.xml.length, ')');
                        currentDiagramXml = msg.xml;
                        hasUnsavedChanges = true;
                        saveBtn.disabled = false;
                        updateStatus('Unsaved changes');
                    } else {
                        console.log('XML unchanged (exact match), ignoring autosave event');
                    }
                } else {
                    console.warn('Autosave event missing xml data');
                }
                break;

            case 'save':
                // User clicked internal save (Ctrl+S or File > Save in draw.io)
                console.log('Save event received from draw.io');
                if (msg.xml) {
                    currentDiagramXml = msg.xml;
                    hasUnsavedChanges = true;
                    saveDiagram(true); // Force save
                } else {
                    console.warn('Save event missing xml data');
                }
                break;

            case 'export':
                // Export result (for manual save or auto-save)
                console.log('Export event received, format:', msg.format);
                console.log('Export data type:', typeof msg.data, 'length:', msg.data ? msg.data.length : 0);
                console.log('waitingForPngExport:', waitingForPngExport);

                // Handle PNG export (for preview generation)
                if (msg.format === 'png' || msg.format === 'xmlpng') {
                    if (waitingForPngExport) {
                        if (msg.data) {
                            console.log('‚úì PNG export received, length:', msg.data.length, 'starts with:', msg.data.substring(0, 50));
                            pngExportData = msg.data; // Store base64 PNG data
                            waitingForPngExport = false;

                            // Now save with PNG data
                            console.log('Saving diagram with PNG export...');
                            saveDiagram(true, pngExportData);
                            return;
                        } else {
                            console.error('PNG export format received but no data!');
                            waitingForPngExport = false;
                            // Save without PNG
                            saveDiagram(true, null);
                            return;
                        }
                    } else {
                        console.log('PNG export received but not waiting for it (ignoring)');
                    }
                }

                // Handle XML export (legacy/fallback)
                console.log('Export message keys:', Object.keys(msg));
                console.log('Export data available:', {
                    hasData: !!msg.data,
                    hasXml: !!msg.xml,
                    dataType: typeof msg.data,
                    xmlType: typeof msg.xml
                });

                let xmlData = null;

                if (msg.xml && typeof msg.xml === 'string') {
                    // Direct XML available
                    xmlData = msg.xml;
                    console.log('Using msg.xml, length:', xmlData.length);
                } else if (msg.data && typeof msg.data === 'string') {
                    // Check if data is XML (starts with <)
                    if (msg.data.trim().startsWith('<')) {
                        xmlData = msg.data;
                        console.log('Using msg.data (XML string), length:', xmlData.length);
                    }
                }

                if (xmlData && xmlData.length > 0) {
                    console.log('Valid XML export received, length:', xmlData.length);
                    currentDiagramXml = xmlData;
                    hasUnsavedChanges = true;
                    saveDiagram(true);
                } else {
                    console.error('Export event missing xml data');
                    console.error('Full message:', msg);
                    updateStatus('Failed to export diagram data', true);
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = '<i class="fas fa-save"></i> Save';
                }
                break;

            case 'exit':
                // User wants to exit
                if (hasUnsavedChanges) {
                    if (confirm('You have unsaved changes. Save before closing?')) {
                        saveDiagram();
                        setTimeout(() => {
                            window.location.href = '{% url "docs:diagram_detail" diagram.slug %}';
                        }, 1000);
                    } else {
                        window.location.href = '{% url "docs:diagram_detail" diagram.slug %}';
                    }
                } else {
                    window.location.href = '{% url "docs:diagram_detail" diagram.slug %}';
                }
                break;
        }
    });

    // Track if we're waiting for PNG export
    let waitingForPngExport = false;
    let pngExportData = null;

    // Save button click
    saveBtn.addEventListener('click', function() {
        console.log('Save button clicked, editorReady:', editorReady);
        if (editorReady) {
            // If autosave has captured XML, request PNG export then save
            if (currentDiagramXml && currentDiagramXml.length > 100) {
                console.log('XML available (length:', currentDiagramXml.length, ')');
                console.log('Requesting PNG export for preview...');
                updateStatus('Generating preview...');
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Exporting...';

                // Request PNG export
                waitingForPngExport = true;
                pngExportData = null;
                sendToDrawio('export', {format: 'png'});

                // Fallback: Save without PNG after 3 seconds if export fails
                setTimeout(() => {
                    if (waitingForPngExport) {
                        console.log('PNG export timeout, saving without preview');
                        waitingForPngExport = false;
                        saveDiagram(true, null);
                    }
                }, 3000);
            } else {
                // No XML captured yet - this shouldn't happen
                console.error('No XML cached - cannot save');
                updateStatus('Error: No diagram data', true);
            }
        } else {
            console.error('Cannot save - editor not ready');
            updateStatus('Editor not ready yet', true);
        }
    });

    // Close button click handler - bypasses draw.io iframe beforeunload
    closeBtn.addEventListener('click', function(e) {
        e.preventDefault(); // Prevent default navigation
        console.log('üö™ Close button clicked - hasUnsavedChanges:', hasUnsavedChanges, 'justSaved:', justSaved);

        if (hasUnsavedChanges) {
            // Show our own confirmation dialog
            if (confirm('You have unsaved changes. Do you want to save before closing?')) {
                console.log('User chose to save before closing');
                // Save and then close after save completes
                const originalUrl = closeBtn.href;
                saveDiagram(true);

                // Wait for save to complete, then navigate
                setTimeout(() => {
                    console.log('Navigating after save delay...');
                    // Remove iframe before navigation to prevent its beforeunload
                    console.log('üóëÔ∏è Removing draw.io iframe to prevent its beforeunload warning');
                    iframe.remove();
                    window.location.href = originalUrl;
                }, 1500);
            } else {
                console.log('User chose to discard changes and close');
                // Discard changes and close immediately
                console.log('üóëÔ∏è Removing draw.io iframe to prevent its beforeunload warning');
                iframe.remove();
                window.location.href = closeBtn.href;
            }
        } else {
            console.log('‚úÖ No unsaved changes - navigating immediately');
            // CRITICAL FIX: Remove draw.io iframe from DOM before navigating
            // The iframe has its own beforeunload handler that we can't control
            // Removing it prevents the iframe's beforeunload from firing
            console.log('üóëÔ∏è Removing draw.io iframe to prevent its beforeunload warning');
            iframe.remove();

            // Small delay to ensure iframe removal is processed
            setTimeout(() => {
                console.log('üìç Navigating after iframe removal...');
                window.location.href = closeBtn.href;
            }, 50);
        }
    });

    // Warn about unsaved changes on page unload
    window.addEventListener('beforeunload', function(e) {
        console.log('beforeunload event - hasUnsavedChanges:', hasUnsavedChanges, 'justSaved:', justSaved);
        if (hasUnsavedChanges) {
            console.warn('‚ö†Ô∏è Showing unsaved changes warning');
            e.preventDefault();
            e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
            return e.returnValue;
        } else {
            console.log('‚úÖ No unsaved changes, allowing navigation without warning');
            // CRITICAL: Explicitly delete returnValue and return undefined
            // This ensures browsers don't show any warning dialog
            delete e.returnValue;
            return undefined;
        }
    });

    // Clean up on unload
    window.addEventListener('unload', function() {
        if (autoSaveInterval) {
            clearInterval(autoSaveInterval);
        }
    });
})();
</script>

</body>
</html>

{% extends "base.html" %}

{% block title %}{{ action }} Document - HuduGlue{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
<style>
    #markdown-editor-container {
        display: none;
    }
    .tox-tinymce {
        border: 1px solid #dee2e6 !important;
        border-radius: 0.375rem;
    }
    .select2-container {
        width: 100% !important;
    }
    /* Adaptive editor background based on theme */
    [data-theme="default"] #quill-editor,
    [data-theme="purple"] #quill-editor,
    [data-theme="green"] #quill-editor,
    [data-theme="ocean"] #quill-editor,
    [data-theme="sunset"] #quill-editor,
    [data-theme="solarized"] #quill-editor {
        background-color: #ffffff !important;
        color: #000000 !important;
    }
    [data-theme="dark"] #quill-editor,
    [data-theme="dracula"] #quill-editor,
    [data-theme="monokai"] #quill-editor,
    [data-theme="nord"] #quill-editor {
        background-color: #2b3035 !important;
        color: #dee2e6 !important;
    }

    /* Quill container styling for dark themes */
    [data-theme="dark"] .ql-container,
    [data-theme="dracula"] .ql-container,
    [data-theme="monokai"] .ql-container,
    [data-theme="nord"] .ql-container {
        background-color: #2b3035 !important;
        border-color: #495057 !important;
    }

    [data-theme="dark"] .ql-editor,
    [data-theme="dracula"] .ql-editor,
    [data-theme="monokai"] .ql-editor,
    [data-theme="nord"] .ql-editor {
        color: #dee2e6 !important;
    }

    [data-theme="dark"] .ql-editor.ql-blank::before,
    [data-theme="dracula"] .ql-editor.ql-blank::before,
    [data-theme="monokai"] .ql-editor.ql-blank::before,
    [data-theme="nord"] .ql-editor.ql-blank::before {
        color: #6c757d !important;
    }
    /* Quill toolbar styling for dark themes */
    [data-theme="dark"] .ql-toolbar,
    [data-theme="dracula"] .ql-toolbar,
    [data-theme="monokai"] .ql-toolbar,
    [data-theme="nord"] .ql-toolbar {
        background-color: #f8f9fa !important;
        border-color: #dee2e6 !important;
    }
    [data-theme="dark"] .ql-toolbar .ql-stroke,
    [data-theme="dracula"] .ql-toolbar .ql-stroke,
    [data-theme="monokai"] .ql-toolbar .ql-stroke,
    [data-theme="nord"] .ql-toolbar .ql-stroke {
        stroke: #000000 !important;
    }
    [data-theme="dark"] .ql-toolbar .ql-fill,
    [data-theme="dracula"] .ql-toolbar .ql-fill,
    [data-theme="monokai"] .ql-toolbar .ql-fill,
    [data-theme="nord"] .ql-toolbar .ql-fill {
        fill: #000000 !important;
    }
    [data-theme="dark"] .ql-toolbar .ql-picker-label,
    [data-theme="dracula"] .ql-toolbar .ql-picker-label,
    [data-theme="monokai"] .ql-toolbar .ql-picker-label,
    [data-theme="nord"] .ql-toolbar .ql-picker-label {
        color: #000000 !important;
    }
    /* Select2 dark mode styling */
    [data-theme="dark"] .select2-container--bootstrap-5 .select2-selection,
    [data-theme="dracula"] .select2-container--bootstrap-5 .select2-selection,
    [data-theme="monokai"] .select2-container--bootstrap-5 .select2-selection,
    [data-theme="nord"] .select2-container--bootstrap-5 .select2-selection {
        background-color: #2b2b2b !important;
        border-color: #495057 !important;
        color: #ffffff !important;
    }
    [data-theme="dark"] .select2-container--bootstrap-5 .select2-dropdown,
    [data-theme="dracula"] .select2-container--bootstrap-5 .select2-dropdown,
    [data-theme="monokai"] .select2-container--bootstrap-5 .select2-dropdown,
    [data-theme="nord"] .select2-container--bootstrap-5 .select2-dropdown {
        background-color: #2b2b2b !important;
        border-color: #495057 !important;
    }

    /* Hide the actual file input, we'll use the drop zone */
    #document-file {
        display: none;
    }

    /* Drop zone styling */
    #drop-zone:hover {
        background-color: rgba(13, 110, 253, 0.05);
    }
    [data-theme="dark"] .select2-container--bootstrap-5 .select2-results__option,
    [data-theme="dracula"] .select2-container--bootstrap-5 .select2-results__option,
    [data-theme="monokai"] .select2-container--bootstrap-5 .select2-results__option,
    [data-theme="nord"] .select2-container--bootstrap-5 .select2-results__option {
        color: #ffffff !important;
    }
    [data-theme="dark"] .select2-container--bootstrap-5 .select2-results__option--highlighted,
    [data-theme="dracula"] .select2-container--bootstrap-5 .select2-results__option--highlighted,
    [data-theme="monokai"] .select2-container--bootstrap-5 .select2-results__option--highlighted,
    [data-theme="nord"] .select2-container--bootstrap-5 .select2-results__option--highlighted {
        background-color: #375a7f !important;
        color: #ffffff !important;
    }
    [data-theme="dark"] .select2-container--bootstrap-5 .select2-selection__choice,
    [data-theme="dracula"] .select2-container--bootstrap-5 .select2-selection__choice,
    [data-theme="monokai"] .select2-container--bootstrap-5 .select2-selection__choice,
    [data-theme="nord"] .select2-container--bootstrap-5 .select2-selection__choice {
        background-color: #375a7f !important;
        border-color: #2a4763 !important;
        color: #ffffff !important;
    }
</style>
{% endblock %}

{% block content %}
{% include 'includes/org_selector_warning.html' %}

<div class="row">
    <div class="col-md-10 offset-md-1">
        <div class="card">
            <div class="card-header">
                <h3 class="mb-0"><i class="fas fa-file-alt"></i> {{ action }} Document</h3>
            </div>
            <div class="card-body">
                <div class="alert alert-info alert-dismissible fade show" role="alert">
                    <i class="fas fa-info-circle"></i> <strong>Upload Files:</strong>
                    Select <strong>"Uploaded File"</strong> from the Editor dropdown below to upload PDFs, images, Word/Excel documents, and other files (max 50MB).
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>

                <form method="post" id="document-form" enctype="multipart/form-data">
                    {% csrf_token %}

                    {% if form.non_field_errors %}
                    <div class="alert alert-danger" role="alert">
                        {{ form.non_field_errors }}
                    </div>
                    {% endif %}

                    {% if action == 'Create' and templates %}
                    <div class="alert alert-info">
                        <i class="fas fa-file-alt"></i> <strong>Start from Template:</strong>
                        <select class="form-select form-select-sm d-inline-block w-auto ms-2" id="template-selector">
                            <option value="">-- Select a template --</option>
                            {% for template in templates %}
                            <option value="{{ template.id }}" {% if selected_template and selected_template.id == template.id %}selected{% endif %}>
                                {{ template.title }}
                            </option>
                            {% endfor %}
                        </select>
                        <button type="button" class="btn btn-sm btn-primary ms-2" onclick="loadTemplate()">
                            <i class="fas fa-download"></i> Load Template
                        </button>
                    </div>
                    {% endif %}

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.title.id_for_label }}" class="form-label">Title *</label>
                            {{ form.title }}
                            {% if form.title.errors %}<div class="invalid-feedback d-block">{{ form.title.errors }}</div>{% endif %}
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="{{ form.content_type.id_for_label }}" class="form-label">
                                Editor * <i class="fas fa-question-circle text-muted" title="Select 'Uploaded File' to upload PDFs, images, documents"></i>
                            </label>
                            {{ form.content_type }}
                            {% if form.content_type.help_text %}
                            <small class="form-text text-muted">{{ form.content_type.help_text }}</small>
                            {% endif %}
                            {% if form.content_type.errors %}<div class="invalid-feedback d-block">{{ form.content_type.errors }}</div>{% endif %}
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="{{ form.category.id_for_label }}" class="form-label">Category</label>
                            {{ form.category }}
                            {% if form.category.errors %}<div class="invalid-feedback d-block">{{ form.category.errors }}</div>{% endif %}
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="editor-container" class="form-label">Content *</label>

                        <!-- WYSIWYG Editor (TinyMCE) -->
                        <div id="tinymce-editor-container">
                            {{ form.body }}
                        </div>

                        <!-- Markdown Editor -->
                        <div id="markdown-editor-container">
                            <textarea id="markdown-textarea" class="form-control" rows="20"></textarea>
                        </div>

                        <!-- File Upload -->
                        <div id="file-upload-container" style="display: none;">
                            <div id="drop-zone" class="border border-2 border-dashed rounded p-5 text-center" style="cursor: pointer; transition: all 0.3s;">
                                <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">Drag & Drop or Click to Upload</h5>
                                <p class="text-muted small mb-3">Supported: PDF, Word, Excel, PowerPoint, Images, ZIP (max 50MB)</p>
                                {{ form.file }}
                                <div id="file-info" class="mt-3" style="display: none;">
                                    <i class="fas fa-file me-2"></i>
                                    <span id="file-name"></span>
                                    <span id="file-size" class="text-muted small ms-2"></span>
                                    <button type="button" class="btn btn-sm btn-danger ms-2" id="remove-file">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        {% if form.body.errors %}
                        <div class="invalid-feedback d-block">{{ form.body.errors }}</div>
                        {% endif %}
                        {% if form.file.errors %}
                        <div class="invalid-feedback d-block">{{ form.file.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="{{ form.tags.id_for_label }}" class="form-label">Tags</label>
                            {{ form.tags }}
                            {% if form.tags.errors %}<div class="invalid-feedback d-block">{{ form.tags.errors }}</div>{% endif %}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Options</label>
                            <div class="form-check">
                                {{ form.is_published }}
                                <label class="form-check-label" for="{{ form.is_published.id_for_label }}">Published</label>
                            </div>
                            <div class="form-check">
                                {{ form.is_template }}
                                <label class="form-check-label" for="{{ form.is_template.id_for_label }}">Template</label>
                            </div>
                            <div class="form-check">
                                {{ form.is_archived }}
                                <label class="form-check-label" for="{{ form.is_archived.id_for_label }}">Archived</label>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between gap-2">
                        <div>
                            {% if action == 'Edit' %}
                            <button type="button" class="btn btn-info" id="ai-enhance-btn" data-bs-toggle="modal" data-bs-target="#aiEnhanceModal">
                                <i class="fas fa-magic"></i> Enhance with AI
                            </button>
                            {% endif %}
                            <a href="{% url 'docs:ai_assistant' %}" class="btn btn-outline-info">
                                <i class="fas fa-robot"></i> AI Assistant
                            </a>
                        </div>
                        <div class="d-flex gap-2">
                            <a href="{% if document %}{% url 'docs:document_detail' document.slug %}{% else %}{% url 'docs:document_list' %}{% endif %}" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Cancel
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> {{ action }} Document
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- AI Enhancement Modal -->
<div class="modal fade" id="aiEnhanceModal" tabindex="-1" aria-labelledby="aiEnhanceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="aiEnhanceModalLabel"><i class="fas fa-magic"></i> Enhance Documentation with AI</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted">Select how you'd like AI to enhance your documentation:</p>

                <!-- Output Format Selector -->
                <div class="card mb-3 bg-light">
                    <div class="card-body py-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-palette me-2"></i>
                                <strong>Output Format:</strong>
                            </div>
                            <div class="btn-group btn-group-sm" role="group" aria-label="Output format">
                                <input type="radio" class="btn-check" name="outputFormat" id="formatMarkdown" value="markdown" checked autocomplete="off">
                                <label class="btn btn-outline-primary" for="formatMarkdown">
                                    <i class="fab fa-markdown"></i> Markdown
                                </label>
                                <input type="radio" class="btn-check" name="outputFormat" id="formatHtml" value="html" autocomplete="off">
                                <label class="btn btn-outline-success" for="formatHtml">
                                    <i class="fab fa-html5"></i> Rich HTML
                                </label>
                            </div>
                        </div>
                        <small class="text-muted d-block mt-2">
                            <i class="fas fa-info-circle"></i>
                            <span id="formatHelp">Clean, portable format - great for editing</span>
                        </small>
                    </div>
                </div>

                <div class="list-group mb-3">
                    <button type="button" class="list-group-item list-group-item-action enhancement-option" data-type="grammar">
                        <div class="d-flex w-100 align-items-center">
                            <i class="fas fa-spell-check fa-2x me-3 text-primary"></i>
                            <div>
                                <h6 class="mb-1">Fix Grammar & Spelling</h6>
                                <p class="mb-0 small text-muted">Improve grammar, spelling, and punctuation while maintaining structure</p>
                            </div>
                        </div>
                    </button>
                    <button type="button" class="list-group-item list-group-item-action enhancement-option" data-type="expand">
                        <div class="d-flex w-100 align-items-center">
                            <i class="fas fa-expand-arrows-alt fa-2x me-3 text-success"></i>
                            <div>
                                <h6 class="mb-1">Expand & Add Details</h6>
                                <p class="mb-0 small text-muted">Add more details, examples, and best practices</p>
                            </div>
                        </div>
                    </button>
                    <button type="button" class="list-group-item list-group-item-action enhancement-option" data-type="simplify">
                        <div class="d-flex w-100 align-items-center">
                            <i class="fas fa-compress-arrows-alt fa-2x me-3 text-info"></i>
                            <div>
                                <h6 class="mb-1">Simplify Language</h6>
                                <p class="mb-0 small text-muted">Make it easier to read while maintaining technical accuracy</p>
                            </div>
                        </div>
                    </button>
                    <button type="button" class="list-group-item list-group-item-action enhancement-option" data-type="technical">
                        <div class="d-flex w-100 align-items-center">
                            <i class="fas fa-cogs fa-2x me-3 text-warning"></i>
                            <div>
                                <h6 class="mb-1">Add Technical Details</h6>
                                <p class="mb-0 small text-muted">Enhance with more technical specifications and implementation notes</p>
                            </div>
                        </div>
                    </button>
                    <button type="button" class="list-group-item list-group-item-action enhancement-option" data-type="consistency">
                        <div class="d-flex w-100 align-items-center">
                            <i class="fas fa-balance-scale fa-2x me-3 text-secondary"></i>
                            <div>
                                <h6 class="mb-1">Improve Consistency</h6>
                                <p class="mb-0 small text-muted">Fix inconsistencies in terminology, formatting, and structure</p>
                            </div>
                        </div>
                    </button>
                </div>

                <div id="ai-enhance-loading" class="text-center" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Enhancing...</span>
                    </div>
                    <p class="mt-2">Enhancing documentation with AI... This may take 10-20 seconds.</p>
                </div>

                <div id="ai-enhance-result" class="alert alert-success" style="display: none;">
                    <i class="fas fa-check-circle"></i> Enhancement complete! Your content has been updated.
                    <div id="ai-changes-made" class="mt-2 small"></div>
                </div>

                <div id="ai-enhance-error" class="alert alert-danger" style="display: none;">
                    <i class="fas fa-exclamation-circle"></i> <span id="ai-enhance-error-message"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<link href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    const contentTypeSelect = document.getElementById('content-type-select');
    const bodyTextarea = document.getElementById('document-body');
    const quillContainer = document.getElementById('tinymce-editor-container');
    const markdownContainer = document.getElementById('markdown-editor-container');
    const fileUploadContainer = document.getElementById('file-upload-container');
    const markdownTextarea = document.getElementById('markdown-textarea');
    const form = document.getElementById('document-form');
    const fileInput = document.getElementById('document-file');
    const dropZone = document.getElementById('drop-zone');
    const fileInfo = document.getElementById('file-info');
    const fileName = document.getElementById('file-name');
    const fileSize = document.getElementById('file-size');
    const removeFileBtn = document.getElementById('remove-file');

    let quillEditor = null;

    // Initialize Quill
    function initQuill() {
        if (quillEditor) return;

        // Create editor container for Quill
        const editorDiv = document.createElement('div');
        editorDiv.id = 'quill-editor';
        editorDiv.style.height = '500px';
        // Background color is controlled by CSS based on theme

        // Insert before the textarea
        bodyTextarea.parentNode.insertBefore(editorDiv, bodyTextarea);
        bodyTextarea.style.display = 'none';
        bodyTextarea.removeAttribute('required');  // Remove required to prevent validation on hidden field

        quillEditor = new Quill('#quill-editor', {
            theme: 'snow',
            placeholder: 'Write your document content here...',
            modules: {
                toolbar: [
                    [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                    [{ 'font': [] }],
                    [{ 'size': ['small', false, 'large', 'huge'] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'color': [] }, { 'background': [] }],
                    [{ 'script': 'sub'}, { 'script': 'super' }],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    [{ 'indent': '-1'}, { 'indent': '+1' }],
                    [{ 'direction': 'rtl' }],
                    [{ 'align': [] }],
                    ['blockquote', 'code-block'],
                    ['link', 'image', 'video'],
                    ['clean']
                ],
                clipboard: {
                    // Preserve more formatting when pasting
                    matchVisual: true
                }
            }
        });

        // Set initial content if exists
        if (bodyTextarea.value) {
            quillEditor.root.innerHTML = bodyTextarea.value;
        }
    }

    // Toggle editor based on content type
    function toggleEditor() {
        const contentType = contentTypeSelect.value;

        if (contentType === 'html') {
            // Show WYSIWYG
            quillContainer.style.display = 'block';
            markdownContainer.style.display = 'none';
            fileUploadContainer.style.display = 'none';

            if (!quillEditor) {
                initQuill();
            } else {
                document.getElementById('quill-editor').style.display = 'block';
            }
        } else if (contentType === 'markdown') {
            // Show Markdown textarea
            quillContainer.style.display = 'none';
            markdownContainer.style.display = 'block';
            fileUploadContainer.style.display = 'none';

            // Load existing content into markdown textarea if not already loaded
            if (!markdownTextarea.value && bodyTextarea.value) {
                markdownTextarea.value = bodyTextarea.value;
            }

            // Hide Quill if it exists
            if (quillEditor) {
                document.getElementById('quill-editor').style.display = 'none';
            }
        } else if (contentType === 'file') {
            // Show File Upload
            quillContainer.style.display = 'none';
            markdownContainer.style.display = 'none';
            fileUploadContainer.style.display = 'block';

            // Hide Quill if it exists
            if (quillEditor) {
                document.getElementById('quill-editor').style.display = 'none';
            }
        }
    }

    // Initialize on page load
    toggleEditor();

    // Listen for content type changes
    contentTypeSelect.addEventListener('change', toggleEditor);

    // File upload drag and drop functionality
    if (dropZone && fileInput) {
        // Make drop zone clickable
        dropZone.addEventListener('click', function(e) {
            if (e.target !== removeFileBtn && !e.target.closest('#remove-file')) {
                fileInput.click();
            }
        });

        // File input change handler
        fileInput.addEventListener('change', function(e) {
            if (this.files && this.files[0]) {
                displayFileInfo(this.files[0]);
            }
        });

        // Drag and drop handlers
        dropZone.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
            this.style.borderColor = '#0d6efd';
            this.style.backgroundColor = 'rgba(13, 110, 253, 0.1)';
        });

        dropZone.addEventListener('dragleave', function(e) {
            e.preventDefault();
            e.stopPropagation();
            this.style.borderColor = '#dee2e6';
            this.style.backgroundColor = 'transparent';
        });

        dropZone.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            this.style.borderColor = '#dee2e6';
            this.style.backgroundColor = 'transparent';

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                displayFileInfo(files[0]);
            }
        });

        // Remove file handler
        if (removeFileBtn) {
            removeFileBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                fileInput.value = '';
                fileInfo.style.display = 'none';
            });
        }
    }

    // Display file info
    function displayFileInfo(file) {
        fileName.textContent = file.name;
        fileSize.textContent = '(' + formatFileSize(file.size) + ')';
        fileInfo.style.display = 'block';
    }

    // Format file size
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    // Before form submit, ensure content is synced and validate
    form.addEventListener('submit', function(e) {
        const contentType = contentTypeSelect.value;

        // Sync content from visible editor to hidden textarea
        if (contentType === 'html' && quillEditor) {
            bodyTextarea.value = quillEditor.root.innerHTML;
        } else if (contentType === 'markdown') {
            bodyTextarea.value = markdownTextarea.value;
        }

        // Validate based on content type
        if (contentType === 'file') {
            // Validate file is selected
            if (!fileInput.files || fileInput.files.length === 0) {
                e.preventDefault();
                alert('Please select a file to upload.');
                return false;
            }

            // Validate file size (50MB max)
            const maxSize = 50 * 1024 * 1024; // 50MB
            if (fileInput.files[0].size > maxSize) {
                e.preventDefault();
                alert('File size must be less than 50MB.');
                return false;
            }
        } else {
            // Validate that content is not empty for HTML/Markdown
            const content = bodyTextarea.value.trim();
            if (!content || content === '<p><br></p>') {
                e.preventDefault();
                alert('Please enter document content before submitting.');
                return false;
            }
        }
    });

    // Auto-generate slug from title
    const titleInput = document.getElementById('{{ form.title.id_for_label }}');
    const slugInput = document.getElementById('{{ form.slug.id_for_label }}');

    if (titleInput && slugInput && !slugInput.value) {
        titleInput.addEventListener('input', function() {
            const slug = this.value
                .toLowerCase()
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/^-+|-+$/g, '');
            slugInput.value = slug;
        });
    }

    // Load template function
    function loadTemplate() {
        const templateSelector = document.getElementById('template-selector');
        const templateId = templateSelector.value;

        if (templateId) {
            window.location.href = '?template=' + templateId;
        } else {
            alert('Please select a template first.');
        }
    }

    // Initialize Select2 for tags multi-select
    $(document).ready(function() {
        $('#{{ form.tags.id_for_label }}').select2({
            theme: 'bootstrap-5',
            placeholder: 'Select tags...',
            allowClear: true,
            width: '100%'
        });
    });

    // AI Enhancement functionality
    document.querySelectorAll('.enhancement-option').forEach(button => {
        button.addEventListener('click', function() {
            const enhancementType = this.dataset.type;
            enhanceWithAI(enhancementType);
        });
    });

    // Format selector help text
    document.querySelectorAll('input[name="outputFormat"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const helpText = document.getElementById('formatHelp');
            if (this.value === 'html') {
                helpText.innerHTML = '<i class="fas fa-paint-brush"></i> Rich, styled HTML with Bootstrap classes and icons';
            } else {
                helpText.innerHTML = '<i class="fas fa-file-alt"></i> Clean, portable format - great for editing';
            }
        });
    });

    function enhanceWithAI(enhancementType) {
        // Get current content
        const contentType = document.getElementById('{{ form.content_type.id_for_label }}').value;
        const title = document.getElementById('{{ form.title.id_for_label }}').value;
        let content = '';

        if (contentType === 'html') {
            content = quillEditor ? quillEditor.root.innerHTML : '';
        } else if (contentType === 'markdown') {
            content = markdownTextarea ? markdownTextarea.value : '';
        } else {
            alert('AI enhancement is only available for HTML and Markdown content.');
            return;
        }

        if (!content || content.trim() === '' || content === '<p><br></p>') {
            alert('Please add some content before enhancing with AI.');
            return;
        }

        // Get selected output format
        const outputFormat = document.querySelector('input[name="outputFormat"]:checked').value;

        // Show loading
        document.getElementById('ai-enhance-loading').style.display = 'block';
        document.getElementById('ai-enhance-result').style.display = 'none';
        document.getElementById('ai-enhance-error').style.display = 'none';
        document.querySelectorAll('.enhancement-option').forEach(btn => btn.disabled = true);

        // Call API
        fetch('{% url "docs:ai_enhance" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                title: title,
                content: content,
                enhancement_type: enhancementType,
                output_format: outputFormat
            })
        })
        .then(response => response.json())
        .then(result => {
            document.getElementById('ai-enhance-loading').style.display = 'none';
            document.querySelectorAll('.enhancement-option').forEach(btn => btn.disabled = false);

            if (result.success) {
                // Update content
                if (contentType === 'html' && quillEditor) {
                    quillEditor.root.innerHTML = result.content;
                } else if (contentType === 'markdown' && markdownTextarea) {
                    markdownTextarea.value = result.content;
                }

                // Update title if changed
                if (result.title && result.title !== title) {
                    document.getElementById('{{ form.title.id_for_label }}').value = result.title;
                }

                // Show success message
                const resultDiv = document.getElementById('ai-enhance-result');
                resultDiv.style.display = 'block';

                if (result.changes_made && result.changes_made.length > 0) {
                    const changesDiv = document.getElementById('ai-changes-made');
                    changesDiv.innerHTML = '<strong>Changes made:</strong><ul class="mb-0">' +
                        result.changes_made.map(change => '<li>' + change + '</li>').join('') +
                        '</ul>';
                }

                // Auto-close modal after 3 seconds
                setTimeout(() => {
                    bootstrap.Modal.getInstance(document.getElementById('aiEnhanceModal')).hide();
                }, 3000);
            } else {
                // Show error
                document.getElementById('ai-enhance-error-message').textContent = result.error || 'Failed to enhance documentation';
                document.getElementById('ai-enhance-error').style.display = 'block';
            }
        })
        .catch(error => {
            document.getElementById('ai-enhance-loading').style.display = 'none';
            document.querySelectorAll('.enhancement-option').forEach(btn => btn.disabled = false);
            document.getElementById('ai-enhance-error-message').textContent = 'Network error: ' + error.message;
            document.getElementById('ai-enhance-error').style.display = 'block';
        });
    }
</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}{{ action }} Document - HuduGlue{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
<style>
    #markdown-editor-container {
        display: none;
    }
    .tox-tinymce {
        border: 1px solid #dee2e6 !important;
        border-radius: 0.375rem;
    }
    .select2-container {
        width: 100% !important;
    }
    /* Adaptive editor background based on theme */
    [data-theme="default"] #quill-editor,
    [data-theme="purple"] #quill-editor,
    [data-theme="green"] #quill-editor,
    [data-theme="ocean"] #quill-editor,
    [data-theme="sunset"] #quill-editor,
    [data-theme="solarized"] #quill-editor {
        background-color: #ffffff !important;
        color: #000000 !important;
    }
    [data-theme="dark"] #quill-editor,
    [data-theme="dracula"] #quill-editor,
    [data-theme="monokai"] #quill-editor,
    [data-theme="nord"] #quill-editor {
        background-color: #2b3035 !important;
        color: #dee2e6 !important;
    }

    /* Quill container styling for dark themes */
    [data-theme="dark"] .ql-container,
    [data-theme="dracula"] .ql-container,
    [data-theme="monokai"] .ql-container,
    [data-theme="nord"] .ql-container {
        background-color: #2b3035 !important;
        border-color: #495057 !important;
    }

    [data-theme="dark"] .ql-editor,
    [data-theme="dracula"] .ql-editor,
    [data-theme="monokai"] .ql-editor,
    [data-theme="nord"] .ql-editor {
        color: #dee2e6 !important;
    }

    [data-theme="dark"] .ql-editor.ql-blank::before,
    [data-theme="dracula"] .ql-editor.ql-blank::before,
    [data-theme="monokai"] .ql-editor.ql-blank::before,
    [data-theme="nord"] .ql-editor.ql-blank::before {
        color: #6c757d !important;
    }
    /* Quill toolbar styling for dark themes */
    [data-theme="dark"] .ql-toolbar,
    [data-theme="dracula"] .ql-toolbar,
    [data-theme="monokai"] .ql-toolbar,
    [data-theme="nord"] .ql-toolbar {
        background-color: #f8f9fa !important;
        border-color: #dee2e6 !important;
    }
    [data-theme="dark"] .ql-toolbar .ql-stroke,
    [data-theme="dracula"] .ql-toolbar .ql-stroke,
    [data-theme="monokai"] .ql-toolbar .ql-stroke,
    [data-theme="nord"] .ql-toolbar .ql-stroke {
        stroke: #000000 !important;
    }
    [data-theme="dark"] .ql-toolbar .ql-fill,
    [data-theme="dracula"] .ql-toolbar .ql-fill,
    [data-theme="monokai"] .ql-toolbar .ql-fill,
    [data-theme="nord"] .ql-toolbar .ql-fill {
        fill: #000000 !important;
    }
    [data-theme="dark"] .ql-toolbar .ql-picker-label,
    [data-theme="dracula"] .ql-toolbar .ql-picker-label,
    [data-theme="monokai"] .ql-toolbar .ql-picker-label,
    [data-theme="nord"] .ql-toolbar .ql-picker-label {
        color: #000000 !important;
    }
    /* Select2 dark mode styling */
    [data-theme="dark"] .select2-container--bootstrap-5 .select2-selection,
    [data-theme="dracula"] .select2-container--bootstrap-5 .select2-selection,
    [data-theme="monokai"] .select2-container--bootstrap-5 .select2-selection,
    [data-theme="nord"] .select2-container--bootstrap-5 .select2-selection {
        background-color: #2b2b2b !important;
        border-color: #495057 !important;
        color: #ffffff !important;
    }
    [data-theme="dark"] .select2-container--bootstrap-5 .select2-dropdown,
    [data-theme="dracula"] .select2-container--bootstrap-5 .select2-dropdown,
    [data-theme="monokai"] .select2-container--bootstrap-5 .select2-dropdown,
    [data-theme="nord"] .select2-container--bootstrap-5 .select2-dropdown {
        background-color: #2b2b2b !important;
        border-color: #495057 !important;
    }

    /* Hide the actual file input, we'll use the drop zone */
    #document-file {
        display: none;
    }

    /* Drop zone styling */
    #drop-zone:hover {
        background-color: rgba(13, 110, 253, 0.05);
    }
    [data-theme="dark"] .select2-container--bootstrap-5 .select2-results__option,
    [data-theme="dracula"] .select2-container--bootstrap-5 .select2-results__option,
    [data-theme="monokai"] .select2-container--bootstrap-5 .select2-results__option,
    [data-theme="nord"] .select2-container--bootstrap-5 .select2-results__option {
        color: #ffffff !important;
    }
    [data-theme="dark"] .select2-container--bootstrap-5 .select2-results__option--highlighted,
    [data-theme="dracula"] .select2-container--bootstrap-5 .select2-results__option--highlighted,
    [data-theme="monokai"] .select2-container--bootstrap-5 .select2-results__option--highlighted,
    [data-theme="nord"] .select2-container--bootstrap-5 .select2-results__option--highlighted {
        background-color: #375a7f !important;
        color: #ffffff !important;
    }
    [data-theme="dark"] .select2-container--bootstrap-5 .select2-selection__choice,
    [data-theme="dracula"] .select2-container--bootstrap-5 .select2-selection__choice,
    [data-theme="monokai"] .select2-container--bootstrap-5 .select2-selection__choice,
    [data-theme="nord"] .select2-container--bootstrap-5 .select2-selection__choice {
        background-color: #375a7f !important;
        border-color: #2a4763 !important;
        color: #ffffff !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-10 offset-md-1">
        <div class="card">
            <div class="card-header">
                <h3 class="mb-0"><i class="fas fa-file-alt"></i> {{ action }} Document</h3>
            </div>
            <div class="card-body">
                <form method="post" id="document-form" enctype="multipart/form-data">
                    {% csrf_token %}

                    {% if form.non_field_errors %}
                    <div class="alert alert-danger" role="alert">
                        {{ form.non_field_errors }}
                    </div>
                    {% endif %}

                    {% if action == 'Create' and templates %}
                    <div class="alert alert-info">
                        <i class="fas fa-file-alt"></i> <strong>Start from Template:</strong>
                        <select class="form-select form-select-sm d-inline-block w-auto ms-2" id="template-selector">
                            <option value="">-- Select a template --</option>
                            {% for template in templates %}
                            <option value="{{ template.id }}" {% if selected_template and selected_template.id == template.id %}selected{% endif %}>
                                {{ template.title }}
                            </option>
                            {% endfor %}
                        </select>
                        <button type="button" class="btn btn-sm btn-primary ms-2" onclick="loadTemplate()">
                            <i class="fas fa-download"></i> Load Template
                        </button>
                    </div>
                    {% endif %}

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.title.id_for_label }}" class="form-label">Title *</label>
                            {{ form.title }}
                            {% if form.title.errors %}<div class="invalid-feedback d-block">{{ form.title.errors }}</div>{% endif %}
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="{{ form.content_type.id_for_label }}" class="form-label">Editor *</label>
                            {{ form.content_type }}
                            {% if form.content_type.errors %}<div class="invalid-feedback d-block">{{ form.content_type.errors }}</div>{% endif %}
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="{{ form.category.id_for_label }}" class="form-label">Category</label>
                            {{ form.category }}
                            {% if form.category.errors %}<div class="invalid-feedback d-block">{{ form.category.errors }}</div>{% endif %}
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="editor-container" class="form-label">Content *</label>

                        <!-- WYSIWYG Editor (TinyMCE) -->
                        <div id="tinymce-editor-container">
                            {{ form.body }}
                        </div>

                        <!-- Markdown Editor -->
                        <div id="markdown-editor-container">
                            <textarea id="markdown-textarea" class="form-control" rows="20"></textarea>
                        </div>

                        <!-- File Upload -->
                        <div id="file-upload-container" style="display: none;">
                            <div id="drop-zone" class="border border-2 border-dashed rounded p-5 text-center" style="cursor: pointer; transition: all 0.3s;">
                                <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">Drag & Drop or Click to Upload</h5>
                                <p class="text-muted small mb-3">Supported: PDF, Word, Excel, PowerPoint, Images, ZIP (max 50MB)</p>
                                {{ form.file }}
                                <div id="file-info" class="mt-3" style="display: none;">
                                    <i class="fas fa-file me-2"></i>
                                    <span id="file-name"></span>
                                    <span id="file-size" class="text-muted small ms-2"></span>
                                    <button type="button" class="btn btn-sm btn-danger ms-2" id="remove-file">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        {% if form.body.errors %}
                        <div class="invalid-feedback d-block">{{ form.body.errors }}</div>
                        {% endif %}
                        {% if form.file.errors %}
                        <div class="invalid-feedback d-block">{{ form.file.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="{{ form.tags.id_for_label }}" class="form-label">Tags</label>
                            {{ form.tags }}
                            {% if form.tags.errors %}<div class="invalid-feedback d-block">{{ form.tags.errors }}</div>{% endif %}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Options</label>
                            <div class="form-check">
                                {{ form.is_published }}
                                <label class="form-check-label" for="{{ form.is_published.id_for_label }}">Published</label>
                            </div>
                            <div class="form-check">
                                {{ form.is_template }}
                                <label class="form-check-label" for="{{ form.is_template.id_for_label }}">Template</label>
                            </div>
                            <div class="form-check">
                                {{ form.is_archived }}
                                <label class="form-check-label" for="{{ form.is_archived.id_for_label }}">Archived</label>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-end gap-2">
                        <a href="{% if document %}{% url 'docs:document_detail' document.slug %}{% else %}{% url 'docs:document_list' %}{% endif %}" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> {{ action }} Document
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<link href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    const contentTypeSelect = document.getElementById('content-type-select');
    const bodyTextarea = document.getElementById('document-body');
    const quillContainer = document.getElementById('tinymce-editor-container');
    const markdownContainer = document.getElementById('markdown-editor-container');
    const fileUploadContainer = document.getElementById('file-upload-container');
    const markdownTextarea = document.getElementById('markdown-textarea');
    const form = document.getElementById('document-form');
    const fileInput = document.getElementById('document-file');
    const dropZone = document.getElementById('drop-zone');
    const fileInfo = document.getElementById('file-info');
    const fileName = document.getElementById('file-name');
    const fileSize = document.getElementById('file-size');
    const removeFileBtn = document.getElementById('remove-file');

    let quillEditor = null;

    // Initialize Quill
    function initQuill() {
        if (quillEditor) return;

        // Create editor container for Quill
        const editorDiv = document.createElement('div');
        editorDiv.id = 'quill-editor';
        editorDiv.style.height = '500px';
        // Background color is controlled by CSS based on theme

        // Insert before the textarea
        bodyTextarea.parentNode.insertBefore(editorDiv, bodyTextarea);
        bodyTextarea.style.display = 'none';
        bodyTextarea.removeAttribute('required');  // Remove required to prevent validation on hidden field

        quillEditor = new Quill('#quill-editor', {
            theme: 'snow',
            placeholder: 'Write your document content here...',
            modules: {
                toolbar: [
                    [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                    [{ 'font': [] }],
                    [{ 'size': ['small', false, 'large', 'huge'] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'color': [] }, { 'background': [] }],
                    [{ 'script': 'sub'}, { 'script': 'super' }],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    [{ 'indent': '-1'}, { 'indent': '+1' }],
                    [{ 'direction': 'rtl' }],
                    [{ 'align': [] }],
                    ['blockquote', 'code-block'],
                    ['link', 'image', 'video'],
                    ['clean']
                ],
                clipboard: {
                    // Preserve more formatting when pasting
                    matchVisual: true
                }
            }
        });

        // Set initial content if exists
        if (bodyTextarea.value) {
            quillEditor.root.innerHTML = bodyTextarea.value;
        }
    }

    // Toggle editor based on content type
    function toggleEditor() {
        const contentType = contentTypeSelect.value;

        if (contentType === 'html') {
            // Show WYSIWYG
            quillContainer.style.display = 'block';
            markdownContainer.style.display = 'none';
            fileUploadContainer.style.display = 'none';

            if (!quillEditor) {
                initQuill();
            } else {
                document.getElementById('quill-editor').style.display = 'block';
            }
        } else if (contentType === 'markdown') {
            // Show Markdown textarea
            quillContainer.style.display = 'none';
            markdownContainer.style.display = 'block';
            fileUploadContainer.style.display = 'none';

            // Load existing content into markdown textarea if not already loaded
            if (!markdownTextarea.value && bodyTextarea.value) {
                markdownTextarea.value = bodyTextarea.value;
            }

            // Hide Quill if it exists
            if (quillEditor) {
                document.getElementById('quill-editor').style.display = 'none';
            }
        } else if (contentType === 'file') {
            // Show File Upload
            quillContainer.style.display = 'none';
            markdownContainer.style.display = 'none';
            fileUploadContainer.style.display = 'block';

            // Hide Quill if it exists
            if (quillEditor) {
                document.getElementById('quill-editor').style.display = 'none';
            }
        }
    }

    // Initialize on page load
    toggleEditor();

    // Listen for content type changes
    contentTypeSelect.addEventListener('change', toggleEditor);

    // File upload drag and drop functionality
    if (dropZone && fileInput) {
        // Make drop zone clickable
        dropZone.addEventListener('click', function(e) {
            if (e.target !== removeFileBtn && !e.target.closest('#remove-file')) {
                fileInput.click();
            }
        });

        // File input change handler
        fileInput.addEventListener('change', function(e) {
            if (this.files && this.files[0]) {
                displayFileInfo(this.files[0]);
            }
        });

        // Drag and drop handlers
        dropZone.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
            this.style.borderColor = '#0d6efd';
            this.style.backgroundColor = 'rgba(13, 110, 253, 0.1)';
        });

        dropZone.addEventListener('dragleave', function(e) {
            e.preventDefault();
            e.stopPropagation();
            this.style.borderColor = '#dee2e6';
            this.style.backgroundColor = 'transparent';
        });

        dropZone.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            this.style.borderColor = '#dee2e6';
            this.style.backgroundColor = 'transparent';

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                displayFileInfo(files[0]);
            }
        });

        // Remove file handler
        if (removeFileBtn) {
            removeFileBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                fileInput.value = '';
                fileInfo.style.display = 'none';
            });
        }
    }

    // Display file info
    function displayFileInfo(file) {
        fileName.textContent = file.name;
        fileSize.textContent = '(' + formatFileSize(file.size) + ')';
        fileInfo.style.display = 'block';
    }

    // Format file size
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    // Before form submit, ensure content is synced and validate
    form.addEventListener('submit', function(e) {
        const contentType = contentTypeSelect.value;

        // Sync content from visible editor to hidden textarea
        if (contentType === 'html' && quillEditor) {
            bodyTextarea.value = quillEditor.root.innerHTML;
        } else if (contentType === 'markdown') {
            bodyTextarea.value = markdownTextarea.value;
        }

        // Validate based on content type
        if (contentType === 'file') {
            // Validate file is selected
            if (!fileInput.files || fileInput.files.length === 0) {
                e.preventDefault();
                alert('Please select a file to upload.');
                return false;
            }

            // Validate file size (50MB max)
            const maxSize = 50 * 1024 * 1024; // 50MB
            if (fileInput.files[0].size > maxSize) {
                e.preventDefault();
                alert('File size must be less than 50MB.');
                return false;
            }
        } else {
            // Validate that content is not empty for HTML/Markdown
            const content = bodyTextarea.value.trim();
            if (!content || content === '<p><br></p>') {
                e.preventDefault();
                alert('Please enter document content before submitting.');
                return false;
            }
        }
    });

    // Auto-generate slug from title
    const titleInput = document.getElementById('{{ form.title.id_for_label }}');
    const slugInput = document.getElementById('{{ form.slug.id_for_label }}');

    if (titleInput && slugInput && !slugInput.value) {
        titleInput.addEventListener('input', function() {
            const slug = this.value
                .toLowerCase()
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/^-+|-+$/g, '');
            slugInput.value = slug;
        });
    }

    // Load template function
    function loadTemplate() {
        const templateSelector = document.getElementById('template-selector');
        const templateId = templateSelector.value;

        if (templateId) {
            window.location.href = '?template=' + templateId;
        } else {
            alert('Please select a template first.');
        }
    }

    // Initialize Select2 for tags multi-select
    $(document).ready(function() {
        $('#{{ form.tags.id_for_label }}').select2({
            theme: 'bootstrap-5',
            placeholder: 'Select tags...',
            allowClear: true,
            width: '100%'
        });
    });
</script>
{% endblock %}

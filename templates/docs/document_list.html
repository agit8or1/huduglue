{% extends "base.html" %}

{% block title %}Documents{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1><i class="fas fa-file-alt"></i> Documents</h1>
    <div class="btn-group">
        <a href="{% url 'docs:category_list' %}" class="btn btn-secondary"><i class="fas fa-folder"></i> Categories</a>
        <a href="{% url 'docs:template_list' %}" class="btn btn-secondary"><i class="fas fa-file-alt"></i> Templates</a>
        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#uploadModal">
            <i class="fas fa-upload"></i> Upload Files
        </button>
        <a href="{% url 'docs:document_create' %}" class="btn btn-primary"><i class="fas fa-plus"></i> New Document</a>
    </div>
</div>

<!-- Filters -->
<div class="card mb-3">
    <div class="card-body py-2">
        <form method="get" class="row g-2 align-items-end">
            <div class="col-md-4">
                <label class="form-label small mb-1">Search</label>
                <input type="text" name="q" class="form-control form-control-sm" placeholder="Search documents..." value="{{ query }}">
            </div>
            <div class="col-md-3">
                <label class="form-label small mb-1">Category</label>
                <select name="category" class="form-select form-select-sm">
                    <option value="">All Categories</option>
                    {% for cat in categories %}
                    <option value="{{ cat.id }}" {% if selected_category == cat.id|stringformat:"s" %}selected{% endif %}>
                        {{ cat.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label small mb-1">Tag</label>
                <select name="tag" class="form-select form-select-sm">
                    <option value="">All Tags</option>
                    {% for tag in tags %}
                    <option value="{{ tag.id }}" {% if selected_tag == tag.id|stringformat:"s" %}selected{% endif %}>
                        {{ tag.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary btn-sm w-100">
                    <i class="fas fa-filter"></i> Filter
                </button>
                <a href="{% url 'docs:document_list' %}" class="btn btn-outline-secondary btn-sm w-100 mt-1">
                    <i class="fas fa-times"></i> Clear
                </a>
            </div>
        </form>
    </div>
</div>

{% if org_docs %}
<!-- View Toggle -->
<div class="d-flex justify-content-end mb-3">
    <div class="btn-group btn-group-sm" role="group">
        <button type="button" class="btn btn-outline-secondary" id="cardViewBtn"><i class="fas fa-th"></i> Card</button>
        <button type="button" class="btn btn-outline-secondary active" id="tableViewBtn"><i class="fas fa-list"></i> Table</button>
    </div>
</div>

<!-- Card View -->
<div id="cardView" class="row" style="display: none;">
    {% for doc in org_docs %}
    <div class="col-md-3 col-lg-2 mb-3">
        <div class="card h-100 shadow-sm">
            <!-- Preview/Thumbnail -->
            <div class="position-relative" style="height: 120px; overflow: hidden; background: #f8f9fa;">
                {% if doc.content_type == 'file' and doc.file %}
                    {% if 'image' in doc.file_type %}
                        <img src="{{ doc.file.url }}" class="w-100 h-100" style="object-fit: cover;" alt="{{ doc.title }}">
                    {% elif 'pdf' in doc.file_type %}
                        <div class="d-flex align-items-center justify-content-center h-100">
                            <i class="fas fa-file-pdf fa-5x text-danger"></i>
                        </div>
                    {% else %}
                        <div class="d-flex align-items-center justify-content-center h-100">
                            <i class="fas fa-file fa-5x text-muted"></i>
                        </div>
                    {% endif %}
                {% elif doc.preview_image %}
                    <img src="{{ doc.preview_image.url }}" class="w-100 h-100" style="object-fit: cover;" alt="{{ doc.title }}">
                {% else %}
                    <div class="d-flex align-items-center justify-content-center h-100">
                        <i class="fas fa-file-alt fa-5x text-primary"></i>
                    </div>
                {% endif %}
                <!-- Type Badge -->
                <div class="position-absolute top-0 end-0 m-2">
                    {% if doc.content_type == 'file' %}
                        <span class="badge bg-success"><i class="fas fa-paperclip"></i> File</span>
                    {% elif doc.content_type == 'markdown' %}
                        <span class="badge bg-info"><i class="fab fa-markdown"></i> MD</span>
                    {% else %}
                        <span class="badge bg-primary"><i class="fas fa-code"></i> HTML</span>
                    {% endif %}
                </div>
            </div>

            <div class="card-body p-2">
                <h6 class="card-title mb-1" style="font-size: 0.85rem;">
                    <a href="{% url 'docs:document_detail' doc.slug %}" class="text-decoration-none">{{ doc.title|truncatechars:30 }}</a>
                </h6>
                {% if doc.content_type == 'file' and doc.file_size %}
                <p class="small text-muted mb-1" style="font-size: 0.7rem;"><i class="fas fa-hdd"></i> {{ doc.file_size|filesizeformat }}</p>
                {% endif %}
                <p class="small text-muted mb-0" style="font-size: 0.7rem;">
                    <i class="far fa-clock"></i> {{ doc.updated_at|date:"M d" }}
                </p>
            </div>

            <div class="card-footer bg-transparent border-top-0 p-2 pt-0">
                <div class="btn-group btn-group-sm w-100">
                    <a href="{% url 'docs:document_detail' doc.slug %}" class="btn btn-outline-primary btn-sm py-0" style="font-size: 0.7rem;"><i class="fas fa-eye"></i></a>
                    <a href="{% url 'docs:document_edit' doc.slug %}" class="btn btn-outline-secondary btn-sm py-0" style="font-size: 0.7rem;"><i class="fas fa-edit"></i></a>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Table View (Default) -->
<div id="tableView" class="row">
    <div class="col-md-12 mb-4">
        <div class="card">
            <div class="card-header py-2">
                <h6 class="mb-0"><i class="fas fa-building"></i> Organization Documents</h6>
            </div>
            <div class="card-body">
                <table id="orgDocsTable" class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Type</th>
                            <th>Category</th>
                            <th>Tags</th>
                            <th>Updated</th>
                            <th width="100">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for doc in org_docs %}
                        <tr>
                            <td>
                                <a href="{% url 'docs:document_detail' doc.slug %}">{{ doc.title }}</a>
                                {% if doc.is_template %}<span class="badge bg-success ms-2">Template</span>{% endif %}
                            </td>
                            <td>
                                {% if doc.content_type == 'file' %}
                                    <span class="badge bg-success"><i class="fas fa-paperclip"></i> File</span>
                                    {% if doc.file_size %}<small class="text-muted">({{ doc.file_size|filesizeformat }})</small>{% endif %}
                                {% elif doc.content_type == 'markdown' %}
                                    <span class="badge bg-info"><i class="fab fa-markdown"></i> Markdown</span>
                                {% else %}
                                    <span class="badge bg-primary"><i class="fas fa-code"></i> HTML</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if doc.category %}
                                <span class="badge bg-secondary">{{ doc.category.name }}</span>
                                {% else %}â€”{% endif %}
                            </td>
                            <td>
                                {% for tag in doc.tags.all %}
                                <span class="badge" style="background-color: {{ tag.color }}">{{ tag.name }}</span>
                                {% endfor %}
                            </td>
                            <td>{{ doc.updated_at|date:"Y-m-d" }}</td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <a href="{% url 'docs:document_detail' doc.slug %}" class="btn btn-outline-primary" title="View"><i class="fas fa-eye"></i></a>
                                    <a href="{% url 'docs:document_edit' doc.slug %}" class="btn btn-outline-secondary" title="Edit"><i class="fas fa-edit"></i></a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% else %}
<div class="card">
    <div class="card-body text-center py-5">
        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
        <p class="text-muted">No documents found. <a href="{% url 'docs:document_create' %}">Create one</a> or <button type="button" class="btn btn-link p-0" data-bs-toggle="modal" data-bs-target="#uploadModal">upload files</button>.</p>
    </div>
</div>
{% endif %}

<!-- Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true" data-bs-backdrop="false">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="uploadModalLabel"><i class="fas fa-upload"></i> Upload Files</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="uploadForm" method="post" action="{% url 'docs:document_upload' %}" enctype="multipart/form-data">
                    {% csrf_token %}

                    <!-- Drag and Drop Zone -->
                    <div id="uploadDropZone" class="border border-2 border-dashed rounded p-5 text-center mb-3" style="cursor: pointer; background: #f8f9fa;">
                        <i class="fas fa-cloud-upload-alt fa-4x text-primary mb-3"></i>
                        <h5>Drag & Drop Files Here</h5>
                        <p class="text-muted">or click to browse</p>
                        <input type="file" id="fileInput" name="files" multiple class="d-none" accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.jpg,.jpeg,.png,.gif,.svg,.zip,.bmp,.webp">
                        <p class="small text-muted mt-3 mb-0">
                            Supported: PDF, Word, Excel, PowerPoint, Images, ZIP | Max 50MB per file
                        </p>
                    </div>

                    <!-- File List -->
                    <div id="fileList" class="mb-3" style="display: none;">
                        <h6>Selected Files:</h6>
                        <ul id="fileListItems" class="list-group"></ul>
                    </div>

                    <!-- Optional: Category Selection -->
                    <div class="mb-3">
                        <label class="form-label">Category (optional)</label>
                        <select name="category" class="form-select">
                            <option value="">-- No Category --</option>
                            {% for cat in categories %}
                            <option value="{{ cat.id }}">{{ cat.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Upload Progress -->
                    <div id="uploadProgress" style="display: none;">
                        <div class="progress">
                            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                        </div>
                        <p id="uploadStatus" class="text-center mt-2 mb-0"></p>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="uploadButton" class="btn btn-primary" disabled>
                    <i class="fas fa-upload"></i> Upload Files
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // File Upload Modal Logic
    const dropZone = document.getElementById('uploadDropZone');
    const fileInput = document.getElementById('fileInput');
    const fileList = document.getElementById('fileList');
    const fileListItems = document.getElementById('fileListItems');
    const uploadButton = document.getElementById('uploadButton');
    const uploadForm = document.getElementById('uploadForm');
    const uploadProgress = document.getElementById('uploadProgress');
    const progressBar = document.getElementById('progressBar');
    const uploadStatus = document.getElementById('uploadStatus');

    let selectedFiles = [];

    // Click to browse
    dropZone.addEventListener('click', () => fileInput.click());

    // Drag and drop events
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.style.borderColor = '#0d6efd';
        dropZone.style.background = 'rgba(13, 110, 253, 0.1)';
    });

    dropZone.addEventListener('dragleave', () => {
        dropZone.style.borderColor = '#dee2e6';
        dropZone.style.background = '#f8f9fa';
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.style.borderColor = '#dee2e6';
        dropZone.style.background = '#f8f9fa';
        handleFiles(e.dataTransfer.files);
    });

    // File input change
    fileInput.addEventListener('change', (e) => {
        handleFiles(e.target.files);
    });

    // Handle selected files
    function handleFiles(files) {
        selectedFiles = Array.from(files);
        displayFileList();
        uploadButton.disabled = selectedFiles.length === 0;
    }

    // Display file list
    function displayFileList() {
        fileListItems.innerHTML = '';
        if (selectedFiles.length > 0) {
            fileList.style.display = 'block';
            selectedFiles.forEach((file, index) => {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                li.innerHTML = `
                    <div>
                        <i class="fas fa-file me-2"></i>
                        <strong>${file.name}</strong>
                        <small class="text-muted ms-2">(${formatFileSize(file.size)})</small>
                    </div>
                    <button type="button" class="btn btn-sm btn-danger" onclick="removeFile(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                fileListItems.appendChild(li);
            });
        } else {
            fileList.style.display = 'none';
        }
    }

    // Remove file from list
    window.removeFile = function(index) {
        selectedFiles.splice(index, 1);
        displayFileList();
        uploadButton.disabled = selectedFiles.length === 0;
    };

    // Format file size
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    // Upload button click
    uploadButton.addEventListener('click', async () => {
        if (selectedFiles.length === 0) return;

        uploadButton.disabled = true;
        uploadProgress.style.display = 'block';

        const formData = new FormData(uploadForm);
        formData.delete('files'); // Remove old files
        selectedFiles.forEach(file => formData.append('files', file));

        try {
            const response = await fetch(uploadForm.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            if (response.ok) {
                const result = await response.json();
                uploadStatus.textContent = `Successfully uploaded ${result.uploaded} file(s)`;
                progressBar.style.width = '100%';
                progressBar.classList.remove('progress-bar-animated');
                progressBar.classList.add('bg-success');

                // Reload page after 1 second
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                throw new Error('Upload failed');
            }
        } catch (error) {
            uploadStatus.textContent = 'Upload failed. Please try again.';
            uploadStatus.classList.add('text-danger');
            uploadButton.disabled = false;
        }
    });

    // Reset modal on close
    $('#uploadModal').on('hidden.bs.modal', function () {
        selectedFiles = [];
        fileInput.value = '';
        fileListItems.innerHTML = '';
        fileList.style.display = 'none';
        uploadButton.disabled = true;
        uploadProgress.style.display = 'none';
        progressBar.style.width = '0%';
        uploadStatus.textContent = '';
        progressBar.classList.add('progress-bar-animated');
        progressBar.classList.remove('bg-success');
    });

    // Initialize DataTable
    let table = null;

    // View toggle functionality
    $('#cardViewBtn').click(function() {
        $('#cardView').show();
        $('#tableView').hide();
        $(this).addClass('active');
        $('#tableViewBtn').removeClass('active');
        localStorage.setItem('docViewMode', 'card');
    });

    $('#tableViewBtn').click(function() {
        $('#cardView').hide();
        $('#tableView').show();
        $(this).addClass('active');
        $('#cardViewBtn').removeClass('active');
        localStorage.setItem('docViewMode', 'table');

        // Initialize DataTable when switching to table view
        if (table === null) {
            table = $('#orgDocsTable').DataTable({
                order: [[4, 'desc']],
                pageLength: 25,
                language: {
                    search: "_INPUT_",
                    searchPlaceholder: "Search documents..."
                }
            });
        }
    });

    // Restore view mode from localStorage or default to table
    const savedView = localStorage.getItem('docViewMode') || 'table';
    if (savedView === 'table') {
        $('#tableViewBtn').click();
    } else {
        $('#cardViewBtn').click();
    }
});
</script>
{% endblock %}

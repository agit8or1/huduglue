{% extends 'base.html' %}
{% load static %}

{% block title %}{{ patch_panel.name }} - Patch Panel - {{ block.super }}{% endblock %}

{% block extra_css %}
<style>
    .patch-panel-container {
        display: flex;
        gap: 20px;
        margin-top: 20px;
    }

    .panel-main {
        flex: 1;
    }

    .panel-visual-container {
        background: #2c3e50;
        border-radius: 8px;
        padding: 20px;
        position: relative;
        min-height: 600px;
    }

    .panel-header {
        background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
        border-radius: 4px;
        padding: 15px;
        color: white;
        margin-bottom: 20px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        text-align: center;
    }

    .ports-grid {
        display: grid;
        grid-template-columns: repeat(8, 1fr);
        gap: 10px;
        margin-bottom: 20px;
    }

    .port {
        background: #34495e;
        border: 3px solid #7f8c8d;
        border-radius: 6px;
        height: 60px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #ecf0f1;
        font-size: 11px;
        font-weight: bold;
        transition: all 0.2s;
        cursor: pointer;
        position: relative;
        user-select: none;
    }

    .port:hover {
        border-color: #3498db;
        box-shadow: 0 0 15px rgba(52,152,219,0.6);
        transform: scale(1.05);
    }

    .port.in-use {
        background: #27ae60;
        border-color: #2ecc71;
    }

    .port.available {
        background: #34495e;
        border-color: #7f8c8d;
    }

    .port.reserved {
        background: #f39c12;
        border-color: #f1c40f;
    }

    .port.connecting {
        border-color: #e74c3c;
        box-shadow: 0 0 20px rgba(231,76,60,0.8);
        animation: pulse 0.5s infinite;
    }

    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
    }

    .port-number {
        font-size: 14px;
        font-weight: bold;
        margin-bottom: 2px;
    }

    .port-label {
        font-size: 9px;
        opacity: 0.8;
        text-align: center;
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        padding: 0 2px;
    }

    .port-indicator {
        position: absolute;
        top: 2px;
        right: 2px;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #95a5a6;
    }

    .port-indicator.connected {
        background: #2ecc71;
        box-shadow: 0 0 8px #2ecc71;
    }

    #connection-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 10;
    }

    .connection-line {
        stroke-width: 3;
        stroke-linecap: round;
        fill: none;
        opacity: 0.8;
    }

    .assets-sidebar {
        width: 280px;
        background: var(--bs-light);
        border-radius: 6px;
        padding: 15px;
        max-height: 800px;
        overflow-y: auto;
        flex-shrink: 0;
    }

    .assets-sidebar h6 {
        margin-bottom: 12px;
        padding-bottom: 8px;
        border-bottom: 2px solid var(--bs-border-color);
    }

    .asset-item {
        padding: 10px;
        margin-bottom: 8px;
        background: white;
        border: 2px solid var(--bs-border-color);
        border-radius: 6px;
        cursor: move;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: all 0.2s;
        user-select: none;
    }

    .asset-item:hover {
        background: var(--bs-primary-bg-subtle);
        border-color: var(--bs-primary);
        transform: translateX(5px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .asset-item .icon {
        font-size: 20px;
        color: var(--bs-primary);
    }

    .asset-item .name {
        flex: 1;
        font-weight: 500;
    }

    .panel-toolbar {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        padding: 10px;
        background: var(--bs-light);
        border-radius: 6px;
        flex-wrap: wrap;
    }

    .connection-info {
        background: var(--bs-info-bg-subtle);
        border-left: 4px solid var(--bs-info);
        padding: 12px;
        border-radius: 4px;
        margin-bottom: 15px;
        font-size: 14px;
    }

    [data-bs-theme="dark"] .panel-visual-container {
        background: #1a1d23;
    }

    [data-bs-theme="dark"] .panel-header {
        background: linear-gradient(135deg, #21252b 0%, #1a1d23 100%);
    }

    [data-bs-theme="dark"] .port {
        background: #21252b;
        border-color: #30363d;
    }

    [data-bs-theme="dark"] .assets-sidebar {
        background: #0d1117;
    }

    [data-bs-theme="dark"] .asset-item {
        background: #161b22;
        border-color: #30363d;
    }
</style>
{% endblock %}

{% block content %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'monitoring:rack_list' %}">Racks</a></li>
        <li class="breadcrumb-item"><a href="{% url 'monitoring:patch_panel_list' %}">Patch Panels</a></li>
        <li class="breadcrumb-item active">{{ patch_panel.name }}</li>
    </ol>
</nav>

<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h2><i class="fas fa-network-wired"></i> {{ patch_panel.name }}</h2>
        <p class="text-muted mb-0">
            {% if patch_panel.rack %}
            <i class="fas fa-server"></i> {{ patch_panel.rack.name }}
            {% if patch_panel.rack_position %}
            - U{{ patch_panel.rack_position }}
            {% endif %}
            {% endif %}
            | {{ patch_panel.port_count|default:24 }} Ports
        </p>
    </div>
    <div class="btn-group">
        <a href="{% url 'monitoring:patch_panel_edit' patch_panel.pk %}" class="btn btn-primary">
            <i class="fas fa-edit"></i> Edit
        </a>
        <a href="{% url 'monitoring:patch_panel_delete' patch_panel.pk %}" class="btn btn-danger">
            <i class="fas fa-trash"></i> Delete
        </a>
    </div>
</div>

<div class="patch-panel-container">
    <!-- Main Panel Area -->
    <div class="panel-main">
        <!-- Toolbar -->
        <div class="panel-toolbar">
            <button id="clear-connections" class="btn btn-sm btn-outline-danger">
                <i class="fas fa-eraser"></i> Clear All Connections
            </button>
            <button id="export-config" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-download"></i> Export Config
            </button>
            <button id="toggle-labels" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-tag"></i> Toggle Labels
            </button>
            <div class="ms-auto">
                <span class="badge bg-success me-2">
                    <span id="available-count">0</span> Available
                </span>
                <span class="badge bg-primary">
                    <span id="connected-count">0</span> Connected
                </span>
            </div>
        </div>

        <!-- Connection Mode Info -->
        <div id="connection-mode-info" class="connection-info" style="display: none;">
            <i class="fas fa-info-circle"></i>
            <strong>Connection Mode:</strong> Click on the destination port to complete the connection, or click anywhere else to cancel.
        </div>

        <!-- Panel Visual -->
        <div class="panel-visual-container">
            <div class="panel-header">
                <h5 class="mb-1">{{ patch_panel.name }}</h5>
                <small>{{ patch_panel.manufacturer }} {{ patch_panel.model }}</small>
            </div>

            <!-- SVG Overlay for Connections -->
            <svg id="connection-overlay"></svg>

            <!-- Ports Grid -->
            <div id="ports-grid" class="ports-grid" data-panel-id="{{ patch_panel.id }}">
                <!-- Ports will be rendered by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Assets Sidebar -->
    <div class="assets-sidebar">
        <h6><i class="fas fa-box"></i> Drag to Assign</h6>

        <div class="mb-3">
            <input type="text" id="asset-search" class="form-control form-control-sm" placeholder="Search assets...">
        </div>

        <div id="available-assets">
            <!-- Sample asset items - in production, load from database -->
            <div class="asset-item" data-asset-name="Server-01" draggable="true">
                <i class="fas fa-server icon"></i>
                <span class="name">Server-01</span>
            </div>
            <div class="asset-item" data-asset-name="Switch-Core" draggable="true">
                <i class="fas fa-network-wired icon"></i>
                <span class="name">Switch-Core</span>
            </div>
            <div class="asset-item" data-asset-name="Printer-Floor2" draggable="true">
                <i class="fas fa-print icon"></i>
                <span class="name">Printer-Floor2</span>
            </div>
            <div class="asset-item" data-asset-name="Camera-01" draggable="true">
                <i class="fas fa-video icon"></i>
                <span class="name">Camera-01</span>
            </div>
            <div class="asset-item" data-asset-name="AP-Lobby" draggable="true">
                <i class="fas fa-wifi icon"></i>
                <span class="name">AP-Lobby</span>
            </div>
        </div>

        <div class="mt-3 pt-3 border-top">
            <h6><i class="fas fa-palette"></i> Cable Colors</h6>
            <div class="d-flex gap-2 flex-wrap">
                <button class="btn btn-sm cable-color" style="background: #3498db; color: white;" data-color="#3498db">Blue</button>
                <button class="btn btn-sm cable-color" style="background: #2ecc71; color: white;" data-color="#2ecc71">Green</button>
                <button class="btn btn-sm cable-color" style="background: #e74c3c; color: white;" data-color="#e74c3c">Red</button>
                <button class="btn btn-sm cable-color" style="background: #f39c12; color: white;" data-color="#f39c12">Orange</button>
                <button class="btn btn-sm cable-color" style="background: #9b59b6; color: white;" data-color="#9b59b6">Purple</button>
                <button class="btn btn-sm cable-color" style="background: #95a5a6; color: white;" data-color="#95a5a6">Gray</button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div id="toast-container" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;"></div>

{% endblock %}

{% block extra_js %}
<script>
// Configuration
const PANEL_ID = {{ patch_panel.id }};
const PORT_COUNT = {{ patch_panel.port_count|default:24 }};

// State
let ports = [];
let connectingFrom = null;
let selectedCableColor = '#3498db';
let showLabels = true;

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadPorts();
    initializeToolbar();
    initializeAssetDragDrop();
    initializeCableColors();
});

// Load ports from API
function loadPorts() {
    fetch(`/monitoring/api/patch-panels/${PANEL_ID}/ports/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                ports = data.ports;
                renderPorts();
                updateStats();
            } else {
                showToast('Error loading ports', 'danger');
            }
        })
        .catch(error => {
            console.error('Failed to load ports:', error);
            showToast('Failed to load port configuration', 'danger');
        });
}

// Render ports
function renderPorts() {
    const grid = document.getElementById('ports-grid');
    grid.innerHTML = '';

    ports.forEach(port => {
        const portEl = createPortElement(port);
        grid.appendChild(portEl);
    });

    renderConnections();
}

// Create port element
function createPortElement(port) {
    const div = document.createElement('div');
    div.className = `port ${port.status}`;
    div.dataset.portNumber = port.port_number;

    const isConnected = port.connected_to && port.connected_to.trim() !== '';

    div.innerHTML = `
        <span class="port-indicator ${isConnected ? 'connected' : ''}"></span>
        <span class="port-number">${port.port_number}</span>
        ${showLabels ? `<span class="port-label">${port.label || ''}</span>` : ''}
    `;

    // Click to connect
    div.addEventListener('click', () => handlePortClick(port.port_number));

    // Right-click for options
    div.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        showPortMenu(port, e);
    });

    // Drag and drop for asset assignment
    div.addEventListener('dragover', (e) => {
        e.preventDefault();
        div.style.borderColor = '#3498db';
    });

    div.addEventListener('dragleave', () => {
        div.style.borderColor = '';
    });

    div.addEventListener('drop', (e) => {
        e.preventDefault();
        div.style.borderColor = '';
        const assetName = e.dataTransfer.getData('asset-name');
        if (assetName) {
            assignAssetToPort(port.port_number, assetName);
        }
    });

    return div;
}

// Handle port click (for drag-to-connect)
function handlePortClick(portNumber) {
    if (!connectingFrom) {
        // Start connection
        connectingFrom = portNumber;
        highlightPort(portNumber, true);
        document.getElementById('connection-mode-info').style.display = 'block';
        showToast(`Connecting from Port ${portNumber}...`, 'info');
    } else if (connectingFrom === portNumber) {
        // Cancel connection
        cancelConnection();
    } else {
        // Complete connection
        connectPorts(connectingFrom, portNumber);
    }
}

// Highlight port
function highlightPort(portNumber, connecting) {
    const portEl = document.querySelector(`.port[data-port-number="${portNumber}"]`);
    if (portEl) {
        if (connecting) {
            portEl.classList.add('connecting');
        } else {
            portEl.classList.remove('connecting');
        }
    }
}

// Cancel connection
function cancelConnection() {
    if (connectingFrom) {
        highlightPort(connectingFrom, false);
        connectingFrom = null;
        document.getElementById('connection-mode-info').style.display = 'none';
    }
}

// Connect two ports
function connectPorts(fromPort, toPort) {
    const connectionLabel = `Port ${toPort}`;

    fetch(`/monitoring/api/patch-panels/${PANEL_ID}/ports/${fromPort}/connect/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            connected_to: connectionLabel,
            cable_color: selectedCableColor,
            label: `To Port ${toPort}`
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(`Port ${fromPort} connected to Port ${toPort}`, 'success');
            cancelConnection();
            loadPorts();  // Reload to show updated state
        } else {
            showToast(data.error || 'Failed to connect ports', 'danger');
        }
    })
    .catch(error => {
        console.error('Connection failed:', error);
        showToast('Failed to create connection', 'danger');
    });
}

// Assign asset to port
function assignAssetToPort(portNumber, assetName) {
    fetch(`/monitoring/api/patch-panels/${PANEL_ID}/ports/${portNumber}/connect/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            connected_to: assetName,
            cable_color: selectedCableColor,
            label: assetName
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(`${assetName} assigned to Port ${portNumber}`, 'success');
            loadPorts();
        } else {
            showToast(data.error || 'Failed to assign asset', 'danger');
        }
    })
    .catch(error => {
        console.error('Assignment failed:', error);
        showToast('Failed to assign asset', 'danger');
    });
}

// Render connection lines
function renderConnections() {
    const svg = document.getElementById('connection-overlay');
    const grid = document.getElementById('ports-grid');
    const gridRect = grid.getBoundingClientRect();
    const containerRect = svg.parentElement.getBoundingClientRect();

    svg.setAttribute('width', gridRect.width);
    svg.setAttribute('height', gridRect.height);
    svg.innerHTML = '';

    ports.forEach(port => {
        if (port.connected_to && port.connected_to.startsWith('Port ')) {
            const toPortNum = parseInt(port.connected_to.replace('Port ', ''));
            const toPort = ports.find(p => p.port_number === toPortNum);

            if (toPort) {
                drawConnection(port, toPort, svg, grid);
            }
        }
    });
}

// Draw connection line
function drawConnection(fromPort, toPort, svg, grid) {
    const fromEl = document.querySelector(`.port[data-port-number="${fromPort.port_number}"]`);
    const toEl = document.querySelector(`.port[data-port-number="${toPort.port_number}"]`);

    if (!fromEl || !toEl) return;

    const gridRect = grid.getBoundingClientRect();
    const fromRect = fromEl.getBoundingClientRect();
    const toRect = toEl.getBoundingClientRect();

    const x1 = fromRect.left - gridRect.left + fromRect.width / 2;
    const y1 = fromRect.top - gridRect.top + fromRect.height / 2;
    const x2 = toRect.left - gridRect.left + toRect.width / 2;
    const y2 = toRect.top - gridRect.top + toRect.height / 2;

    // Create curved path
    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    const curve = `M ${x1},${y1} Q ${(x1+x2)/2},${(y1+y2)/2 - 30} ${x2},${y2}`;

    path.setAttribute('d', curve);
    path.setAttribute('class', 'connection-line');
    path.setAttribute('stroke', fromPort.cable_color || '#3498db');
    path.setAttribute('stroke-width', '3');

    svg.appendChild(path);
}

// Show port context menu
function showPortMenu(port, event) {
    // Simplified - in production, use a proper context menu
    if (port.status === 'in-use') {
        if (confirm(`Disconnect Port ${port.port_number}?`)) {
            disconnectPort(port.port_number);
        }
    }
}

// Disconnect port
function disconnectPort(portNumber) {
    fetch(`/monitoring/api/patch-panels/${PANEL_ID}/ports/${portNumber}/disconnect/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(`Port ${portNumber} disconnected`, 'success');
            loadPorts();
        } else {
            showToast(data.error || 'Failed to disconnect', 'danger');
        }
    })
    .catch(error => {
        console.error('Disconnect failed:', error);
        showToast('Failed to disconnect port', 'danger');
    });
}

// Update statistics
function updateStats() {
    const available = ports.filter(p => p.status === 'available').length;
    const connected = ports.filter(p => p.status === 'in-use').length;

    document.getElementById('available-count').textContent = available;
    document.getElementById('connected-count').textContent = connected;
}

// Initialize toolbar
function initializeToolbar() {
    document.getElementById('clear-connections').addEventListener('click', () => {
        if (confirm('Clear all connections? This cannot be undone.')) {
            clearAllConnections();
        }
    });

    document.getElementById('toggle-labels').addEventListener('click', () => {
        showLabels = !showLabels;
        renderPorts();
    });

    document.getElementById('export-config').addEventListener('click', exportConfiguration);
}

// Clear all connections
function clearAllConnections() {
    const promises = ports
        .filter(p => p.status === 'in-use')
        .map(p =>
            fetch(`/monitoring/api/patch-panels/${PANEL_ID}/ports/${p.port_number}/disconnect/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': getCookie('csrftoken') }
            })
        );

    Promise.all(promises)
        .then(() => {
            showToast('All connections cleared', 'success');
            loadPorts();
        })
        .catch(error => {
            console.error('Failed to clear connections:', error);
            showToast('Failed to clear all connections', 'danger');
        });
}

// Export configuration
function exportConfiguration() {
    const config = {
        panel: {
            id: PANEL_ID,
            name: '{{ patch_panel.name }}',
            port_count: PORT_COUNT
        },
        ports: ports
    };

    const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `patch-panel-${PANEL_ID}-config.json`;
    a.click();
    URL.revokeObjectURL(url);

    showToast('Configuration exported', 'success');
}

// Initialize asset drag and drop
function initializeAssetDragDrop() {
    const assets = document.querySelectorAll('.asset-item');

    assets.forEach(asset => {
        asset.addEventListener('dragstart', (e) => {
            e.dataTransfer.setData('asset-name', asset.dataset.assetName);
            asset.style.opacity = '0.5';
        });

        asset.addEventListener('dragend', (e) => {
            asset.style.opacity = '1';
        });
    });

    // Asset search
    document.getElementById('asset-search').addEventListener('input', (e) => {
        const search = e.target.value.toLowerCase();
        assets.forEach(asset => {
            const name = asset.dataset.assetName.toLowerCase();
            asset.style.display = name.includes(search) ? 'flex' : 'none';
        });
    });
}

// Initialize cable colors
function initializeCableColors() {
    document.querySelectorAll('.cable-color').forEach(btn => {
        btn.addEventListener('click', () => {
            selectedCableColor = btn.dataset.color;
            document.querySelectorAll('.cable-color').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            showToast(`Cable color: ${btn.textContent}`, 'info');
        });
    });
}

// Utility: Get CSRF cookie
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Utility: Show toast
function showToast(message, type = 'info') {
    const toastHTML = `
        <div class="toast align-items-center text-white bg-${type} border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;

    const container = document.getElementById('toast-container');
    container.insertAdjacentHTML('beforeend', toastHTML);
    const toastEl = container.lastElementChild;
    const toast = new bootstrap.Toast(toastEl, {autohide: true, delay: 3000});
    toast.show();

    toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
}

// Cancel connection on click outside
document.addEventListener('click', (e) => {
    if (!e.target.closest('.port') && connectingFrom) {
        cancelConnection();
    }
});
</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}{{ rack.name }} - Client St0r{% endblock %}

{% block extra_css %}
<style>
.rack-visual-container {
    display: flex;
    gap: 20px;
    align-items: flex-start;
}

.rack-main-area {
    flex: 1;
}

.rack-container {
    overflow: auto;
    transform-origin: top left;
    transition: transform 0.3s ease;
}

.rack-toolbar {
    display: flex;
    gap: 8px;
    margin-bottom: 12px;
    padding: 8px;
    background: var(--bs-light);
    border-radius: 6px;
    flex-wrap: wrap;
}

.rack-visual {
    border: 2px solid #495057;
    background: #212529;
    padding: 8px;
    border-radius: 6px;
    max-width: 350px;
    min-width: 300px;
    transition: transform 0.3s ease;
}

.rack-unit {
    height: 22px;
    border: 1px solid #495057;
    background: #343a40;
    margin-bottom: 1px;
    display: flex;
    align-items: center;
    padding: 0 6px;
    font-size: 0.7rem;
    color: #e9ecef;
    position: relative;
}

.rack-unit-number {
    width: 24px;
    text-align: center;
    font-weight: bold;
    font-size: 0.65rem;
    color: #f8f9fa;
    flex-shrink: 0;
}

.rack-device {
    color: white;
    cursor: move;
    user-select: none;
}

.rack-device:hover {
    opacity: 0.9;
    box-shadow: 0 0 8px rgba(255,255,255,0.3);
}

.rack-device.draggable .device-name {
    cursor: grab;
}

.rack-device.draggable .device-name:active {
    cursor: grabbing;
}

.device-name {
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    font-size: 0.65rem;
}

.device-resize-handle {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: rgba(255,255,255,0.2);
    cursor: ns-resize;
    opacity: 0;
    transition: opacity 0.2s;
}

.rack-device:hover .device-resize-handle {
    opacity: 1;
}

.device-continuation {
    cursor: default;
    border-top: none;
}

.rack-unit-empty {
    cursor: pointer;
    transition: all 0.15s ease;
}

.rack-unit-empty:hover {
    background: #495057;
    border-color: #6c757d;
}

.rack-unit-empty .empty-indicator {
    opacity: 0.3;
    font-size: 0.6rem;
    margin-left: auto;
}

.assets-sidebar {
    width: 250px;
    background: var(--bs-light);
    border-radius: 6px;
    padding: 12px;
    max-height: 600px;
    overflow-y: auto;
    flex-shrink: 0;
}

.assets-sidebar h6 {
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--bs-border-color);
}

.asset-item {
    padding: 8px;
    margin-bottom: 6px;
    background: white;
    border: 1px solid var(--bs-border-color);
    border-radius: 4px;
    cursor: move;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s;
    user-select: none;
}

.asset-item:hover {
    background: var(--bs-primary-bg-subtle);
    border-color: var(--bs-primary);
    transform: translateX(4px);
}

.asset-item .fas.fa-grip-vertical {
    color: var(--bs-secondary);
}

.asset-item .asset-name {
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.asset-item .asset-units {
    font-size: 0.75rem;
}

/* Sortable ghost/drag styles */
.sortable-ghost {
    opacity: 0.4;
}

.sortable-drag {
    opacity: 0.8;
}

/* Dark theme support */
[data-bs-theme="dark"] .rack-visual {
    background: #0d1117;
}

[data-bs-theme="dark"] .rack-unit {
    background: #1a1d23;
    border-color: #30363d;
}

[data-bs-theme="dark"] .rack-toolbar {
    background: #161b22;
}

[data-bs-theme="dark"] .assets-sidebar {
    background: #0d1117;
}

[data-bs-theme="dark"] .asset-item {
    background: #161b22;
    border-color: #30363d;
}

[data-bs-theme="dark"] .asset-item:hover {
    background: #1f2937;
}
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2><i class="fas fa-server"></i> {{ rack.name }}</h2>
    <div>
        <a href="{% url 'monitoring:rack_device_create' rack.pk %}" class="btn btn-success btn-sm"><i class="fas fa-plus"></i> Add Asset to Rack</a>
        <a href="{% url 'assets:asset_create' %}?redirect=rack_{{ rack.pk }}" class="btn btn-outline-success btn-sm"><i class="fas fa-box"></i> Create New Asset</a>
        <div class="btn-group btn-group-sm ms-2">
            <a href="{% url 'monitoring:rack_edit' rack.pk %}" class="btn btn-primary"><i class="fas fa-edit"></i></a>
            <a href="{% url 'monitoring:rack_delete' rack.pk %}" class="btn btn-danger"><i class="fas fa-trash"></i></a>
        </div>
    </div>
</div>

<div class="row g-3">
    <!-- Info Card (Left) -->
    <div class="col-lg-3 col-md-12">
        <div class="card card-body p-3">
            <h6 class="mb-2"><i class="fas fa-info-circle"></i> Info</h6>
            <table class="table table-sm mb-0">
                <tr><td class="border-0 px-0"><small>Location</small></td><td class="border-0 px-0 text-end"><small>{{ rack.location|default:"—" }}</small></td></tr>
                <tr><td class="border-0 px-0"><small>Units</small></td><td class="border-0 px-0 text-end"><small>{{ rack.units }}U</small></td></tr>
                <tr><td class="border-0 px-0"><small>Available</small></td><td class="border-0 px-0 text-end"><small><span class="badge bg-success">{{ rack.available_units }}U</span></small></td></tr>
                {% if rack.power_capacity_watts %}
                <tr><td class="border-0 px-0"><small>Power</small></td><td class="border-0 px-0 text-end"><small>{{ rack.power_allocated_watts }}/{{ rack.power_capacity_watts }}W</small></td></tr>
                <tr><td colspan="2" class="border-0 px-0">
                    <div class="progress" style="height: 6px;">
                        <div class="progress-bar {% if rack.power_utilization_percent > 80 %}bg-danger{% elif rack.power_utilization_percent > 60 %}bg-warning{% else %}bg-success{% endif %}"
                             style="width: {{ rack.power_utilization_percent }}%"></div>
                    </div>
                </td></tr>
                {% endif %}
            </table>
        </div>
    </div>

    <!-- Main Content (Right) -->
    <div class="col-lg-9 col-md-12">
        <div class="card">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="visual-tab" data-bs-toggle="tab" data-bs-target="#visual" type="button" role="tab">
                            <i class="fas fa-th"></i> Rack Visual
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="assets-tab" data-bs-toggle="tab" data-bs-target="#assets" type="button" role="tab">
                            <i class="fas fa-list"></i> Mounted Assets <span class="badge bg-secondary">{{ devices.count }}</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="images-tab" data-bs-toggle="tab" data-bs-target="#images" type="button" role="tab">
                            <i class="fas fa-images"></i> Images <span class="badge bg-secondary">{{ rack_images.count }}</span>
                        </button>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content">
                    <!-- Rack Visual Tab -->
                    <div class="tab-pane fade show active" id="visual" role="tabpanel">
                        <div class="rack-visual-container">
                            <!-- Main Rack Area -->
                            <div class="rack-main-area">
                                <!-- Toolbar -->
                                <div class="rack-toolbar">
                                    <button id="zoom-in" class="btn btn-sm btn-outline-secondary">
                                        <i class="fas fa-search-plus"></i> Zoom In
                                    </button>
                                    <button id="zoom-out" class="btn btn-sm btn-outline-secondary">
                                        <i class="fas fa-search-minus"></i> Zoom Out
                                    </button>
                                    <button id="reset-view" class="btn btn-sm btn-outline-secondary">
                                        <i class="fas fa-undo"></i> Reset Zoom
                                    </button>
                                </div>

                                <!-- Rack Container -->
                                <div id="rack-container" class="rack-container" data-rack-id="{{ rack.id }}">
                                    <div id="rack-visual" class="rack-visual" data-units="{{ rack.units }}">
                                        <!-- Units rendered by JavaScript -->
                                    </div>
                                </div>

                                {% if rack_images %}
                                <div class="mt-3">
                                    <h6 class="mb-3"><i class="fas fa-camera"></i> Featured Images</h6>
                                    <div class="row g-2">
                                        {% for image in rack_images|slice:":4" %}
                                        <div class="col-6 col-md-3">
                                            <img src="{% url 'files:serve_attachment' image.id %}"
                                                 class="img-fluid rounded"
                                                 alt="{{ image.original_filename }}"
                                                 style="height: 120px; width: 100%; object-fit: cover; cursor: pointer;"
                                                 onclick="viewImage('{% url 'files:serve_attachment' image.id %}', '{{ image.original_filename }}')">
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% if rack_images.count > 4 %}
                                    <p class="text-muted small mt-2 mb-0">
                                        <i class="fas fa-info-circle"></i> Showing 4 of {{ rack_images.count }} images.
                                        <a href="#images" onclick="document.getElementById('images-tab').click();">View all</a>
                                    </p>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>

                            <!-- Available Assets Sidebar -->
                            {% if available_rack_assets %}
                            <div id="assets-sidebar" class="assets-sidebar">
                                <h6><i class="fas fa-server"></i> Available Assets</h6>
                                <div id="available-assets">
                                    {% for asset in available_rack_assets %}
                                    <div class="asset-item" data-asset-id="{{ asset.id }}" data-units="{{ asset.rack_units|default:'1' }}">
                                        <i class="fas fa-grip-vertical"></i>
                                        <span class="asset-name">{{ asset.name }}</span>
                                        <small class="text-muted asset-units">{{ asset.rack_units|default:'1' }}U</small>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Mounted Assets Tab -->
                    <div class="tab-pane fade" id="assets" role="tabpanel">
                        {% if devices %}
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Asset / Label</th>
                                        <th>Position</th>
                                        <th>Power</th>
                                        <th width="100"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for device in devices %}
                                    <tr>
                                        <td>
                                            <span class="badge" style="background-color: {{ device.color }};">▊</span>
                                            {{ device.name }}
                                            {% if device.asset %}
                                            <br><small class="text-muted"><i class="fas fa-link"></i> <a href="{% url 'assets:asset_detail' device.asset.pk %}">{{ device.asset.name }}</a></small>
                                            {% endif %}
                                        </td>
                                        <td>U{{ device.start_unit }}-{{ device.end_unit }}</td>
                                        <td>{% if device.power_draw_watts %}{{ device.power_draw_watts }}W{% else %}—{% endif %}</td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <a href="{% url 'monitoring:rack_device_edit' device.pk %}" class="btn btn-outline-primary"><i class="fas fa-edit"></i></a>
                                                <a href="{% url 'monitoring:rack_device_delete' device.pk %}" class="btn btn-outline-danger"><i class="fas fa-trash"></i></a>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-inbox fa-3x mb-3 opacity-50"></i>
                            <p>No assets mounted in this rack</p>
                            <a href="{% url 'monitoring:rack_device_create' rack.pk %}" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Add First Asset
                            </a>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Images Tab -->
                    <div class="tab-pane fade" id="images" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">All Images ({{ rack_images.count }})</h6>
                            <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#uploadImageModal">
                                <i class="fas fa-upload"></i> Upload Image
                            </button>
                        </div>

                        {% if rack_images %}
                        <div class="row g-3">
                            {% for image in rack_images %}
                            <div class="col-md-4 col-lg-3">
                                <div class="card h-100">
                                    <img src="{% url 'files:serve_attachment' image.id %}"
                                         class="card-img-top"
                                         alt="{{ image.original_filename }}"
                                         style="height: 180px; object-fit: cover; cursor: pointer;"
                                         onclick="viewImage('{% url 'files:serve_attachment' image.id %}', '{{ image.original_filename }}')">
                                    <div class="card-body p-2">
                                        <p class="card-text small mb-1" title="{{ image.original_filename }}">
                                            {{ image.original_filename|truncatechars:30 }}
                                        </p>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small class="text-muted">{{ image.file_size|filesizeformat }}</small>
                                            <button class="btn btn-sm btn-danger" onclick="deleteImage({{ image.id }}, this)" title="Delete">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-images fa-3x mb-3 opacity-50"></i>
                            <p>No images uploaded yet</p>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadImageModal">
                                <i class="fas fa-upload"></i> Upload First Image
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Upload Modal -->
<div class="modal fade" id="uploadImageModal" tabindex="-1" aria-labelledby="uploadImageModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="uploadImageModalLabel">Upload Rack Image</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="imageUploadForm" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" name="entity_type" value="rack">
                    <input type="hidden" name="entity_id" value="{{ rack.id }}">
                    <div class="mb-3">
                        <label for="imageFile" class="form-label">Select Image</label>
                        <input type="file" class="form-control" id="imageFile" name="file" accept="image/*" required>
                        <div class="form-text">Supported formats: JPG, PNG, GIF, SVG (max 25MB). Images are automatically optimized.</div>
                    </div>
                    <div class="mb-3">
                        <label for="imageDescription" class="form-label">Description (optional)</label>
                        <input type="text" class="form-control" id="imageDescription" name="description" placeholder="Brief description of the image">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="uploadImage()">
                    <i class="fas fa-upload"></i> Upload
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Image Viewer Modal -->
<div class="modal fade" id="imageViewerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageViewerTitle">Image</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img id="imageViewerImg" src="" alt="" style="max-width: 100%; height: auto;">
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- SortableJS Library -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
// Configuration
const RACK_ID = {{ rack.id }};
const RACK_UNITS = {{ rack.units }};
let ZOOM_LEVEL = 1.0;

// State management
let rackDevices = [];
let draggedAsset = null;

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    loadRackDevices();
    initializeToolbar();
});

// Load rack devices via API
function loadRackDevices() {
    fetch(`/monitoring/api/racks/${RACK_ID}/devices/`)
        .then(response => response.json())
        .then(data => {
            rackDevices = data.devices;
            renderRack();
        })
        .catch(error => {
            console.error('Failed to load rack devices:', error);
            showToast('Error loading rack data', 'danger');
        });
}

// Render the rack visualization
function renderRack() {
    const rackVisual = document.getElementById('rack-visual');
    rackVisual.innerHTML = '';

    // Create unit divs (top to bottom)
    for (let unit = RACK_UNITS; unit >= 1; unit--) {
        const device = getDeviceAtUnit(unit);
        const unitDiv = createUnitDiv(unit, device);
        rackVisual.appendChild(unitDiv);
    }

    // Initialize drag-and-drop
    initializeSortable();
}

// Create a unit div element
function createUnitDiv(unitNumber, device) {
    const div = document.createElement('div');
    div.classList.add('rack-unit');
    div.dataset.unit = unitNumber;

    if (device) {
        // Device occupies this unit
        const isStart = device.start_unit === unitNumber;
        div.classList.add('rack-device');
        div.style.backgroundColor = device.color;
        div.dataset.deviceId = device.id;
        div.dataset.startUnit = device.start_unit;
        div.dataset.units = device.units;

        if (isStart) {
            div.innerHTML = `
                <span class="rack-unit-number">${unitNumber}</span>
                <span class="device-name" title="${device.name}">${device.name}</span>
                <div class="device-resize-handle"></div>
            `;
            // Make the start unit draggable
            div.classList.add('draggable');
        } else {
            div.innerHTML = `<span class="rack-unit-number">${unitNumber}</span>`;
            div.classList.add('device-continuation');
        }
    } else {
        // Empty unit
        div.classList.add('rack-unit-empty');
        div.innerHTML = `
            <span class="rack-unit-number">${unitNumber}</span>
            <span class="empty-indicator"><i class="fas fa-plus"></i></span>
        `;
    }

    return div;
}

// Get device occupying a specific unit
function getDeviceAtUnit(unitNumber) {
    return rackDevices.find(d =>
        d.start_unit <= unitNumber &&
        unitNumber <= (d.start_unit + d.units - 1)
    );
}

// Initialize SortableJS for rack
function initializeSortable() {
    const rackVisual = document.getElementById('rack-visual');

    new Sortable(rackVisual, {
        animation: 200,
        handle: '.device-name',  // Drag by device name
        filter: '.device-continuation',  // Can't drag continuation units
        draggable: '.draggable',
        ghostClass: 'sortable-ghost',
        dragClass: 'sortable-drag',

        // On drag start
        onStart: function(evt) {
            const deviceId = evt.item.dataset.deviceId;
            const device = rackDevices.find(d => d.id == deviceId);
            console.log('Dragging device:', device.name);
        },

        // On drop
        onEnd: function(evt) {
            const deviceId = parseInt(evt.item.dataset.deviceId);
            const oldStartUnit = parseInt(evt.item.dataset.startUnit);

            // Calculate new start unit based on drop position
            // Index 0 = highest unit number, so reverse the calculation
            let newStartUnit = RACK_UNITS - evt.newIndex;

            // Update device position via API
            updateDevicePosition(deviceId, oldStartUnit, newStartUnit);
        }
    });

    // Initialize asset sidebar if it exists
    const assetsSidebar = document.getElementById('available-assets');
    if (assetsSidebar) {
        initializeAssetSidebar();
    }
}

// Initialize asset sidebar drag-and-drop
function initializeAssetSidebar() {
    const sidebar = document.getElementById('available-assets');

    new Sortable(sidebar, {
        group: {
            name: 'assets',
            pull: 'clone',
            put: false
        },
        animation: 200,
        sort: false,
        ghostClass: 'sortable-ghost',

        onEnd: function(evt) {
            // Remove the cloned element that was added to the rack
            if (evt.to.id === 'rack-visual') {
                evt.item.remove();
            }
        }
    });

    // Enable drop on rack visual
    const rackVisual = document.getElementById('rack-visual');
    const rackSortable = Sortable.get(rackVisual);

    // Create new Sortable for accepting assets
    new Sortable(rackVisual, {
        group: 'assets',
        animation: 200,

        onAdd: function(evt) {
            // Asset dropped onto rack
            const assetId = parseInt(evt.item.dataset.assetId);
            const units = parseInt(evt.item.dataset.units);

            // Calculate target unit based on drop index
            const targetUnit = RACK_UNITS - evt.newIndex;

            // Remove the cloned element
            evt.item.remove();

            // Create device from asset
            createDeviceFromAsset(assetId, targetUnit, units);
        }
    });
}

// Update device position via API
function updateDevicePosition(deviceId, oldStartUnit, newStartUnit) {
    const device = rackDevices.find(d => d.id === deviceId);

    // Check if position actually changed
    if (oldStartUnit === newStartUnit) {
        renderRack();  // Re-render to reset visual
        return;
    }

    // Show loading indicator
    showToast(`Moving ${device.name} to U${newStartUnit}...`, 'info');

    fetch(`/monitoring/api/rack-devices/${deviceId}/update-position/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            start_unit: newStartUnit,
            units: device.units
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error || !data.success) {
            showToast(data.error || 'Failed to move device', 'danger');
            renderRack();  // Revert visual
        } else {
            // Update local state
            const deviceIndex = rackDevices.findIndex(d => d.id === deviceId);
            rackDevices[deviceIndex].start_unit = newStartUnit;

            showToast(`${device.name} moved to U${newStartUnit}`, 'success');
            renderRack();  // Re-render with new position
        }
    })
    .catch(error => {
        console.error('Failed to update position:', error);
        showToast('Failed to update device position', 'danger');
        renderRack();  // Revert visual
    });
}

// Create device from dragged asset
function createDeviceFromAsset(assetId, startUnit, units) {
    showToast('Adding asset to rack...', 'info');

    fetch(`/monitoring/api/racks/${RACK_ID}/devices/create/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            asset_id: assetId,
            start_unit: startUnit,
            units: units
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error || !data.success) {
            showToast(data.error || 'Failed to add asset', 'danger');
        } else {
            rackDevices.push(data.device);
            showToast(`Asset added at U${startUnit}`, 'success');
            renderRack();

            // Reload page after short delay to update assets sidebar
            setTimeout(() => location.reload(), 1500);
        }
    })
    .catch(error => {
        console.error('Failed to create device:', error);
        showToast('Failed to add asset to rack', 'danger');
    });
}

// Toolbar functions
function initializeToolbar() {
    document.getElementById('zoom-in').addEventListener('click', () => setZoom(ZOOM_LEVEL + 0.1));
    document.getElementById('zoom-out').addEventListener('click', () => setZoom(ZOOM_LEVEL - 0.1));
    document.getElementById('reset-view').addEventListener('click', resetView);
}

function setZoom(level) {
    ZOOM_LEVEL = Math.max(0.5, Math.min(2.0, level));
    const container = document.getElementById('rack-container');
    container.style.transform = `scale(${ZOOM_LEVEL})`;
}

function resetView() {
    ZOOM_LEVEL = 1.0;
    const container = document.getElementById('rack-container');
    container.style.transform = 'scale(1.0)';
}

// Resize handle functionality
document.addEventListener('mousedown', function(e) {
    if (e.target.classList.contains('device-resize-handle')) {
        startResize(e);
    }
});

function startResize(e) {
    e.preventDefault();
    const handle = e.target;
    const deviceDiv = handle.closest('.rack-device');
    const deviceId = parseInt(deviceDiv.dataset.deviceId);
    const startY = e.clientY;
    const originalUnits = parseInt(deviceDiv.dataset.units);

    function onMouseMove(e) {
        const deltaY = e.clientY - startY;
        const newUnits = Math.max(1, originalUnits + Math.round(deltaY / 22));  // 22px per unit
        // Visual feedback only - don't commit until mouseup
        deviceDiv.style.height = `${newUnits * 22}px`;
    }

    function onMouseUp(e) {
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);

        const deltaY = e.clientY - startY;
        const newUnits = Math.max(1, originalUnits + Math.round(deltaY / 22));

        if (newUnits !== originalUnits) {
            updateDeviceSize(deviceId, newUnits);
        } else {
            renderRack();  // Revert visual
        }
    }

    document.addEventListener('mousemove', onMouseMove);
    document.addEventListener('mouseup', onMouseUp);
}

function updateDeviceSize(deviceId, newUnits) {
    const device = rackDevices.find(d => d.id === deviceId);
    showToast(`Resizing ${device.name} to ${newUnits}U...`, 'info');

    fetch(`/monitoring/api/rack-devices/${deviceId}/update-position/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            start_unit: device.start_unit,
            units: newUnits
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error || !data.success) {
            showToast(data.error || 'Failed to resize', 'danger');
            renderRack();
        } else {
            const deviceIndex = rackDevices.findIndex(d => d.id === deviceId);
            rackDevices[deviceIndex].units = newUnits;
            showToast(`${device.name} resized to ${newUnits}U`, 'success');
            renderRack();
        }
    })
    .catch(error => {
        console.error('Failed to resize device:', error);
        showToast('Failed to resize device', 'danger');
        renderRack();
    });
}

// Utility functions
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function showToast(message, type = 'info') {
    // Bootstrap toast notification
    const toastHTML = `
        <div class="toast align-items-center text-white bg-${type} border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;

    const toastContainer = document.getElementById('toast-container') || createToastContainer();
    toastContainer.insertAdjacentHTML('beforeend', toastHTML);
    const toastEl = toastContainer.lastElementChild;
    const toast = new bootstrap.Toast(toastEl, {autohide: true, delay: 3000});
    toast.show();

    toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
}

function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toast-container';
    container.classList.add('toast-container', 'position-fixed', 'top-0', 'end-0', 'p-3');
    container.style.zIndex = 9999;
    document.body.appendChild(container);
    return container;
}
</script>

<script>
function uploadImage() {
    const form = document.getElementById('imageUploadForm');
    const formData = new FormData(form);
    const uploadButton = event.target;

    uploadButton.disabled = true;
    uploadButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';

    fetch('{% url "files:upload_attachment" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => {
        if (response.ok) {
            location.reload();
        } else {
            return response.json().then(data => {
                throw new Error(data.error || 'Upload failed');
            });
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
        uploadButton.disabled = false;
        uploadButton.innerHTML = '<i class="fas fa-upload"></i> Upload';
    });
}

function viewImage(url, filename) {
    document.getElementById('imageViewerTitle').textContent = filename;
    document.getElementById('imageViewerImg').src = url;
    const modal = new bootstrap.Modal(document.getElementById('imageViewerModal'));
    modal.show();
}

function deleteImage(imageId, button) {
    if (!confirm('Are you sure you want to delete this image?')) {
        return;
    }

    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

    fetch(`/files/attachments/${imageId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => {
        if (response.ok) {
            location.reload();
        } else {
            return response.json().then(data => {
                throw new Error(data.error || 'Delete failed');
            });
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-trash"></i>';
    });
}
</script>
{% endblock %}

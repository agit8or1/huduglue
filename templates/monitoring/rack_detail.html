{% extends "base.html" %}

{% block title %}{{ rack.name }} - Client St0r{% endblock %}

{% block extra_css %}
<style>
.rack-visual-container {
    display: flex;
    gap: 20px;
    align-items: flex-start;
}

.rack-main-area {
    flex: 1;
}

.rack-container {
    overflow: auto;
    transform-origin: top left;
    transition: transform 0.3s ease;
}

.rack-toolbar {
    display: flex;
    gap: 8px;
    margin-bottom: 12px;
    padding: 8px;
    background: var(--bs-light);
    border-radius: 6px;
    flex-wrap: wrap;
}

.rack-visual {
    border: 2px solid #495057;
    background: #212529;
    padding: 8px;
    border-radius: 6px;
    max-width: 350px;
    min-width: 300px;
    transition: transform 0.3s ease;
}

.rack-unit {
    height: 22px;
    border: 1px solid #495057;
    background: #343a40;
    margin-bottom: 1px;
    display: flex;
    align-items: center;
    padding: 0 6px;
    font-size: 0.7rem;
    color: #e9ecef;
    position: relative;
}

.rack-unit-number {
    width: 24px;
    text-align: center;
    font-weight: bold;
    font-size: 0.65rem;
    color: #f8f9fa;
    flex-shrink: 0;
}

.rack-device {
    color: white;
    cursor: move;
    user-select: none;
}

.rack-device:hover {
    opacity: 0.9;
    box-shadow: 0 0 8px rgba(255,255,255,0.3);
}

.rack-device.draggable .device-name {
    cursor: grab;
}

.rack-device.draggable .device-name:active {
    cursor: grabbing;
}

.device-name {
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    font-size: 0.65rem;
}

.device-resize-handle {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: rgba(255,255,255,0.2);
    cursor: ns-resize;
    opacity: 0;
    transition: opacity 0.2s;
}

.rack-device:hover .device-resize-handle {
    opacity: 1;
}

.device-continuation {
    cursor: default;
    border-top: none;
}

.rack-unit-empty {
    cursor: pointer;
    transition: all 0.15s ease;
}

.rack-unit-empty:hover {
    background: #495057;
    border-color: #6c757d;
}

.rack-unit-empty .empty-indicator {
    opacity: 0.3;
    font-size: 0.6rem;
    margin-left: auto;
}

.assets-sidebar {
    width: 250px;
    background: var(--bs-light);
    border-radius: 6px;
    padding: 12px;
    max-height: 600px;
    overflow-y: auto;
    flex-shrink: 0;
}

.assets-sidebar h6 {
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--bs-border-color);
}

.asset-item {
    padding: 8px;
    margin-bottom: 6px;
    background: white;
    border: 1px solid var(--bs-border-color);
    border-radius: 4px;
    cursor: move;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s;
    user-select: none;
}

.asset-item:hover {
    background: var(--bs-primary-bg-subtle);
    border-color: var(--bs-primary);
    transform: translateX(4px);
}

.asset-item .fas.fa-grip-vertical {
    color: var(--bs-secondary);
}

.asset-item .asset-name {
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.asset-item .asset-units {
    font-size: 0.75rem;
}

/* Sortable ghost/drag styles */
.sortable-ghost {
    opacity: 0.4;
}

.sortable-drag {
    opacity: 0.8;
}

/* Dark theme support */
[data-bs-theme="dark"] .rack-visual {
    background: #0d1117;
}

[data-bs-theme="dark"] .rack-unit {
    background: #1a1d23;
    border-color: #30363d;
}

[data-bs-theme="dark"] .rack-toolbar {
    background: #161b22;
}

[data-bs-theme="dark"] .assets-sidebar {
    background: #0d1117;
}

[data-bs-theme="dark"] .asset-item {
    background: #161b22;
    border-color: #30363d;
}

[data-bs-theme="dark"] .asset-item:hover {
    background: #1f2937;
}

/* Board Layout Styles */
.board-layout-container {
    position: relative;
    background: #f8f9fa;
    border: 2px solid #495057;
    border-radius: 6px;
    overflow: hidden;
}

.board-canvas {
    width: 100%;
    height: 600px;
    position: relative;
    cursor: crosshair;
}

.board-grid-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    background-image:
        repeating-linear-gradient(0deg, transparent, transparent 49px, rgba(0,0,0,0.1) 49px, rgba(0,0,0,0.1) 50px),
        repeating-linear-gradient(90deg, transparent, transparent 49px, rgba(0,0,0,0.1) 49px, rgba(0,0,0,0.1) 50px);
    opacity: 0;
    transition: opacity 0.3s;
}

.board-grid-overlay.active {
    opacity: 1;
}

.board-device {
    position: absolute;
    border: 2px solid #495057;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: move;
    user-select: none;
    background: #6c757d;
    color: white;
    font-size: 0.8rem;
    font-weight: 500;
    text-align: center;
    padding: 8px;
    overflow: hidden;
    text-overflow: ellipsis;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    transition: box-shadow 0.2s;
}

.board-device:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    z-index: 10;
}

.board-device.dragging {
    opacity: 0.7;
    cursor: grabbing;
}

.board-device-label {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.board-resize-handle {
    position: absolute;
    bottom: 0;
    right: 0;
    width: 12px;
    height: 12px;
    background: rgba(255,255,255,0.3);
    cursor: nwse-resize;
    border-top-left-radius: 4px;
}

.layout-toggle-buttons {
    display: flex;
    gap: 4px;
    margin-left: auto;
}

[data-bs-theme="dark"] .board-layout-container {
    background: #0d1117;
}

[data-bs-theme="dark"] .board-grid-overlay {
    background-image:
        repeating-linear-gradient(0deg, transparent, transparent 49px, rgba(255,255,255,0.1) 49px, rgba(255,255,255,0.1) 50px),
        repeating-linear-gradient(90deg, transparent, transparent 49px, rgba(255,255,255,0.1) 49px, rgba(255,255,255,0.1) 50px);
}

/* Device Visual Indicators */
.device-visual {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    margin-right: 4px;
    font-size: 0.6rem;
}

.device-image {
    max-width: 40px;
    height: auto;
    border-radius: 2px;
    background: rgba(255,255,255,0.1);
    padding: 1px;
}

.led-row {
    display: flex;
    gap: 2px;
    align-items: center;
}

.led {
    width: 4px;
    height: 4px;
    border-radius: 50%;
    display: inline-block;
    box-shadow: 0 0 2px currentColor;
}

.led-green {
    background: #28a745;
    box-shadow: 0 0 4px #28a745;
}

.led-amber {
    background: #ffc107;
    box-shadow: 0 0 4px #ffc107;
}

.led-blue {
    background: #17a2b8;
    box-shadow: 0 0 4px #17a2b8;
}

.led-red {
    background: #dc3545;
    box-shadow: 0 0 4px #dc3545;
}

.drive-bays, .port-indicators, .port-grid, .outlet-indicators {
    font-size: 0.55rem;
    line-height: 1;
    letter-spacing: 1px;
    opacity: 0.8;
    white-space: nowrap;
}

.server-visual {
    flex-direction: column;
    align-items: flex-start;
}

.switch-visual, .patch-panel-visual {
    flex-direction: row;
}

.power-visual {
    flex-direction: column;
    align-items: flex-start;
}

.storage-visual {
    flex-direction: column;
    align-items: flex-start;
}

/* Board device enhanced styling */
.board-device.has-image {
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
}

.board-device-content {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    padding: 8px;
    background: rgba(0,0,0,0.2);
}

.board-device-image {
    width: 100%;
    height: 70%;
    object-fit: contain;
    margin-bottom: 4px;
}

.board-device-ports {
    display: grid;
    grid-template-columns: repeat(auto-fill, 6px);
    gap: 2px;
    margin-top: auto;
    font-size: 0.5rem;
}

.board-port-indicator {
    width: 6px;
    height: 6px;
    background: rgba(255,255,255,0.3);
    border-radius: 50%;
}

.board-port-indicator.active {
    background: #28a745;
    box-shadow: 0 0 3px #28a745;
}
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2><i class="fas fa-server"></i> {{ rack.name }}</h2>
    <div>
        <a href="{% url 'monitoring:rack_device_create' rack.pk %}" class="btn btn-success btn-sm"><i class="fas fa-plus"></i> Add Asset to Rack</a>
        <a href="{% url 'assets:asset_create' %}?redirect=rack_{{ rack.pk }}" class="btn btn-outline-success btn-sm"><i class="fas fa-box"></i> Create New Asset</a>
        <div class="btn-group btn-group-sm ms-2">
            <a href="{% url 'monitoring:rack_edit' rack.pk %}" class="btn btn-primary"><i class="fas fa-edit"></i></a>
            <a href="{% url 'monitoring:rack_delete' rack.pk %}" class="btn btn-danger"><i class="fas fa-trash"></i></a>
        </div>
    </div>
</div>

<div class="row g-3">
    <!-- Info Card (Left) -->
    <div class="col-lg-3 col-md-12">
        <div class="card card-body p-3">
            <h6 class="mb-2"><i class="fas fa-info-circle"></i> Info</h6>
            <table class="table table-sm mb-0">
                <tr><td class="border-0 px-0"><small>Location</small></td><td class="border-0 px-0 text-end"><small>{{ rack.location|default:"‚Äî" }}</small></td></tr>
                <tr><td class="border-0 px-0"><small>Units</small></td><td class="border-0 px-0 text-end"><small>{{ rack.units }}U</small></td></tr>
                <tr><td class="border-0 px-0"><small>Available</small></td><td class="border-0 px-0 text-end"><small><span class="badge bg-success">{{ rack.available_units }}U</span></small></td></tr>
                {% if rack.power_capacity_watts %}
                <tr><td class="border-0 px-0"><small>Power</small></td><td class="border-0 px-0 text-end"><small>{{ rack.power_allocated_watts }}/{{ rack.power_capacity_watts }}W</small></td></tr>
                <tr><td colspan="2" class="border-0 px-0">
                    <div class="progress" style="height: 6px;">
                        <div class="progress-bar {% if rack.power_utilization_percent > 80 %}bg-danger{% elif rack.power_utilization_percent > 60 %}bg-warning{% else %}bg-success{% endif %}"
                             style="width: {{ rack.power_utilization_percent }}%"></div>
                    </div>
                </td></tr>
                {% endif %}
            </table>
        </div>
    </div>

    <!-- Main Content (Right) -->
    <div class="col-lg-9 col-md-12">
        <div class="card">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="visual-tab" data-bs-toggle="tab" data-bs-target="#visual" type="button" role="tab">
                            <i class="fas fa-th"></i> Rack Visual
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="assets-tab" data-bs-toggle="tab" data-bs-target="#assets" type="button" role="tab">
                            <i class="fas fa-list"></i> Mounted Assets <span class="badge bg-secondary">{{ devices.count }}</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="images-tab" data-bs-toggle="tab" data-bs-target="#images" type="button" role="tab">
                            <i class="fas fa-images"></i> Images <span class="badge bg-secondary">{{ rack_images.count }}</span>
                        </button>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content">
                    <!-- Rack Visual Tab -->
                    <div class="tab-pane fade show active" id="visual" role="tabpanel">
                        <div class="rack-visual-container">
                            <!-- Main Rack Area -->
                            <div class="rack-main-area">
                                <!-- Toolbar -->
                                <div class="rack-toolbar">
                                    <div class="layout-toggle-buttons">
                                        <button id="toggle-rack-view" class="btn btn-sm btn-outline-primary active">
                                            <i class="fas fa-server"></i> Rack View
                                        </button>
                                        <button id="toggle-board-view" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-th"></i> Board View
                                        </button>
                                    </div>
                                    <button id="toggle-grid" class="btn btn-sm btn-outline-secondary" style="display: none;">
                                        <i class="fas fa-border-all"></i> Snap to Grid
                                    </button>
                                    <button id="zoom-in" class="btn btn-sm btn-outline-secondary">
                                        <i class="fas fa-search-plus"></i> Zoom In
                                    </button>
                                    <button id="zoom-out" class="btn btn-sm btn-outline-secondary">
                                        <i class="fas fa-search-minus"></i> Zoom Out
                                    </button>
                                    <button id="reset-view" class="btn btn-sm btn-outline-secondary">
                                        <i class="fas fa-undo"></i> Reset
                                    </button>
                                </div>

                                <!-- Rack Container -->
                                <div id="rack-container" class="rack-container" data-rack-id="{{ rack.id }}">
                                    <div id="rack-visual" class="rack-visual" data-units="{{ rack.units }}">
                                        <!-- Units rendered by JavaScript -->
                                    </div>
                                </div>

                                <!-- Board Layout Container -->
                                <div id="board-container" class="board-layout-container" style="display: none;">
                                    <div id="board-canvas" class="board-canvas">
                                        <!-- Devices rendered by JavaScript -->
                                    </div>
                                    <div id="board-grid-overlay" class="board-grid-overlay"></div>
                                </div>

                                {% if rack_images %}
                                <div class="mt-3">
                                    <h6 class="mb-3"><i class="fas fa-camera"></i> Featured Images</h6>
                                    <div class="row g-2">
                                        {% for image in rack_images|slice:":4" %}
                                        <div class="col-6 col-md-3">
                                            <img src="{% url 'files:serve_attachment' image.id %}"
                                                 class="img-fluid rounded"
                                                 alt="{{ image.original_filename }}"
                                                 style="height: 120px; width: 100%; object-fit: cover; cursor: pointer;"
                                                 onclick="viewImage('{% url 'files:serve_attachment' image.id %}', '{{ image.original_filename }}')">
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% if rack_images.count > 4 %}
                                    <p class="text-muted small mt-2 mb-0">
                                        <i class="fas fa-info-circle"></i> Showing 4 of {{ rack_images.count }} images.
                                        <a href="#images" onclick="document.getElementById('images-tab').click();">View all</a>
                                    </p>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>

                            <!-- Available Assets Sidebar -->
                            {% if available_rack_assets %}
                            <div id="assets-sidebar" class="assets-sidebar">
                                <h6><i class="fas fa-server"></i> Available Assets</h6>
                                <div id="available-assets">
                                    {% for asset in available_rack_assets %}
                                    <div class="asset-item" data-asset-id="{{ asset.id }}" data-units="{{ asset.rack_units|default:'1' }}">
                                        <i class="fas fa-grip-vertical"></i>
                                        <span class="asset-name">{{ asset.name }}</span>
                                        <small class="text-muted asset-units">{{ asset.rack_units|default:'1' }}U</small>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Mounted Assets Tab -->
                    <div class="tab-pane fade" id="assets" role="tabpanel">
                        {% if devices %}
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Asset / Label</th>
                                        <th>Position</th>
                                        <th>Power</th>
                                        <th width="100"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for device in devices %}
                                    <tr>
                                        <td>
                                            <span class="badge" style="background-color: {{ device.color }};">‚ñä</span>
                                            {{ device.name }}
                                            {% if device.asset %}
                                            <br><small class="text-muted"><i class="fas fa-link"></i> <a href="{% url 'assets:asset_detail' device.asset.pk %}">{{ device.asset.name }}</a></small>
                                            {% endif %}
                                        </td>
                                        <td>U{{ device.start_unit }}-{{ device.end_unit }}</td>
                                        <td>{% if device.power_draw_watts %}{{ device.power_draw_watts }}W{% else %}‚Äî{% endif %}</td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <a href="{% url 'monitoring:rack_device_edit' device.pk %}" class="btn btn-outline-primary"><i class="fas fa-edit"></i></a>
                                                <a href="{% url 'monitoring:rack_device_delete' device.pk %}" class="btn btn-outline-danger"><i class="fas fa-trash"></i></a>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-inbox fa-3x mb-3 opacity-50"></i>
                            <p>No assets mounted in this rack</p>
                            <a href="{% url 'monitoring:rack_device_create' rack.pk %}" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Add First Asset
                            </a>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Images Tab -->
                    <div class="tab-pane fade" id="images" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">All Images ({{ rack_images.count }})</h6>
                            <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#uploadImageModal">
                                <i class="fas fa-upload"></i> Upload Image
                            </button>
                        </div>

                        {% if rack_images %}
                        <div class="row g-3">
                            {% for image in rack_images %}
                            <div class="col-md-4 col-lg-3">
                                <div class="card h-100">
                                    <img src="{% url 'files:serve_attachment' image.id %}"
                                         class="card-img-top"
                                         alt="{{ image.original_filename }}"
                                         style="height: 180px; object-fit: cover; cursor: pointer;"
                                         onclick="viewImage('{% url 'files:serve_attachment' image.id %}', '{{ image.original_filename }}')">
                                    <div class="card-body p-2">
                                        <p class="card-text small mb-1" title="{{ image.original_filename }}">
                                            {{ image.original_filename|truncatechars:30 }}
                                        </p>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small class="text-muted">{{ image.file_size|filesizeformat }}</small>
                                            <button class="btn btn-sm btn-danger" onclick="deleteImage({{ image.id }}, this)" title="Delete">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-images fa-3x mb-3 opacity-50"></i>
                            <p>No images uploaded yet</p>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadImageModal">
                                <i class="fas fa-upload"></i> Upload First Image
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Upload Modal -->
<div class="modal fade" id="uploadImageModal" tabindex="-1" aria-labelledby="uploadImageModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="uploadImageModalLabel">Upload Rack Image</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="imageUploadForm" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" name="entity_type" value="rack">
                    <input type="hidden" name="entity_id" value="{{ rack.id }}">
                    <div class="mb-3">
                        <label for="imageFile" class="form-label">Select Image</label>
                        <input type="file" class="form-control" id="imageFile" name="file" accept="image/*" required>
                        <div class="form-text">Supported formats: JPG, PNG, GIF, SVG (max 25MB). Images are automatically optimized.</div>
                    </div>
                    <div class="mb-3">
                        <label for="imageDescription" class="form-label">Description (optional)</label>
                        <input type="text" class="form-control" id="imageDescription" name="description" placeholder="Brief description of the image">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="uploadImage()">
                    <i class="fas fa-upload"></i> Upload
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Image Viewer Modal -->
<div class="modal fade" id="imageViewerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageViewerTitle">Image</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img id="imageViewerImg" src="" alt="" style="max-width: 100%; height: auto;">
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- SortableJS Library -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
// Configuration
const RACK_ID = {{ rack.id }};
const RACK_UNITS = {{ rack.units }};
let ZOOM_LEVEL = 1.0;
const GRID_SIZE = 50; // Grid cell size in pixels

// State management
let rackDevices = [];
let rackResources = [];
let draggedAsset = null;
let currentView = 'rack'; // 'rack' or 'board'
let snapToGrid = false;
let boardDragState = null;

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing rack view...');

    // Check if Sortable is loaded
    if (typeof Sortable === 'undefined') {
        console.error('SortableJS library not loaded!');
        showToast('Error: Drag-and-drop library failed to load', 'danger');
        return;
    }

    console.log('SortableJS loaded successfully');
    loadRackDevices();
    initializeToolbar();
});

// Load rack devices via API
function loadRackDevices() {
    fetch(`/monitoring/api/racks/${RACK_ID}/devices/`)
        .then(response => response.json())
        .then(data => {
            rackDevices = data.devices;
            renderCurrentView();
        })
        .catch(error => {
            console.error('Failed to load rack devices:', error);
            showToast('Error loading rack data', 'danger');
        });

    // Also load resources for board view
    fetch(`/monitoring/api/racks/${RACK_ID}/resources/`)
        .then(response => response.json())
        .then(data => {
            rackResources = data.resources || [];
            renderCurrentView();
        })
        .catch(error => {
            console.error('Failed to load rack resources:', error);
        });
}

// Render current view (rack or board)
function renderCurrentView() {
    if (currentView === 'rack') {
        renderRack();
    } else {
        renderBoard();
    }
}

// Render the rack visualization
function renderRack() {
    console.log('Rendering rack with', rackDevices.length, 'devices');
    const rackVisual = document.getElementById('rack-visual');

    if (!rackVisual) {
        console.error('rack-visual element not found!');
        return;
    }

    rackVisual.innerHTML = '';

    // Create unit divs (top to bottom)
    for (let unit = RACK_UNITS; unit >= 1; unit--) {
        const device = getDeviceAtUnit(unit);
        const unitDiv = createUnitDiv(unit, device);
        rackVisual.appendChild(unitDiv);
    }

    // Initialize drag-and-drop
    try {
        initializeSortable();
        console.log('Sortable initialized successfully');
    } catch (error) {
        console.error('Error initializing Sortable:', error);
        showToast('Error initializing drag-and-drop: ' + error.message, 'danger');
    }
}

// Create a unit div element
function createUnitDiv(unitNumber, device) {
    const div = document.createElement('div');
    div.classList.add('rack-unit');
    div.dataset.unit = unitNumber;

    if (device) {
        // Device occupies this unit
        const isStart = device.start_unit === unitNumber;
        div.classList.add('rack-device');
        div.style.backgroundColor = device.color;
        div.dataset.deviceId = device.id;
        div.dataset.startUnit = device.start_unit;
        div.dataset.units = device.units;

        if (isStart) {
            // Enhanced visual representation
            const visual = getDeviceVisualHTML(device);
            div.innerHTML = `
                <span class="rack-unit-number">${unitNumber}</span>
                ${visual}
                <span class="device-name" title="${device.name}">${device.name}</span>
                <div class="device-resize-handle"></div>
            `;
            // Make the start unit draggable
            div.classList.add('draggable');
        } else {
            div.innerHTML = `<span class="rack-unit-number">${unitNumber}</span>`;
            div.classList.add('device-continuation');
        }
    } else {
        // Empty unit
        div.classList.add('rack-unit-empty');
        div.innerHTML = `
            <span class="rack-unit-number">${unitNumber}</span>
            <span class="empty-indicator"><i class="fas fa-plus"></i></span>
        `;
    }

    return div;
}

// Get visual HTML for device based on equipment type
function getDeviceVisualHTML(device) {
    const assetType = device.asset_type || 'other';
    const units = device.units || 1;

    // Check if device has equipment image
    if (device.equipment_image_url) {
        return `<img src="${device.equipment_image_url}" class="device-image" alt="${device.name}" style="height: ${units * 22}px; object-fit: contain; margin-right: 4px;">`;
    }

    // Generate visual indicators based on equipment type
    let indicators = '';

    switch(assetType) {
        case 'server':
            // Server with drive bays and status LEDs
            indicators = `<div class="device-visual server-visual">
                <div class="led-row">
                    <span class="led led-green"></span>
                    <span class="led led-amber"></span>
                </div>
                <div class="drive-bays">${'‚ñØ'.repeat(Math.min(units * 2, 8))}</div>
            </div>`;
            break;

        case 'switch':
        case 'router':
        case 'firewall':
            // Network device with port indicators
            const portCount = device.port_count || 24;
            const displayPorts = Math.min(portCount, units * 12);
            indicators = `<div class="device-visual switch-visual">
                <div class="port-indicators">${'‚óè'.repeat(displayPorts)}</div>
                <div class="led-row">
                    <span class="led led-green"></span>
                </div>
            </div>`;
            break;

        case 'patch_panel':
        case 'fiber_panel':
            // Patch panel with port grid
            const panelPorts = device.port_count || 24;
            indicators = `<div class="device-visual patch-panel-visual">
                <div class="port-grid">${'‚óØ'.repeat(Math.min(panelPorts, units * 24))}</div>
            </div>`;
            break;

        case 'ups':
        case 'pdu':
            // Power device with outlet indicators
            indicators = `<div class="device-visual power-visual">
                <div class="led-row">
                    <span class="led led-green"></span>
                    <span class="led led-green"></span>
                </div>
                <div class="outlet-indicators">‚ö° ${'‚óº'.repeat(8)}</div>
            </div>`;
            break;

        case 'storage':
        case 'nas':
        case 'san':
            // Storage device with drive indicators
            indicators = `<div class="device-visual storage-visual">
                <div class="drive-bays">${'‚ñØ'.repeat(units * 4)}</div>
                <div class="led-row">
                    <span class="led led-blue"></span>
                    <span class="led led-green"></span>
                </div>
            </div>`;
            break;

        default:
            // Generic device with LED
            indicators = `<div class="device-visual generic-visual">
                <span class="led led-green"></span>
            </div>`;
    }

    return indicators;
}

// Get device occupying a specific unit
function getDeviceAtUnit(unitNumber) {
    return rackDevices.find(d =>
        d.start_unit <= unitNumber &&
        unitNumber <= (d.start_unit + d.units - 1)
    );
}

// Initialize SortableJS for rack
function initializeSortable() {
    const rackVisual = document.getElementById('rack-visual');
    console.log('Initializing Sortable on rack-visual');

    if (!rackVisual) {
        console.error('rack-visual element not found');
        return;
    }

    // Destroy existing sortable if any
    const existingSortable = Sortable.get(rackVisual);
    if (existingSortable) {
        console.log('Destroying existing Sortable instance');
        existingSortable.destroy();
    }

    // Create single Sortable instance with group support
    console.log('Creating new Sortable instance');
    const sortableInstance = new Sortable(rackVisual, {
        group: {
            name: 'rack',
            pull: false,
            put: ['assets']  // Can accept assets from sidebar
        },
        animation: 200,
        // Removed handle restriction - drag entire device
        filter: '.device-continuation, .rack-unit-empty',  // Can't drag continuation units or empty spaces
        draggable: '.draggable',
        ghostClass: 'sortable-ghost',
        dragClass: 'sortable-drag',
        forceFallback: true,  // Use fallback for better compatibility
        fallbackClass: 'sortable-fallback',
        fallbackOnBody: true,

        // On drag start
        onStart: function(evt) {
            const deviceId = evt.item.dataset.deviceId;
            if (deviceId) {
                const device = rackDevices.find(d => d.id == deviceId);
                if (device) {
                    console.log('Dragging device:', device.name);
                }
            }
        },

        // On drop (device repositioned)
        onEnd: function(evt) {
            const deviceId = parseInt(evt.item.dataset.deviceId);
            const oldStartUnit = parseInt(evt.item.dataset.startUnit);

            if (deviceId && oldStartUnit) {
                // Calculate new start unit based on drop position
                let newStartUnit = RACK_UNITS - evt.newIndex;
                // Update device position via API
                updateDevicePosition(deviceId, oldStartUnit, newStartUnit);
            }
        },

        // On asset added from sidebar
        onAdd: function(evt) {
            const assetId = parseInt(evt.item.dataset.assetId);
            const units = parseInt(evt.item.dataset.units);

            if (assetId) {
                // Calculate target unit based on drop index
                const targetUnit = RACK_UNITS - evt.newIndex;

                // Remove the cloned element
                evt.item.remove();

                // Create device from asset
                createDeviceFromAsset(assetId, targetUnit, units);
            }
        }
    });

    // Initialize asset sidebar if it exists
    const assetsSidebar = document.getElementById('available-assets');
    if (assetsSidebar) {
        console.log('Initializing asset sidebar');
        initializeAssetSidebar();
    } else {
        console.log('No asset sidebar found');
    }

    // Log draggable elements count
    const draggableCount = rackVisual.querySelectorAll('.draggable').length;
    console.log(`Found ${draggableCount} draggable devices in rack`);

    return sortableInstance;
}

// Initialize asset sidebar drag-and-drop
function initializeAssetSidebar() {
    const sidebar = document.getElementById('available-assets');

    // Destroy existing sortable if any
    const existingSortable = Sortable.get(sidebar);
    if (existingSortable) {
        existingSortable.destroy();
    }

    new Sortable(sidebar, {
        group: {
            name: 'assets',
            pull: 'clone',
            put: false
        },
        animation: 200,
        sort: false,
        ghostClass: 'sortable-ghost'
    });
}

// Update device position via API
function updateDevicePosition(deviceId, oldStartUnit, newStartUnit) {
    const device = rackDevices.find(d => d.id === deviceId);

    // Check if position actually changed
    if (oldStartUnit === newStartUnit) {
        renderRack();  // Re-render to reset visual
        return;
    }

    // Show loading indicator
    showToast(`Moving ${device.name} to U${newStartUnit}...`, 'info');

    fetch(`/monitoring/api/rack-devices/${deviceId}/update-position/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            start_unit: newStartUnit,
            units: device.units
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error || !data.success) {
            showToast(data.error || 'Failed to move device', 'danger');
            renderRack();  // Revert visual
        } else {
            // Update local state
            const deviceIndex = rackDevices.findIndex(d => d.id === deviceId);
            rackDevices[deviceIndex].start_unit = newStartUnit;

            showToast(`${device.name} moved to U${newStartUnit}`, 'success');
            renderRack();  // Re-render with new position
        }
    })
    .catch(error => {
        console.error('Failed to update position:', error);
        showToast('Failed to update device position', 'danger');
        renderRack();  // Revert visual
    });
}

// Create device from dragged asset
function createDeviceFromAsset(assetId, startUnit, units) {
    showToast('Adding asset to rack...', 'info');

    fetch(`/monitoring/api/racks/${RACK_ID}/devices/create/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            asset_id: assetId,
            start_unit: startUnit,
            units: units
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error || !data.success) {
            showToast(data.error || 'Failed to add asset', 'danger');
        } else {
            rackDevices.push(data.device);
            showToast(`Asset added at U${startUnit}`, 'success');
            renderRack();

            // Reload page after short delay to update assets sidebar
            setTimeout(() => location.reload(), 1500);
        }
    })
    .catch(error => {
        console.error('Failed to create device:', error);
        showToast('Failed to add asset to rack', 'danger');
    });
}

// ============================================================================
// BOARD LAYOUT FUNCTIONS
// ============================================================================

// Render board layout view
function renderBoard() {
    const boardCanvas = document.getElementById('board-canvas');
    boardCanvas.innerHTML = '';

    // Render devices on board
    rackDevices.forEach(device => {
        if (device.board_position_x !== null && device.board_position_y !== null) {
            createBoardDevice(device, 'device');
        }
    });

    // Render resources on board
    rackResources.forEach(resource => {
        if (resource.board_position_x !== null && resource.board_position_y !== null) {
            createBoardDevice(resource, 'resource');
        }
    });

    // Initialize drag-and-drop for board
    initializeBoardDragDrop();
}

// Create a board device element
function createBoardDevice(item, type) {
    const boardCanvas = document.getElementById('board-canvas');
    const div = document.createElement('div');
    div.classList.add('board-device');
    div.dataset.itemId = item.id;
    div.dataset.itemType = type;

    // Position and size
    div.style.left = item.board_position_x + 'px';
    div.style.top = item.board_position_y + 'px';
    div.style.width = (item.board_width || 150) + 'px';
    div.style.height = (item.board_height || 100) + 'px';
    div.style.backgroundColor = item.color || '#6c757d';

    // Enhanced visual content
    const content = getBoardDeviceContent(item);
    div.innerHTML = `
        <div class="board-device-content">
            ${content}
            <div class="board-device-label">${item.name}</div>
        </div>
        <div class="board-resize-handle"></div>
    `;

    boardCanvas.appendChild(div);
}

// Get enhanced content for board device
function getBoardDeviceContent(item) {
    const assetType = item.asset_type || 'other';

    // If equipment has image, show it
    if (item.equipment_image_url) {
        return `<img src="${item.equipment_image_url}" class="board-device-image" alt="${item.name}">`;
    }

    // Generate visual representation based on type
    let visual = '';

    switch(assetType) {
        case 'server':
            visual = `
                <div class="led-row" style="margin-bottom: 4px;">
                    <span class="led led-green"></span>
                    <span class="led led-amber"></span>
                    <span class="led led-blue"></span>
                </div>
                <div class="drive-bays" style="font-size: 0.7rem;">
                    ${'‚ñØ‚ñØ‚ñØ‚ñØ<br>'.repeat(3)}
                </div>
            `;
            break;

        case 'switch':
        case 'router':
        case 'firewall':
            const portCount = item.port_count || 24;
            const rows = Math.ceil(portCount / 12);
            let portHTML = '';
            for (let i = 0; i < rows; i++) {
                portHTML += '<div class="board-device-ports">';
                for (let j = 0; j < Math.min(12, portCount - (i * 12)); j++) {
                    const active = Math.random() > 0.5 ? 'active' : '';
                    portHTML += `<span class="board-port-indicator ${active}"></span>`;
                }
                portHTML += '</div>';
            }
            visual = `
                <div class="led-row" style="margin-bottom: 4px;">
                    <span class="led led-green"></span>
                    <span style="font-size: 0.6rem; margin-left: 4px;">${portCount} Ports</span>
                </div>
                ${portHTML}
            `;
            break;

        case 'patch_panel':
        case 'fiber_panel':
            const panelPorts = item.port_count || 24;
            let panelHTML = '<div class="board-device-ports" style="grid-template-columns: repeat(12, 8px);">';
            for (let i = 0; i < panelPorts; i++) {
                panelHTML += '<span class="board-port-indicator"></span>';
            }
            panelHTML += '</div>';
            visual = `
                <div style="font-size: 0.6rem; margin-bottom: 4px;">${panelPorts} Port Panel</div>
                ${panelHTML}
            `;
            break;

        case 'ups':
        case 'pdu':
            visual = `
                <div class="led-row" style="margin-bottom: 4px;">
                    <span class="led led-green"></span>
                    <span class="led led-green"></span>
                    <span style="font-size: 0.6rem; margin-left: 4px;">AC Power</span>
                </div>
                <div style="font-size: 0.7rem;">‚ö° ${'‚óº '.repeat(4)}</div>
            `;
            break;

        case 'wireless_ap':
            visual = `
                <div class="led-row" style="margin-bottom: 4px;">
                    <span class="led led-blue"></span>
                    <span class="led led-green"></span>
                </div>
                <div style="font-size: 1.5rem; text-align: center;">üì°</div>
            `;
            break;

        case 'security_camera':
        case 'camera':
            visual = `
                <div class="led-row" style="margin-bottom: 4px;">
                    <span class="led led-red"></span>
                </div>
                <div style="font-size: 1.5rem; text-align: center;">üìπ</div>
            `;
            break;

        case 'phone':
            visual = `
                <div class="led-row" style="margin-bottom: 4px;">
                    <span class="led led-green"></span>
                </div>
                <div style="font-size: 1.5rem; text-align: center;">üìû</div>
            `;
            break;

        default:
            visual = `
                <div class="led-row">
                    <span class="led led-green"></span>
                </div>
            `;
    }

    return visual;
}

// Initialize board drag-and-drop
function initializeBoardDragDrop() {
    const boardCanvas = document.getElementById('board-canvas');

    // Make existing devices draggable (event attached in createBoardDevice)
    boardCanvas.querySelectorAll('.board-device').forEach(deviceEl => {
        deviceEl.style.cursor = 'move';
        deviceEl.addEventListener('mousedown', handleBoardDeviceDragStart);
    });

    // Handle asset drops from sidebar (use once: false for persistent listeners)
    boardCanvas.addEventListener('dragover', handleBoardDragOver);
    boardCanvas.addEventListener('drop', handleBoardAssetDrop);

    // Make assets in sidebar draggable
    document.querySelectorAll('.asset-item').forEach(asset => {
        if (!asset.hasAttribute('draggable')) {
            asset.setAttribute('draggable', 'true');
            asset.addEventListener('dragstart', handleAssetDragStart);
        }
    });
}

// Handle drag start for assets from sidebar
function handleAssetDragStart(e) {
    if (currentView !== 'board') return;

    draggedAsset = {
        id: parseInt(e.target.dataset.assetId),
        units: parseInt(e.target.dataset.units)
    };
    e.dataTransfer.effectAllowed = 'copy';
}

// Handle drag over board canvas
function handleBoardDragOver(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'copy';
}

// Handle asset drop on board
function handleBoardAssetDrop(e) {
    e.preventDefault();

    if (!draggedAsset) return;

    const rect = e.target.getBoundingClientRect();
    let x = e.clientX - rect.left;
    let y = e.clientY - rect.top;

    // Apply snap to grid if enabled
    if (snapToGrid) {
        x = Math.round(x / GRID_SIZE) * GRID_SIZE;
        y = Math.round(y / GRID_SIZE) * GRID_SIZE;
    }

    // Create device on board
    createDeviceOnBoard(draggedAsset.id, x, y, 150, 100);
    draggedAsset = null;
}

// Create device from asset on board
function createDeviceOnBoard(assetId, x, y, width, height) {
    showToast('Adding asset to board...', 'info');

    fetch(`/monitoring/api/racks/${RACK_ID}/devices/create/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            asset_id: assetId,
            start_unit: 1, // Default for board view
            units: 1,
            board_position_x: x,
            board_position_y: y,
            board_width: width,
            board_height: height
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error || !data.success) {
            showToast(data.error || 'Failed to add asset', 'danger');
        } else {
            rackDevices.push(data.device);
            showToast('Asset added to board', 'success');
            renderBoard();
            setTimeout(() => location.reload(), 1500);
        }
    })
    .catch(error => {
        console.error('Failed to create device:', error);
        showToast('Failed to add asset', 'danger');
    });
}

// Handle board device drag start
function handleBoardDeviceDragStart(e) {
    // Ignore if clicking resize handle
    if (e.target.classList.contains('board-resize-handle')) {
        handleBoardDeviceResizeStart(e);
        return;
    }

    const deviceEl = e.target.closest('.board-device');
    if (!deviceEl) return;

    e.preventDefault();
    deviceEl.classList.add('dragging');

    const rect = deviceEl.getBoundingClientRect();
    const canvas = document.getElementById('board-canvas');
    const canvasRect = canvas.getBoundingClientRect();

    boardDragState = {
        element: deviceEl,
        itemId: parseInt(deviceEl.dataset.itemId),
        itemType: deviceEl.dataset.itemType,
        offsetX: e.clientX - rect.left,
        offsetY: e.clientY - rect.top,
        canvasRect: canvasRect
    };

    document.addEventListener('mousemove', handleBoardDeviceDragMove);
    document.addEventListener('mouseup', handleBoardDeviceDragEnd);
}

// Handle board device drag move
function handleBoardDeviceDragMove(e) {
    if (!boardDragState) return;

    let x = e.clientX - boardDragState.canvasRect.left - boardDragState.offsetX;
    let y = e.clientY - boardDragState.canvasRect.top - boardDragState.offsetY;

    // Apply snap to grid if enabled
    if (snapToGrid) {
        x = Math.round(x / GRID_SIZE) * GRID_SIZE;
        y = Math.round(y / GRID_SIZE) * GRID_SIZE;
    }

    // Constrain to canvas bounds
    x = Math.max(0, Math.min(x, boardDragState.canvasRect.width - boardDragState.element.offsetWidth));
    y = Math.max(0, Math.min(y, boardDragState.canvasRect.height - boardDragState.element.offsetHeight));

    boardDragState.element.style.left = x + 'px';
    boardDragState.element.style.top = y + 'px';
}

// Handle board device drag end
function handleBoardDeviceDragEnd(e) {
    if (!boardDragState) return;

    document.removeEventListener('mousemove', handleBoardDeviceDragMove);
    document.removeEventListener('mouseup', handleBoardDeviceDragEnd);

    boardDragState.element.classList.remove('dragging');

    const x = parseInt(boardDragState.element.style.left);
    const y = parseInt(boardDragState.element.style.top);
    const width = parseInt(boardDragState.element.style.width);
    const height = parseInt(boardDragState.element.style.height);

    // Update position via API
    updateBoardPosition(boardDragState.itemId, boardDragState.itemType, x, y, width, height);

    boardDragState = null;
}

// Handle board device resize start
function handleBoardDeviceResizeStart(e) {
    e.preventDefault();
    e.stopPropagation();

    const deviceEl = e.target.closest('.board-device');
    if (!deviceEl) return;

    const startX = e.clientX;
    const startY = e.clientY;
    const startWidth = deviceEl.offsetWidth;
    const startHeight = deviceEl.offsetHeight;
    const itemId = parseInt(deviceEl.dataset.itemId);
    const itemType = deviceEl.dataset.itemType;

    function onMouseMove(e) {
        let newWidth = startWidth + (e.clientX - startX);
        let newHeight = startHeight + (e.clientY - startY);

        // Apply snap to grid if enabled
        if (snapToGrid) {
            newWidth = Math.round(newWidth / GRID_SIZE) * GRID_SIZE;
            newHeight = Math.round(newHeight / GRID_SIZE) * GRID_SIZE;
        }

        // Minimum size
        newWidth = Math.max(50, newWidth);
        newHeight = Math.max(50, newHeight);

        deviceEl.style.width = newWidth + 'px';
        deviceEl.style.height = newHeight + 'px';
    }

    function onMouseUp(e) {
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);

        const x = parseInt(deviceEl.style.left);
        const y = parseInt(deviceEl.style.top);
        const width = parseInt(deviceEl.style.width);
        const height = parseInt(deviceEl.style.height);

        // Update via API
        updateBoardPosition(itemId, itemType, x, y, width, height);
    }

    document.addEventListener('mousemove', onMouseMove);
    document.addEventListener('mouseup', onMouseUp);
}

// Update board position via API
function updateBoardPosition(itemId, itemType, x, y, width, height) {
    const endpoint = itemType === 'device'
        ? `/monitoring/api/rack-devices/${itemId}/update-board-position/`
        : `/monitoring/api/rack-resources/${itemId}/update-board-position/`;

    fetch(endpoint, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            x: x,
            y: y,
            width: width,
            height: height
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error || !data.success) {
            showToast(data.error || 'Failed to update position', 'danger');
            loadRackDevices(); // Reload to reset
        } else {
            showToast('Position updated', 'success');

            // Update local state
            if (itemType === 'device') {
                const device = rackDevices.find(d => d.id === itemId);
                if (device) {
                    device.board_position_x = x;
                    device.board_position_y = y;
                    device.board_width = width;
                    device.board_height = height;
                }
            } else {
                const resource = rackResources.find(r => r.id === itemId);
                if (resource) {
                    resource.board_position_x = x;
                    resource.board_position_y = y;
                    resource.board_width = width;
                    resource.board_height = height;
                }
            }
        }
    })
    .catch(error => {
        console.error('Failed to update position:', error);
        showToast('Failed to update position', 'danger');
    });
}

// ============================================================================
// TOOLBAR FUNCTIONS
// ============================================================================

// Toolbar functions
function initializeToolbar() {
    document.getElementById('toggle-rack-view').addEventListener('click', switchToRackView);
    document.getElementById('toggle-board-view').addEventListener('click', switchToBoardView);
    document.getElementById('toggle-grid').addEventListener('click', toggleSnapToGrid);
    document.getElementById('zoom-in').addEventListener('click', () => setZoom(ZOOM_LEVEL + 0.1));
    document.getElementById('zoom-out').addEventListener('click', () => setZoom(ZOOM_LEVEL - 0.1));
    document.getElementById('reset-view').addEventListener('click', resetView);
}

// Switch to rack view
function switchToRackView() {
    currentView = 'rack';
    document.getElementById('rack-container').style.display = 'block';
    document.getElementById('board-container').style.display = 'none';
    document.getElementById('toggle-grid').style.display = 'none';

    document.getElementById('toggle-rack-view').classList.add('active');
    document.getElementById('toggle-board-view').classList.remove('active');

    // Remove draggable from assets
    document.querySelectorAll('.asset-item').forEach(asset => {
        asset.removeAttribute('draggable');
    });

    renderRack();
}

// Switch to board view
function switchToBoardView() {
    currentView = 'board';
    document.getElementById('rack-container').style.display = 'none';
    document.getElementById('board-container').style.display = 'block';
    document.getElementById('toggle-grid').style.display = 'inline-block';

    document.getElementById('toggle-rack-view').classList.remove('active');
    document.getElementById('toggle-board-view').classList.add('active');

    // Destroy rack sortables
    const rackVisual = document.getElementById('rack-visual');
    const rackSortable = Sortable.get(rackVisual);
    if (rackSortable) {
        rackSortable.destroy();
    }

    const assetsSidebar = document.getElementById('available-assets');
    const sidebarSortable = Sortable.get(assetsSidebar);
    if (sidebarSortable) {
        sidebarSortable.destroy();
    }

    // Enable draggable on assets for board view
    document.querySelectorAll('.asset-item').forEach(asset => {
        asset.setAttribute('draggable', 'true');
    });

    renderBoard();
}

// Toggle snap to grid
function toggleSnapToGrid() {
    snapToGrid = !snapToGrid;
    const btn = document.getElementById('toggle-grid');
    const overlay = document.getElementById('board-grid-overlay');

    if (snapToGrid) {
        btn.classList.add('active');
        overlay.classList.add('active');
        showToast('Snap to grid enabled', 'info');
    } else {
        btn.classList.remove('active');
        overlay.classList.remove('active');
        showToast('Snap to grid disabled', 'info');
    }
}

function setZoom(level) {
    ZOOM_LEVEL = Math.max(0.5, Math.min(2.0, level));

    if (currentView === 'rack') {
        const container = document.getElementById('rack-container');
        container.style.transform = `scale(${ZOOM_LEVEL})`;
    } else {
        const container = document.getElementById('board-container');
        container.style.transform = `scale(${ZOOM_LEVEL})`;
    }
}

function resetView() {
    ZOOM_LEVEL = 1.0;
    snapToGrid = false;

    const rackContainer = document.getElementById('rack-container');
    const boardContainer = document.getElementById('board-container');
    const gridOverlay = document.getElementById('board-grid-overlay');
    const toggleGridBtn = document.getElementById('toggle-grid');

    rackContainer.style.transform = 'scale(1.0)';
    boardContainer.style.transform = 'scale(1.0)';
    gridOverlay.classList.remove('active');
    toggleGridBtn.classList.remove('active');

    showToast('View reset', 'info');
}

// Resize handle functionality
document.addEventListener('mousedown', function(e) {
    if (e.target.classList.contains('device-resize-handle')) {
        startResize(e);
    }
});

function startResize(e) {
    e.preventDefault();
    const handle = e.target;
    const deviceDiv = handle.closest('.rack-device');
    const deviceId = parseInt(deviceDiv.dataset.deviceId);
    const startY = e.clientY;
    const originalUnits = parseInt(deviceDiv.dataset.units);

    function onMouseMove(e) {
        const deltaY = e.clientY - startY;
        const newUnits = Math.max(1, originalUnits + Math.round(deltaY / 22));  // 22px per unit
        // Visual feedback only - don't commit until mouseup
        deviceDiv.style.height = `${newUnits * 22}px`;
    }

    function onMouseUp(e) {
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);

        const deltaY = e.clientY - startY;
        const newUnits = Math.max(1, originalUnits + Math.round(deltaY / 22));

        if (newUnits !== originalUnits) {
            updateDeviceSize(deviceId, newUnits);
        } else {
            renderRack();  // Revert visual
        }
    }

    document.addEventListener('mousemove', onMouseMove);
    document.addEventListener('mouseup', onMouseUp);
}

function updateDeviceSize(deviceId, newUnits) {
    const device = rackDevices.find(d => d.id === deviceId);
    showToast(`Resizing ${device.name} to ${newUnits}U...`, 'info');

    fetch(`/monitoring/api/rack-devices/${deviceId}/update-position/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            start_unit: device.start_unit,
            units: newUnits
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error || !data.success) {
            showToast(data.error || 'Failed to resize', 'danger');
            renderRack();
        } else {
            const deviceIndex = rackDevices.findIndex(d => d.id === deviceId);
            rackDevices[deviceIndex].units = newUnits;
            showToast(`${device.name} resized to ${newUnits}U`, 'success');
            renderRack();
        }
    })
    .catch(error => {
        console.error('Failed to resize device:', error);
        showToast('Failed to resize device', 'danger');
        renderRack();
    });
}

// Utility functions
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function showToast(message, type = 'info') {
    // Bootstrap toast notification
    const toastHTML = `
        <div class="toast align-items-center text-white bg-${type} border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;

    const toastContainer = document.getElementById('toast-container') || createToastContainer();
    toastContainer.insertAdjacentHTML('beforeend', toastHTML);
    const toastEl = toastContainer.lastElementChild;
    const toast = new bootstrap.Toast(toastEl, {autohide: true, delay: 3000});
    toast.show();

    toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
}

function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toast-container';
    container.classList.add('toast-container', 'position-fixed', 'top-0', 'end-0', 'p-3');
    container.style.zIndex = 9999;
    document.body.appendChild(container);
    return container;
}
</script>

<script>
function uploadImage() {
    const form = document.getElementById('imageUploadForm');
    const formData = new FormData(form);
    const uploadButton = event.target;

    uploadButton.disabled = true;
    uploadButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';

    fetch('{% url "files:upload_attachment" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => {
        if (response.ok) {
            location.reload();
        } else {
            return response.json().then(data => {
                throw new Error(data.error || 'Upload failed');
            });
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
        uploadButton.disabled = false;
        uploadButton.innerHTML = '<i class="fas fa-upload"></i> Upload';
    });
}

function viewImage(url, filename) {
    document.getElementById('imageViewerTitle').textContent = filename;
    document.getElementById('imageViewerImg').src = url;
    const modal = new bootstrap.Modal(document.getElementById('imageViewerModal'));
    modal.show();
}

function deleteImage(imageId, button) {
    if (!confirm('Are you sure you want to delete this image?')) {
        return;
    }

    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

    fetch(`/files/attachments/${imageId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => {
        if (response.ok) {
            location.reload();
        } else {
            return response.json().then(data => {
                throw new Error(data.error || 'Delete failed');
            });
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-trash"></i>';
    });
}
</script>
{% endblock %}

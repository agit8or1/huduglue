{% extends "base.html" %}

{% block title %}{{ action }} Password - HuduGlue{% endblock %}

{% block extra_css %}
<style>
    .password-type-section {
        display: none;
    }
    .password-type-section.active {
        display: block;
    }
    .type-info {
        background-color: #f8f9fa;
        border-left: 4px solid #0d6efd;
        padding: 0.75rem;
        margin-bottom: 1rem;
        font-size: 0.9rem;
    }
</style>
{% endblock %}

{% block content %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
        <li class="breadcrumb-item"><a href="{% url 'vault:password_list' %}">Passwords</a></li>
        {% if password %}
        <li class="breadcrumb-item"><a href="{% url 'vault:password_detail' password.pk %}">{{ password.title }}</a></li>
        <li class="breadcrumb-item active">Edit</li>
        {% else %}
        <li class="breadcrumb-item active">Create</li>
        {% endif %}
    </ol>
</nav>

<div class="row">
    <div class="col-md-10 offset-md-1">
        <div class="card">
            <div class="card-header">
                <h3 class="mb-0"><i class="fas fa-key"></i> {{ action }} Password</h3>
            </div>
            <div class="card-body">
                <form method="post" id="password-form">
                    {% csrf_token %}

                    {% if form.non_field_errors %}
                    <div class="alert alert-danger" role="alert">
                        {{ form.non_field_errors }}
                    </div>
                    {% endif %}

                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="{{ form.title.id_for_label }}" class="form-label">Title *</label>
                            {{ form.title }}
                            {% if form.title.errors %}<div class="invalid-feedback d-block">{{ form.title.errors }}</div>{% endif %}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.password_type.id_for_label }}" class="form-label">Type *</label>
                            {{ form.password_type }}
                            {% if form.password_type.errors %}<div class="invalid-feedback d-block">{{ form.password_type.errors }}</div>{% endif %}
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.username.id_for_label }}" class="form-label">Username</label>
                            {{ form.username }}
                            {% if form.username.errors %}<div class="invalid-feedback d-block">{{ form.username.errors }}</div>{% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.url.id_for_label }}" class="form-label">URL</label>
                            {{ form.url }}
                            {% if form.url.errors %}<div class="invalid-feedback d-block">{{ form.url.errors }}</div>{% endif %}
                        </div>
                    </div>

                    <!-- Website Login -->
                    <div id="section-website" class="password-type-section">
                        <div class="mb-3">
                            <label for="{{ form.plaintext_password.id_for_label }}" class="form-label">Password{% if not password %} *{% endif %}</label>
                            <div class="input-group">
                                {{ form.plaintext_password }}
                                <button type="button" class="btn btn-outline-secondary" onclick="togglePasswordVisibility('{{ form.plaintext_password.id_for_label }}')">
                                    <i class="fas fa-eye" id="eye-icon"></i>
                                </button>
                                <button type="button" class="btn btn-outline-primary" onclick="openPasswordGenerator()">
                                    <i class="fas fa-key"></i>
                                </button>
                            </div>
                            {% if form.plaintext_password.errors %}<div class="invalid-feedback d-block">{{ form.plaintext_password.errors }}</div>{% endif %}
                            <div id="password-strength" class="mt-1" style="display:none;">
                                <div class="progress" style="height: 6px;">
                                    <div id="strength-bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                                </div>
                                <small id="strength-text" class="text-muted"></small>
                            </div>
                            <div id="hibp-status" class="mt-1" style="display:none;"></div>
                        </div>
                    </div>

                    <!-- Email Account -->
                    <div id="section-email" class="password-type-section">
                        <div class="mb-3">
                            <label class="form-label">Password{% if not password %} *{% endif %}</label>
                            <div class="input-group">
                                {{ form.plaintext_password }}
                                <button type="button" class="btn btn-outline-secondary" onclick="togglePasswordVisibility('{{ form.plaintext_password.id_for_label }}')"><i class="fas fa-eye" id="eye-icon2"></i></button>
                                <button type="button" class="btn btn-outline-primary" onclick="openPasswordGenerator()"><i class="fas fa-key"></i></button>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label for="{{ form.email_server.id_for_label }}" class="form-label">Email Server</label>
                                {{ form.email_server }}
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.email_port.id_for_label }}" class="form-label">Port</label>
                                {{ form.email_port }}
                            </div>
                        </div>
                    </div>

                    <!-- Windows/Active Directory -->
                    <div id="section-windows_ad" class="password-type-section">
                        <div class="mb-3">
                            <label class="form-label">Password{% if not password %} *{% endif %}</label>
                            <div class="input-group">
                                {{ form.plaintext_password }}
                                <button type="button" class="btn btn-outline-secondary" onclick="togglePasswordVisibility('{{ form.plaintext_password.id_for_label }}')"><i class="fas fa-eye" id="eye-icon3"></i></button>
                                <button type="button" class="btn btn-outline-primary" onclick="openPasswordGenerator()"><i class="fas fa-key"></i></button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="{{ form.domain.id_for_label }}" class="form-label">Domain</label>
                            {{ form.domain }}
                        </div>
                    </div>

                    <!-- Database -->
                    <div id="section-database" class="password-type-section">
                        <div class="mb-3">
                            <label class="form-label">Password{% if not password %} *{% endif %}</label>
                            <div class="input-group">
                                {{ form.plaintext_password }}
                                <button type="button" class="btn btn-outline-secondary" onclick="togglePasswordVisibility('{{ form.plaintext_password.id_for_label }}')"><i class="fas fa-eye" id="eye-icon4"></i></button>
                                <button type="button" class="btn btn-outline-primary" onclick="openPasswordGenerator()"><i class="fas fa-key"></i></button>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.database_type.id_for_label }}" class="form-label">Type</label>
                                {{ form.database_type }}
                            </div>
                            <div class="col-md-5 mb-3">
                                <label for="{{ form.database_host.id_for_label }}" class="form-label">Host</label>
                                {{ form.database_host }}
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="{{ form.database_port.id_for_label }}" class="form-label">Port</label>
                                {{ form.database_port }}
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="{{ form.database_name.id_for_label }}" class="form-label">Database Name</label>
                            {{ form.database_name }}
                        </div>
                    </div>

                    <!-- SSH Key -->
                    <div id="section-ssh_key" class="password-type-section">
                        <div class="mb-3">
                            <label class="form-label">SSH Private Key or Passphrase{% if not password %} *{% endif %}</label>
                            {{ form.plaintext_password }}
                        </div>
                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label for="{{ form.ssh_host.id_for_label }}" class="form-label">SSH Host</label>
                                {{ form.ssh_host }}
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.ssh_port.id_for_label }}" class="form-label">Port</label>
                                {{ form.ssh_port }}
                            </div>
                        </div>
                    </div>

                    <!-- API Key / VPN / Network / Server / FTP / WiFi / Other -->
                    <div id="section-api_key" class="password-type-section">
                        <div class="mb-3">
                            <label class="form-label">API Key / Token{% if not password %} *{% endif %}</label>
                            {{ form.plaintext_password }}
                        </div>
                    </div>

                    <div id="section-vpn" class="password-type-section">
                        <div class="mb-3">
                            <label class="form-label">Password{% if not password %} *{% endif %}</label>
                            <div class="input-group">
                                {{ form.plaintext_password }}
                                <button type="button" class="btn btn-outline-secondary" onclick="togglePasswordVisibility('{{ form.plaintext_password.id_for_label }}')"><i class="fas fa-eye" id="eye-icon5"></i></button>
                            </div>
                        </div>
                    </div>

                    <div id="section-network_device" class="password-type-section">
                        <div class="mb-3">
                            <label class="form-label">Password{% if not password %} *{% endif %}</label>
                            <div class="input-group">
                                {{ form.plaintext_password }}
                                <button type="button" class="btn btn-outline-secondary" onclick="togglePasswordVisibility('{{ form.plaintext_password.id_for_label }}')"><i class="fas fa-eye" id="eye-icon6"></i></button>
                            </div>
                        </div>
                    </div>

                    <div id="section-server" class="password-type-section">
                        <div class="mb-3">
                            <label class="form-label">Password{% if not password %} *{% endif %}</label>
                            <div class="input-group">
                                {{ form.plaintext_password }}
                                <button type="button" class="btn btn-outline-secondary" onclick="togglePasswordVisibility('{{ form.plaintext_password.id_for_label }}')"><i class="fas fa-eye" id="eye-icon7"></i></button>
                                <button type="button" class="btn btn-outline-primary" onclick="openPasswordGenerator()"><i class="fas fa-key"></i></button>
                            </div>
                        </div>
                    </div>

                    <div id="section-ftp" class="password-type-section">
                        <div class="mb-3">
                            <label class="form-label">Password{% if not password %} *{% endif %}</label>
                            <div class="input-group">
                                {{ form.plaintext_password }}
                                <button type="button" class="btn btn-outline-secondary" onclick="togglePasswordVisibility('{{ form.plaintext_password.id_for_label }}')"><i class="fas fa-eye" id="eye-icon8"></i></button>
                            </div>
                        </div>
                    </div>

                    <div id="section-wifi" class="password-type-section">
                        <div class="mb-3">
                            <label class="form-label">WiFi Password{% if not password %} *{% endif %}</label>
                            <div class="input-group">
                                {{ form.plaintext_password }}
                                <button type="button" class="btn btn-outline-secondary" onclick="togglePasswordVisibility('{{ form.plaintext_password.id_for_label }}')"><i class="fas fa-eye" id="eye-icon9"></i></button>
                            </div>
                        </div>
                    </div>

                    <div id="section-credit_card" class="password-type-section">
                        <div class="mb-3">
                            <label class="form-label">Card Number / CVV{% if not password %} *{% endif %}</label>
                            {{ form.plaintext_password }}
                        </div>
                    </div>

                    <div id="section-software_license" class="password-type-section">
                        <div class="mb-3">
                            <label for="{{ form.license_key.id_for_label }}" class="form-label">License Key{% if not password %} *{% endif %}</label>
                            {{ form.license_key }}
                        </div>
                    </div>

                    <div id="section-other" class="password-type-section">
                        <div class="mb-3">
                            <label class="form-label">Password / Secret{% if not password %} *{% endif %}</label>
                            {{ form.plaintext_password }}
                        </div>
                    </div>

                    <!-- OTP/TOTP Section -->
                    <div id="section-otp" class="password-type-section">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.otp_issuer.id_for_label }}" class="form-label">Issuer</label>
                                {{ form.otp_issuer }}
                            </div>
                            <div class="col-md-6 mb-3" id="otp-secret-field">
                                <label for="{{ form.plaintext_otp_secret.id_for_label }}" class="form-label">TOTP Secret</label>
                                {{ form.plaintext_otp_secret }}
                            </div>
                        </div>
                        <div class="form-check mb-3">
                            {{ form.generate_new_secret }}
                            <label class="form-check-label" for="{{ form.generate_new_secret.id_for_label }}">Auto-generate new TOTP secret</label>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="{{ form.notes.id_for_label }}" class="form-label">Notes</label>
                            {{ form.notes }}
                            {% if form.notes.errors %}<div class="invalid-feedback d-block">{{ form.notes.errors }}</div>{% endif %}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.expires_at.id_for_label }}" class="form-label">Expires</label>
                            {{ form.expires_at }}
                            {% if form.expires_at.errors %}<div class="invalid-feedback d-block">{{ form.expires_at.errors }}</div>{% endif %}
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Tags</label>
                        <div class="row">
                            {% for tag in form.tags %}
                            <div class="col-md-3">{{ tag }}</div>
                            {% endfor %}
                        </div>
                        {% if form.tags.errors %}<div class="invalid-feedback d-block">{{ form.tags.errors }}</div>{% endif %}
                    </div>

                    <div class="d-flex justify-content-end gap-2">
                        <a href="{% if password %}{% url 'vault:password_detail' password.pk %}{% else %}{% url 'vault:password_list' %}{% endif %}" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> {{ action }} Password
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Password Generator Modal -->
<div class="modal fade" id="passwordGeneratorModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-key"></i> Password Generator</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Password Length: <span id="length-value">16</span></label>
                    <input type="range" class="form-range" id="password-length" min="8" max="64" value="16">
                </div>
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="include-uppercase" checked>
                        <label class="form-check-label" for="include-uppercase">Uppercase Letters (A-Z)</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="include-lowercase" checked>
                        <label class="form-check-label" for="include-lowercase">Lowercase Letters (a-z)</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="include-numbers" checked>
                        <label class="form-check-label" for="include-numbers">Numbers (0-9)</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="include-symbols" checked>
                        <label class="form-check-label" for="include-symbols">Symbols (!@#$%^&*)</label>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Generated Password</label>
                    <div class="input-group">
                        <input type="text" class="form-control font-monospace" id="generated-password" readonly>
                        <button type="button" class="btn btn-outline-secondary" onclick="copyToClipboard('generated-password')">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
                <div id="gen-password-strength" class="mb-3" style="display:none;">
                    <label class="form-label">Strength</label>
                    <div class="progress" style="height: 12px;">
                        <div id="gen-strength-bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                    <small id="gen-strength-text" class="text-muted"></small>
                </div>
                <button type="button" class="btn btn-secondary w-100" onclick="generatePassword()">
                    <i class="fas fa-sync"></i> Regenerate
                </button>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="useGeneratedPassword()">Use This Password</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const passwordTypeSelect = document.getElementById('id_password_type');
    const generateSecretCheckbox = document.getElementById('id_generate_new_secret');
    const otpSecretField = document.getElementById('otp-secret-field');

    // Map password types to their section IDs
    const typeMappings = {
        'website': ['section-website'],
        'email': ['section-email'],
        'windows_ad': ['section-windows_ad'],
        'database': ['section-database'],
        'ssh_key': ['section-ssh_key'],
        'api_key': ['section-api_key'],
        'otp': ['section-otp'],
        'credit_card': ['section-credit_card'],
        'network_device': ['section-network_device'],
        'server': ['section-server'],
        'ftp': ['section-ftp'],
        'vpn': ['section-vpn'],
        'wifi': ['section-wifi'],
        'software_license': ['section-software_license'],
        'other': ['section-other']
    };

    function updateVisibleSections() {
        const selectedType = passwordTypeSelect.value;
        const sections = typeMappings[selectedType] || [];

        // Hide all sections
        document.querySelectorAll('.password-type-section').forEach(section => {
            section.classList.remove('active');
        });

        // Show sections for selected type
        sections.forEach(sectionId => {
            const section = document.getElementById(sectionId);
            if (section) section.classList.add('active');
        });

        // Handle OTP secret field visibility
        if (selectedType === 'otp' && generateSecretCheckbox) {
            toggleOtpSecretField();
        }
    }

    function toggleOtpSecretField() {
        if (generateSecretCheckbox.checked) {
            otpSecretField.style.display = 'none';
        } else {
            otpSecretField.style.display = 'block';
        }
    }

    // Initialize on page load
    updateVisibleSections();

    // Update when password type changes
    passwordTypeSelect.addEventListener('change', updateVisibleSections);

    // Update when generate secret checkbox changes
    if (generateSecretCheckbox) {
        generateSecretCheckbox.addEventListener('change', toggleOtpSecretField);
    }

    // Password Generator Functions
    function openPasswordGenerator() {
        const modal = new bootstrap.Modal(document.getElementById('passwordGeneratorModal'));
        modal.show();
        generatePassword(); // Generate initial password
    }

    function generatePassword() {
        const length = document.getElementById('password-length').value;
        const includeUppercase = document.getElementById('include-uppercase').checked;
        const includeLowercase = document.getElementById('include-lowercase').checked;
        const includeNumbers = document.getElementById('include-numbers').checked;
        const includeSymbols = document.getElementById('include-symbols').checked;

        let charset = '';
        if (includeUppercase) charset += 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        if (includeLowercase) charset += 'abcdefghijklmnopqrstuvwxyz';
        if (includeNumbers) charset += '0123456789';
        if (includeSymbols) charset += '!@#$%^&*()_+-=[]{}|;:,.<>?';

        if (!charset) {
            alert('Please select at least one character type');
            return;
        }

        let password = '';
        const values = new Uint32Array(length);
        crypto.getRandomValues(values);
        for (let i = 0; i < length; i++) {
            password += charset[values[i] % charset.length];
        }

        document.getElementById('generated-password').value = password;
        updateGeneratedPasswordStrength(password);
    }

    function useGeneratedPassword() {
        const generatedPassword = document.getElementById('generated-password').value;
        const passwordInput = document.getElementById('{{ form.plaintext_password.id_for_label }}');
        passwordInput.value = generatedPassword;
        updatePasswordStrength(generatedPassword);
        checkHIBP(generatedPassword);

        const modal = bootstrap.Modal.getInstance(document.getElementById('passwordGeneratorModal'));
        modal.hide();
    }

    function updateGeneratedPasswordStrength(password) {
        const strength = calculatePasswordStrength(password);
        const strengthBar = document.getElementById('gen-strength-bar');
        const strengthText = document.getElementById('gen-strength-text');
        const strengthContainer = document.getElementById('gen-password-strength');

        strengthContainer.style.display = 'block';
        strengthBar.style.width = strength.score + '%';
        strengthBar.className = 'progress-bar ' + strength.colorClass;
        strengthText.textContent = strength.label + ' - ' + strength.feedback;
    }

    // Password strength calculator
    function calculatePasswordStrength(password) {
        if (!password) return { score: 0, label: '', feedback: '', colorClass: '' };

        let score = 0;
        const feedback = [];

        // Length scoring
        if (password.length >= 8) score += 20;
        if (password.length >= 12) score += 15;
        if (password.length >= 16) score += 15;
        if (password.length >= 20) score += 10;

        // Character variety
        if (/[a-z]/.test(password)) {score += 10; feedback.push('lowercase');}
        if (/[A-Z]/.test(password)) { score += 10; feedback.push('uppercase');}
        if (/[0-9]/.test(password)) { score += 10; feedback.push('numbers');}
        if (/[^a-zA-Z0-9]/.test(password)) { score += 15; feedback.push('symbols');}

        // Complexity bonus
        const uniqueChars = new Set(password).size;
        if (uniqueChars / password.length > 0.7) score += 10;

        // Penalties
        if (/(.)\1{2,}/.test(password)) score -= 10; // Repeated characters
        if (/^[a-z]+$/.test(password)) score -= 10; // Only lowercase
        if (/^[A-Z]+$/.test(password)) score -= 10; // Only uppercase
        if (/^[0-9]+$/.test(password)) score -= 10; // Only numbers

        score = Math.max(0, Math.min(100, score));

        let label, colorClass;
        if (score < 40) { label = 'Weak'; colorClass = 'bg-danger'; }
        else if (score < 60) { label = 'Fair'; colorClass = 'bg-warning'; }
        else if (score < 80) { label = 'Good'; colorClass = 'bg-info'; }
        else { label = 'Strong'; colorClass = 'bg-success'; }

        return {
            score,
            label,
            feedback: 'Contains: ' + feedback.join(', '),
            colorClass
        };
    }

    function updatePasswordStrength(password) {
        const strength = calculatePasswordStrength(password);
        const strengthBar = document.getElementById('strength-bar');
        const strengthText = document.getElementById('strength-text');
        const strengthContainer = document.getElementById('password-strength');

        if (password) {
            strengthContainer.style.display = 'block';
            strengthBar.style.width = strength.score + '%';
            strengthBar.className = 'progress-bar ' + strength.colorClass;
            strengthText.textContent = strength.label + ' - ' + strength.feedback;
        } else {
            strengthContainer.style.display = 'none';
        }
    }

    // Have I Been Pwned check
    async function checkHIBP(password) {
        const statusDiv = document.getElementById('hibp-status');
        statusDiv.style.display = 'block';
        statusDiv.innerHTML = '<small class="text-muted"><i class="fas fa-spinner fa-spin"></i> Checking against breached passwords...</small>';

        if (!password) {
            statusDiv.style.display = 'none';
            return;
        }

        try {
            // Hash the password with SHA-1
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-1', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('').toUpperCase();

            // Send first 5 characters to HIBP API (k-Anonymity)
            const prefix = hashHex.substring(0, 5);
            const suffix = hashHex.substring(5);

            const response = await fetch(`https://api.pwnedpasswords.com/range/${prefix}`);
            const text = await response.text();

            // Check if our suffix appears in the results
            const lines = text.split('\n');
            let found = false;
            let count = 0;

            for (const line of lines) {
                const [hashSuffix, occurrences] = line.split(':');
                if (hashSuffix === suffix) {
                    found = true;
                    count = parseInt(occurrences);
                    break;
                }
            }

            if (found) {
                statusDiv.innerHTML = `<small class="text-danger"><i class="fas fa-exclamation-triangle"></i> <strong>Warning:</strong> This password has been found in ${count.toLocaleString()} data breaches! Choose a different password.</small>`;
            } else {
                statusDiv.innerHTML = '<small class="text-success"><i class="fas fa-check-circle"></i> This password has not been found in known data breaches.</small>';
            }
        } catch (error) {
            statusDiv.innerHTML = '<small class="text-muted"><i class="fas fa-exclamation-circle"></i> Could not check against breached passwords.</small>';
        }
    }

    // Toggle password visibility
    function togglePasswordVisibility(fieldId) {
        const field = document.getElementById(fieldId);
        const icon = document.getElementById('eye-icon');

        if (field.type === 'password') {
            field.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {
            field.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    }

    function copyToClipboard(elementId) {
        const element = document.getElementById(elementId);
        element.select();
        document.execCommand('copy');

        // Show feedback
        const button = event.target.closest('button');
        const originalHTML = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check"></i>';
        setTimeout(() => {
            button.innerHTML = originalHTML;
        }, 1500);
    }

    // Update length value display
    document.getElementById('password-length').addEventListener('input', function() {
        document.getElementById('length-value').textContent = this.value;
    });

    // Monitor password field for strength check
    const passwordInput = document.getElementById('{{ form.plaintext_password.id_for_label }}');
    if (passwordInput) {
        passwordInput.addEventListener('input', function() {
            updatePasswordStrength(this.value);
        });

        passwordInput.addEventListener('blur', function() {
            if (this.value) {
                checkHIBP(this.value);
            }
        });

        // Check initial value if exists
        if (passwordInput.value) {
            updatePasswordStrength(passwordInput.value);
        }
    }
</script>
{% endblock %}
